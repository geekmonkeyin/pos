<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Geekmonkey ‚Äî Add New Inbound Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        :root{
          --bg:#F9FAFB; --card:#fff; --stroke:#E5E7EB; --text:#111827; --muted:#6B7280;
          --accent:#FF7A00; --accent-ink:#9A4D00; --radius:16px;
        }
        html,body{height:100%}
        body{background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}
        /* Header */
        .gm-header{
          position: sticky; top:0; z-index:1000; background:#fff;
          border-bottom:1px solid var(--stroke);
        }
        .gm-header .inner{
          display:flex; align-items:center; gap:.75rem; padding:.75rem 1rem; max-width:1100px; margin:0 auto;
        }
        .gm-brand{
          display:flex; align-items:center; gap:.55rem; font-weight:800; text-decoration:none; color:var(--text);
        }
        .gm-dot{width:10px; height:10px; border-radius:50%; background:var(--accent)}
        .gm-actions{margin-left:auto; display:flex; gap:.5rem}
        .gm-btn{
          display:inline-flex; align-items:center; gap:.4rem; border:1px solid var(--stroke);
          background:#fff; color:var(--text); padding:.45rem .7rem; border-radius:12px; text-decoration:none;
        }
        .gm-btn:hover{background:#F3F4F6}
        .gm-btn-primary{
          border-color:transparent; background:var(--accent); color:#fff;
        }
        .gm-btn-primary:hover{background:#ff8f29}
        /* Card */
        .gm-card{
          max-width: 900px; margin: 18px auto; background:var(--card); border:1px solid var(--stroke);
          border-radius:var(--radius); box-shadow:0 6px 16px rgba(17,24,39,.06);
        }
        .gm-card .head{
          padding:1rem 1.25rem; border-bottom:1px solid var(--stroke); display:flex; align-items:center; gap:.75rem;
        }
        .gm-card .head h2{margin:0; font-size:1.1rem}
        .gm-card .body{padding:1.25rem}
        .muted{color:var(--muted); font-size:.9rem}
        .list-group-item{cursor:pointer}
        .form-text-small{font-size:.8rem; color:var(--muted)}
        .required::after{content:" *"; color:#dc2626}
        /* Helper row spacing on small screens */
        .row-gap{row-gap:1rem}
    </style>
</head>
<body>
<!-- Header -->
<header class="gm-header">
    <div class="inner">
        <span class="gm-dot" aria-hidden="true"></span>
        <a class="gm-brand" href="/v1/home" aria-label="Geekmonkey Home">
            Geekmonkey
        </a>
        <div class="gm-actions">
            <button type="button" class="gm-btn" id="btnBack" title="Go Back">
                ‚Üê Back
            </button>
            <a class="gm-btn gm-btn-primary" href="/v1/home" title="Home">üè† Home</a>
        </div>
    </div>
</header>

<!-- Content Card -->
<main class="gm-card">
    <div class="head">
        <h2>Add New Inbound Details</h2>
        <span class="muted">Create or resume a draft inbound.</span>
    </div>
    <div class="body">
        <form id="inboundForm" novalidate>
            <!-- Vendor -->
            <div class="mb-3 position-relative">
                <label for="vendorName" class="form-label required">Vendor Name</label>
                <input type="text" class="form-control" id="vendorName" placeholder="Type at least 3 characters‚Ä¶" autocomplete="off" />
                <div class="form-text form-text-small">Start typing to search vendors. Click a result to select.</div>

                <!-- Spinner -->
                <div id="vendorSpinner" class="d-none text-center mt-2">
                    <div class="spinner-border" role="status" aria-label="Loading"></div>
                </div>

                <!-- Dropdown -->
                <ul class="list-group mt-2 d-none" id="vendorDropdown" role="listbox" aria-label="Vendor suggestions"></ul>
            </div>

            <!-- Inbound ID -->
            <div class="mb-3">
                <label for="inboundId" class="form-label">Inbound ID</label>
                <input type="text" class="form-control" id="inboundId" readonly placeholder="" />
                <div class="form-text form-text-small">Will stay blank if not available.</div>
            </div>

            <div class="row row-gap">
                <!-- Date -->
                <div class="col-md-6">
                    <label for="orderDate" class="form-label required">Date</label>
                    <input type="date" class="form-control" id="orderDate" required />
                </div>

                <!-- Number of Cartons -->
                <div class="col-md-6">
                    <label for="cartons" class="form-label required">Number of Cartons</label>
                    <input type="number" class="form-control" id="cartons" min="1" placeholder="e.g. 5" required />
                </div>
            </div>

            <div class="d-grid mt-4">
                <button type="button" class="btn gm-btn-primary" id="btnNext">Next</button>
            </div>
        </form>
    </div>
</main>

<script>
    // ===== Header Back handling (with safe fallback) =====
    document.getElementById('btnBack').addEventListener('click', function(){
      if (window.history.length > 1) { window.history.back(); }
      else { window.location.href = '/v1/home'; }
    });

    // ===== Utilities =====
    const $ = (id) => document.getElementById(id);
    let debounceTimer;

    function isNullishOrEmpty(v){
      return v === null || v === undefined || (typeof v === 'string' && v.trim() === '') || v === 'null' || v === 'undefined';
    }

    function setInboundId(val){
      const el = $('inboundId');
      el.value = isNullishOrEmpty(val) ? '' : String(val);
    }

    function todayISO(){
      return new Date().toISOString().split('T')[0];
    }

    function getQueryParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // ===== Defaults =====
    // Set date default (only if empty)
    const orderDateEl = $('orderDate');
    orderDateEl.value = orderDateEl.value || todayISO();

    // Respect inboundId from query params if present & valid, else keep blank
    setInboundId(getQueryParam('inboundId'));

    // ===== Vendor Search (debounced) =====
    $('vendorName').addEventListener('input', function(){
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(fetchVendorDetails, 400);
    });

    document.addEventListener('click', (e) => {
      // Hide dropdown if clicked outside
      if (!$('vendorDropdown').contains(e.target) && e.target !== $('vendorName')) {
        $('vendorDropdown').classList.add('d-none');
      }
    });

    function fetchVendorDetails(){
      const vendorName = $('vendorName').value.trim();
      if (vendorName.length < 3) {
        $('vendorDropdown').classList.add('d-none');
        return;
      }

      $('vendorSpinner').classList.remove('d-none');

      fetch('/v1/vendor/search/' + encodeURIComponent(vendorName))
        .then(r => r.ok ? r.json() : Promise.reject('Search failed'))
        .then(data => {
          const dd = $('vendorDropdown');
          dd.innerHTML = '';
          $('vendorSpinner').classList.add('d-none');

          if (Array.isArray(data) && data.length){
            data.forEach(vendor => {
              const a = document.createElement('a');
              a.className = 'list-group-item list-group-item-action';
              a.textContent = vendor.vendorName;
              a.setAttribute('role','option');
              a.addEventListener('click', () => selectVendor(vendor));
              dd.appendChild(a);
            });
            dd.classList.remove('d-none');
          } else {
            dd.classList.add('d-none');
          }
        })
        .catch(err => {
          console.error('Error fetching vendor details:', err);
          $('vendorSpinner').classList.add('d-none');
          $('vendorDropdown').classList.add('d-none');
        });
    }

    function selectVendor(vendor){
      $('vendorName').value = vendor.vendorName || '';
      $('vendorDropdown').classList.add('d-none');

      // Load draft inbound for this vendor
      fetch('/v1/inbound/getDraftInboundOrders/' + encodeURIComponent(vendor.vendorName || ''))
        .then(r => r.ok ? r.json() : Promise.reject('Draft fetch failed'))
        .then(data => {
          if (!data || data.error) return;

          if (data.receivedDate) $('orderDate').value = data.receivedDate;
          if (data.numberOfBoxes) $('cartons').value = data.numberOfBoxes;
          setInboundId(data.id); // keep blank if null/empty
        })
        .catch(err => console.error('Error fetching draft inbound orders:', err));
    }

    // ===== Save and Next =====
    $('btnNext').addEventListener('click', saveDraftAndNext);

    function saveDraftAndNext(){
      const vendorName = $('vendorName').value.trim();
      const receivedDate = $('orderDate').value;
      const numberOfBoxes = Number($('cartons').value);
      const id = $('inboundId').value.trim(); // may be blank

      if (!vendorName || !receivedDate || !numberOfBoxes){
        alert('Please fill all required fields.');
        return;
      }

      const payload = { vendorName, id: isNullishOrEmpty(id) ? '' : id, receivedDate, numberOfBoxes };

      fetch('/v1/inbound/initiateBoarding', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      })
      .then(resp => resp.ok ? resp.json() : Promise.reject('Failed to initiate boarding process'))
      .then(data => {
        const inboundId = data.inboundId;
        const currentStep = data.currentStep;
        const cartonNo = data.cartonNo;
        // Navigate
        const url = new URL('/v1/inbound/steps', window.location.origin);
        url.searchParams.set('inboundId', inboundId || '');
        if (currentStep !== undefined) url.searchParams.set('currentStep', currentStep);
        if (cartonNo !== undefined) url.searchParams.set('cartonNo', cartonNo);
        window.location.href = url.toString();
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Failed to initiate boarding process. Please try again.');
      });
    }
</script>
</body>
</html>
