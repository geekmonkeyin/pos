<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Geekmonkey — Attendance</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        :root{
          --bg:#F9FAFB; --card:#FFFFFF; --stroke:#E5E7EB; --text:#111827; --muted:#6B7280;
          --accent:#FF7A00; --accent-600:#e86f00; --accent-100:#FFF2E8;
          --ok:#10B981; --warn:#F59E0B; --err:#EF4444; --info:#60A5FA;
          --radius:14px; --shadow:0 10px 20px rgba(17,24,39,.06), 0 2px 6px rgba(17,24,39,.04);
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}

        .gm-header{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--stroke)}
        .gm-header-inner{max-width:1300px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px}
        .gm-brand{display:flex;align-items:center;gap:.6rem;text-decoration:none;color:var(--text)}
        .gm-logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#ffab66)}
        .gm-title{font-weight:800;letter-spacing:.2px}
        .gm-actions{margin-left:auto;display:flex;gap:8px}
        .gm-btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--stroke);background:var(--card);border-radius:10px;padding:8px 12px;color:var(--text);text-decoration:none;font-weight:600;box-shadow:0 1px 0 rgba(0,0,0,.02)}
        .gm-btn:hover{border-color:#d9dde3;background:#fcfcfd}
        .gm-btn--accent{background:var(--accent);border-color:var(--accent);color:#fff}
        .gm-btn--accent:hover{background:var(--accent-600)}

        .wrap{max-width:1300px;margin:18px auto;padding:0 16px}
        .grid{display:grid;grid-template-columns:1fr;gap:16px}

        .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow)}
        .card h3{margin:0 0 8px 0;font-size:16px}
        .card-body{padding:14px}
        .divider{height:1px;background:var(--stroke);margin:12px 0}

        .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .search{flex:1;min-width:280px;position:relative}
        .search input{width:100%;border:1px solid var(--stroke);border-radius:10px;padding:10px 12px 10px 34px}
        .search i{position:absolute;left:10px;top:10px;color:var(--muted)}

        .dropdown{position:absolute;left:0;right:0;top:100%;z-index:20;background:#fff;border:1px solid var(--stroke);border-radius:10px;margin-top:6px;box-shadow:var(--shadow);display:none;max-height:260px;overflow:auto}
        .dropdown ul{list-style:none;margin:0;padding:6px}
        .dropdown li{padding:8px 10px;border-radius:8px;display:flex;align-items:center;gap:8px;cursor:pointer}
        .dropdown li:hover{background:#F9FAFB}
        .dropdown .sub{color:var(--muted);font-size:12px}

        .selected-emp{font-weight:700;color:#111827;display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border:1px dashed var(--stroke);border-radius:10px;background:#fff}
        .selected-emp .tag{background:var(--accent-100);padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800;color:#7a3c00}

        .table{border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
        table{width:100%;border-collapse:separate;border-spacing:0}
        thead th{background:#F9FAFB;font-size:12px;text-transform:uppercase;letter-spacing:.04em}
        th,td{padding:10px 12px;border-bottom:1px solid var(--stroke)}
        .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:700}
        .tag.ok{background:#DCFCE7;color:#166534}
        .tag.warn{background:#FEF3C7;color:#92400E}
        .tag.err{background:#FEE2E2;color:#991B1B}
        .tag.info{background:#DBEAFE;color:#1E40AF}

        .modal-backdrop{position:fixed;inset:0;background:rgba(17,24,39,.5);display:none;align-items:center;justify-content:center;z-index:2000}
        .modal{width:min(920px,96vw);background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
        .modal-hd{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--stroke);background:#FAFAFA}
        .modal-bd{padding:16px}
        .modal-ft{display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--stroke);background:#FAFAFA}

        .camera{display:grid;grid-template-columns:1fr 320px;gap:16px}
        video,canvas{width:100%;border:1px solid var(--stroke);border-radius:12px}
        .preview-col{display:flex;flex-direction:column;gap:10px}
        .img-box{border:1px dashed var(--stroke);border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;min-height:180px;background:#fff}
        .img-box img{max-width:100%;height:auto;display:block}

        @media (max-width: 1024px){
          .camera{grid-template-columns:1fr}
        }
    </style>
</head>
<body>
<header class="gm-header">
    <div class="gm-header-inner">
        <a class="gm-brand" href="#" onclick="return goBack()" title="Back">
            <span class="gm-logo" aria-hidden="true"></span>
            <span class="gm-title">Geekmonkey · Attendance</span>
        </a>

        <!-- Selected employee shown in header -->
        <div id="headerSelectedEmp" class="selected-emp" style="display:none;margin-left:8px">
            <i class="fa-solid fa-user-circle"></i>
            <span id="headerEmpName"></span>
            <span class="tag" id="headerEmpId"></span>
        </div>

        <div class="gm-actions" style="margin-left:auto">
            <a class="gm-btn" href="#" onclick="return goBack()"><i class="fa-solid fa-arrow-left"></i><span>Back</span></a>
            <a class="gm-btn gm-btn--accent" href="/v1/home"><i class="fa-solid fa-house"></i><span>Home</span></a>
        </div>
    </div>
</header>

<main class="wrap">
    <!-- SINGLE toolbar with ONE employee search -->
    <section class="card card-body">
        <div class="toolbar">
            <div class="search" id="empSearchBox">
                <i class="fa-solid fa-id-card"></i>
                <input id="empSearchInput" placeholder="Search employee by ID (shows names)…" autocomplete="off"/>
                <div class="dropdown" id="empSearchDropdown"><ul id="empSearchResults"></ul></div>
            </div>

            <div id="pageSelectedEmp" class="selected-emp" style="display:none">
                <i class="fa-solid fa-user-circle"></i>
                <span id="pageEmpName"></span>
                <span class="tag" id="pageEmpId"></span>
            </div>

            <button class="gm-btn" type="button" id="btnAutoCheck">
                <i class="fa-solid fa-bolt"></i> Auto Check-In
            </button>

            <button class="gm-btn" type="button" id="btnAutoCheckout">
                <i class="fa-solid fa-person-walking-arrow-right"></i> Auto Check-Out
            </button>
        </div>

        <div class="divider"></div>

        <div class="table">
            <table>
                <thead>
                <tr><th style="width:36%">Name</th><th>Employee ID</th><th>Check-In (IST)</th><th>Check-Out (IST)</th><th>Status</th></tr>
                </thead>
                <tbody id="tblBody"></tbody>
            </table>
        </div>
    </section>
</main>

<!-- Auto Check-In / Check-Out Modal -->
<div class="modal-backdrop" id="autoModal">
    <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-hd">
            <div style="display:flex;align-items:center;gap:10px">
                <strong id="autoTitle"><i class="fa-solid fa-bolt"></i> Auto Check-In</strong>
                <div class="selected-emp" id="autoEmpBadge">
                    <i class="fa-solid fa-user-circle"></i>
                    <span id="autoEmpName">No employee selected</span>
                    <span class="tag" id="autoEmpId">—</span>
                </div>
            </div>
            <button class="gm-btn" id="closeAuto" type="button"><i class="fa-solid fa-xmark"></i> Close</button>
        </div>

        <div class="modal-bd">
            <div class="camera">
                <div>
                    <video id="cam" autoplay playsinline></video>
                </div>

                <div class="preview-col">
                    <!-- DB-stored last image -->
                    <div>
                        <label style="font-weight:700;display:block;margin-bottom:6px">Last saved image (from DB)</label>
                        <div class="img-box"><img id="dbPhoto" alt="No previous image"/></div>
                    </div>

                    <!-- New capture -->
                    <div>
                        <label style="font-weight:700;display:block;margin-bottom:6px">New capture</label>
                        <canvas id="snap" width="480" height="360" style="background:#fafafa"></canvas>
                    </div>

                    <div class="divider"></div>

                    <div class="field">
                        <label style="font-weight:700;display:block;margin-bottom:6px">Timestamp (IST)</label>
                        <input id="istNow" class="input" readonly style="width:100%;border:1px solid var(--stroke);border-radius:10px;padding:10px" />
                    </div>

                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="gm-btn" id="btnCapture" type="button"><i class="fa-solid fa-camera"></i> Capture</button>
                        <button class="gm-btn" id="btnRetake" type="button"><i class="fa-solid fa-rotate"></i> Retake</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-ft">
            <!-- Enabled ONLY after capture -->
            <button class="gm-btn gm-btn--accent" id="btnSave" type="button" disabled>
                <i class="fa-solid fa-circle-check"></i> Save
            </button>
        </div>
    </div>
</div>

<script>
    // ---------- Helpers ----------
    function goBack(){
      if (window.history.length > 1) { window.history.back(); }
      else { window.location.href = '/v1/home'; }
      return false;
    }
    const IST = 'Asia/Kolkata';
    function formatIST(d){
      return new Intl.DateTimeFormat('en-IN',{
        timeZone: IST, year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true
      }).format(d);
    }
    function todayAtIST(hours, minutes, seconds=0){
      const now = new Date();
      const ist = new Date(now.toLocaleString('en-US', { timeZone: IST }));
      ist.setHours(hours, minutes, seconds, 0);
      // Convert back to local Date maintaining the same wall time as IST
      const tzDiffMs = new Date().getTime() - new Date(new Date().toLocaleString('en-US', { timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone })).getTime();
      return new Date(ist.getTime() - tzDiffMs);
    }
    function byId(id){ return document.getElementById(id); }
    function setBtnEnabled(btn, enabled){ btn.disabled = !enabled; btn.style.opacity = enabled ? 1 : .6; btn.style.cursor = enabled ? 'pointer' : 'not-allowed'; }

    // ---------- State ----------
    let selectedEmployee = null;    // { id, name }
    let hasOpenSession = false;     // whether this employee has an open (no checkout) record
    let mode = 'checkin';           // 'checkin' | 'checkout'
    let stream=null, lastPhotoDataUrl=null, istTimer=null;

    const tblBody = byId('tblBody');

    // ---------- Search (ONE input) ----------
    async function searchEmployeesById(partialId){
      if(!partialId || !partialId.trim()) return [];
      try{
        const res = await fetch(`/v1/employees/search/${encodeURIComponent(partialId.trim())}`);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        // expected: [{ id:"EMP001", empName:"Jane Smith" }, ...]
        return data;
      }catch(e){
        console.error('Search failed:', e);
        return [];
      }
    }

    (function wireSingleSearch(){
      const box = byId('empSearchBox');
      const input = byId('empSearchInput');
      const dropdown = byId('empSearchDropdown');
      const list = byId('empSearchResults');

      let timer=null;
      function openDD(){ dropdown.style.display='block'; }
      function closeDD(){ dropdown.style.display='none'; list.innerHTML=''; }

      input.addEventListener('input', ()=>{
        clearTimeout(timer);
        const q = input.value;
        timer = setTimeout(async ()=>{
          const emp = await searchEmployeesById(q);
          list.innerHTML = '';
          if(!emp){ closeDD(); return; }

            const li = document.createElement('li');
            li.innerHTML = `<div><div>${emp.empName||'Unnamed'}</div><div class="sub">${emp.id||''}</div></div>`;
            li.addEventListener('click', ()=>{ pickEmployee({ id: emp.id, name: emp.empName }); closeDD(); });
            list.appendChild(li);

          openDD();
        }, 160);
      });

      document.addEventListener('click', (e)=>{ if(!box.contains(e.target)) closeDD(); });
      input.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDD(); });
    })();

    function reflectSelectionUI(){
      const show = !!selectedEmployee;
      // header badge
      byId('headerSelectedEmp').style.display = show ? 'inline-flex':'none';
      byId('headerEmpName').textContent = selectedEmployee?.name || '';
      byId('headerEmpId').textContent   = selectedEmployee?.id || '';
      // page badge
      byId('pageSelectedEmp').style.display = show ? 'inline-flex':'none';
      byId('pageEmpName').textContent = selectedEmployee?.name || '';
      byId('pageEmpId').textContent   = selectedEmployee?.id || '';
      // also swap search text to NAME (as requested)
      if (show) byId('empSearchInput').value = selectedEmployee.name;
    }

    async function checkOpenSession(employeeId){
      try{
        const r = await fetch(`/v1/attendance/open-session?employeeId=${encodeURIComponent(employeeId)}`);
        if(!r.ok) throw new Error('status '+r.status);
        const j = await r.json(); // { open: boolean }
        return !!j.open;
      }catch(e){
        console.warn('open-session check failed, assuming no open session:', e);
        return false;
      }
    }

    async function pickEmployee(emp){
      selectedEmployee = { id: String(emp.id), name: emp.name };
      reflectSelectionUI();
      hasOpenSession = await checkOpenSession(selectedEmployee.id);
    }

    // ---------- Table helpers ----------
    function addRowCheckin(emp, checkinIst, photoUrl){
      const tr = document.createElement('tr');
      tr.dataset.empId = emp.id;
      tr.dataset.sessionOpen = 'true';
      tr.innerHTML = `
        <td>${emp.name}</td>
        <td>${emp.id}</td>
        <td>${checkinIst}</td>
        <td class="checkout-cell">—</td>
        <td><span class="tag ok">Checked in</span></td>
      `;
      tblBody.prepend(tr);
    }
    function closeRowCheckout(empId, checkoutIst){
      const row = [...tblBody.querySelectorAll('tr')].find(r=>r.dataset.empId===empId && r.dataset.sessionOpen==='true');
      if(row){
        row.querySelector('.checkout-cell').textContent = checkoutIst;
        row.querySelector('.tag').className = 'tag info';
        row.querySelector('.tag').textContent = 'Checked out';
        row.dataset.sessionOpen = 'false';
      } else {
        // no open row found -> add a complete row
        const tr = document.createElement('tr');
        tr.dataset.empId = empId;
        tr.dataset.sessionOpen = 'false';
        tr.innerHTML = `
          <td>${selectedEmployee?.name || ''}</td>
          <td>${empId}</td>
          <td>—</td>
          <td>${checkoutIst}</td>
          <td><span class="tag info">Checked out</span></td>
        `;
        tblBody.prepend(tr);
      }
    }

    // ---------- Modal (shared for check-in & check-out) ----------
    const autoModal = byId('autoModal');
    const autoTitle = byId('autoTitle');
    const autoEmpName = byId('autoEmpName');
    const autoEmpId = byId('autoEmpId');
    const closeAuto = byId('closeAuto');
    const cam = byId('cam');
    const snap = byId('snap');
    const dbPhoto = byId('dbPhoto');
    const btnCapture = byId('btnCapture');
    const btnRetake = byId('btnRetake');
    const btnSave = byId('btnSave');
    const istNow = byId('istNow');

    function tickIST(){ istNow.value = formatIST(new Date()); }

    async function loadDbPhoto(empId){
      dbPhoto.src = '';
      dbPhoto.alt = 'No previous image';
      try{
        const r = await fetch(`/v1/attendance/photo/latest?employeeId=${encodeURIComponent(empId)}`);
        if(!r.ok) throw new Error('status '+r.status);
        const j = await r.json(); // { url: "https://..." }
        if(j && j.url){ dbPhoto.src = j.url; dbPhoto.alt = 'Last saved image'; }
      }catch(e){
        console.log('No DB photo:', e.message);
      }
    }

    async function openModal(kind){
      if(!selectedEmployee){ alert('Please select an employee first.'); byId('empSearchInput').focus(); return; }
      // Gate: new check-in only if previous session is closed; new check-out only if there is an open session
      hasOpenSession = await checkOpenSession(selectedEmployee.id);
      if(kind==='checkin' && hasOpenSession){
        alert('A session is already open for this employee. Please do Auto Check-Out first.');
        return;
      }
      if(kind==='checkout' && !hasOpenSession){
        // still allow checkout, but we’ll default to 6:30 PM if no time captured
        // continue
      }

      mode = kind;
      autoTitle.innerHTML = (mode==='checkin'
        ? `<i class="fa-solid fa-bolt"></i> Auto Check-In`
        : `<i class="fa-solid fa-person-walking-arrow-right"></i> Auto Check-Out`);
      autoEmpName.textContent = selectedEmployee.name;
      autoEmpId.textContent   = selectedEmployee.id;

      lastPhotoDataUrl = null;
      const ctx = snap.getContext('2d'); ctx.clearRect(0,0,snap.width,snap.height);
      setBtnEnabled(btnSave, false);

      await loadDbPhoto(selectedEmployee.id);

      autoModal.style.display='flex';
      tickIST(); istTimer = setInterval(tickIST, 1000);

      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' } });
        cam.srcObject = stream;
      }catch(e){
        alert('Camera access failed: '+ e.message);
      }
    }

    function closeModal(){
      autoModal.style.display='none';
      clearInterval(istTimer); istTimer=null;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      const ctx = snap.getContext('2d'); ctx.clearRect(0,0,snap.width,snap.height);
      lastPhotoDataUrl = null;
      setBtnEnabled(btnSave, false);
    }

    byId('btnAutoCheck').addEventListener('click', ()=>openModal('checkin'));
    byId('btnAutoCheckout').addEventListener('click', ()=>openModal('checkout'));
    closeAuto.addEventListener('click', closeModal);

    btnCapture.addEventListener('click', ()=>{
      const ctx = snap.getContext('2d');
      ctx.drawImage(cam, 0, 0, snap.width, snap.height);
      lastPhotoDataUrl = snap.toDataURL('image/png');
      // Only after capturing enable Save/Check-In/Out
      setBtnEnabled(btnSave, true);
    });
    btnRetake.addEventListener('click', ()=>{
      const ctx = snap.getContext('2d'); ctx.clearRect(0,0,snap.width,snap.height);
      lastPhotoDataUrl = null;
      setBtnEnabled(btnSave, false);
    });

    // ---------- AJAX Save ----------
    async function postJSON(url, payload){
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const t = await res.text().catch(()=> '');
        throw new Error(`${res.status} ${res.statusText} ${t}`);
      }
      return res.json().catch(()=> ({}));
    }

    btnSave.addEventListener('click', async ()=>{
      if(!selectedEmployee){ alert('No employee selected'); return; }

      try{
        if(mode==='checkin'){
          if(!lastPhotoDataUrl){ alert('Please capture a photo first.'); return; }

          const payload = {
            employeeId: selectedEmployee.id,
            employeeName: selectedEmployee.name,
            checkinIst: istNow.value,
            imageBase64: lastPhotoDataUrl
          };
          // Save
          await postJSON('/v1/attendance/checkin', payload);

          // UI: add row in dashboard
          addRowCheckin(selectedEmployee, payload.checkinIst);
          hasOpenSession = true;
          alert(`Check-In saved for ${selectedEmployee.name} at ${payload.checkinIst}`);
          closeModal();
        } else {
          // CHECK-OUT
          // If user did not capture, default to 6:30 PM IST today
          let checkoutTs = istNow.value;
          if(!lastPhotoDataUrl){
            const sixThirty = todayAtIST(18,30);
            checkoutTs = formatIST(sixThirty);
          }
          const payload = {
            employeeId: selectedEmployee.id,
            employeeName: selectedEmployee.name,
            checkoutIst: checkoutTs,
            imageBase64: lastPhotoDataUrl || null
          };
          await postJSON('/v1/attendance/checkout', payload);

          // UI: close row if exists, else add one with only checkout
          closeRowCheckout(selectedEmployee.id, payload.checkoutIst);
          hasOpenSession = false;
          alert(`Check-Out saved for ${selectedEmployee.name} at ${payload.checkoutIst}`);
          closeModal();
        }
      }catch(e){
        alert('Save failed: ' + e.message);
      }
    });

    // ---------- Demo: initial empty table ----------
    // (Intentionally empty; rows will be added as check-ins happen)

</script>
</body>
</html>
