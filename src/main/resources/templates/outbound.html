<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8"/>
    <title>Manifest — Geekmonkey</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Bootstrap 5 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root{
          --bg:#F9FAFB; --card:#FFFFFF; --stroke:#E5E7EB; --text:#111827; --muted:#6B7280;
          --accent:#FF7A00; --accent-ink:#9A4D00; --accent-weak:#FFE5D0; --radius:14px;
        }
        html, body { height:100%; background:var(--bg); color:var(--text); }
        body { line-height:1.6; }

        /* Top bar */
        .gm-topbar{
          position:sticky; top:0; z-index:1030;
          background:linear-gradient(90deg, var(--accent), #FF9A3D);
          color:#fff; box-shadow:0 8px 18px rgba(0,0,0,0.08);
        }
        .gm-topbar .brand{ font-weight:700; letter-spacing:.3px; }
        .gm-btn{ border-radius:12px; border:none; padding:.5rem .9rem; font-weight:600; }
        .gm-btn-accent{ background:#fff; color:var(--accent-ink); }
        .gm-btn-accent:hover{ background:var(--accent-weak); color:var(--accent-ink); }
        .gm-btn-ghost{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.55); }
        .gm-btn-ghost:hover{ background:rgba(255,255,255,0.12); }
        .gm-section-title{ font-weight:700; font-size:1.25rem; margin:1.25rem 0 .75rem; }

        /* Cards / inputs */
        .gm-card{
          background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
          box-shadow:0 8px 24px rgba(17,24,39,0.06);
        }
        .form-control, .form-select{ border-color:var(--stroke); border-radius:12px; }
        .form-control:focus, .form-select:focus{
          border-color:var(--accent); box-shadow:0 0 0 .25rem rgba(255,122,0,.15);
        }

        /* Buttons */
        .btn-gm{ border:none; border-radius:10px; font-weight:600; }
        .btn-gm-primary{ background:var(--accent); color:#fff; }
        .btn-gm-primary:hover{ background:#ff8f29; }
        .btn-gm-muted{ background:#F3F4F6; color:var(--text); border:1px solid var(--stroke); }
        .btn-gm-muted:hover{ background:#EAECEF; }

        /* Table */
        table thead th{
          background:var(--accent); color:#fff; border-color:var(--accent); vertical-align:middle;
        }
        .table > :not(caption) > * > *{ border-color:var(--stroke) !important; }
        tbody tr:nth-child(even){ background:#FFF8F2; }

        /* Duplicate row styling */
        .dup td { color:#dc2626 !important; font-weight:600; }

        /* Print */
        @media print{
          body{ margin:12mm; background:#fff; }
          .gm-topbar, .no-print{ display:none !important; }
          .modal{ display:none !important; }
          table{ margin:0 auto; }
          h1, h2, .text-center{ text-align:center !important; }
        }
    </style>
</head>
<body>

<!-- Top bar -->
<div class="gm-topbar no-print">
    <div class="container d-flex align-items-center justify-content-between py-2">
        <div class="d-flex gap-2">
            <button type="button" class="gm-btn gm-btn-ghost" id="backBtn" title="Back">← Back</button>
            <button type="button" class="gm-btn gm-btn-accent" id="homeBtn" title="Home">⌂ Home</button>
        </div>
        <div class="brand">Geekmonkey • Manifest</div>
        <div></div>
    </div>
</div>

<main class="container my-4">
    <!-- Header / controls -->
    <div class="gm-card p-3 p-md-4 mb-3">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div>
                <h1 class="m-0" style="font-size:1.4rem;">Manifest</h1>
                <div class="text-muted">Geekmonkey — <span id="dateTime"></span></div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <label class="text-muted small mb-0" for="courierSelect">Courier</label>
                <select id="courierSelect" class="form-select">
                    <option value="Bluedart">Bluedart</option>
                    <option value="Delhivery">Delhivery</option>
                    <option value="DTDC">DTDC</option>
                    <option value="SKYKING">Skyking</option>
                    <option value="Ekart">Ekart</option>
                    <option value="Ecom">Ecom</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Scan input -->
    <div class="gm-card p-3 p-md-4 mb-3">
        <div class="row g-2 align-items-center">
            <div class="col-md-6">
                <input id="awbInput" type="text" class="form-control" placeholder="Scan or Enter AWB" autofocus/>
            </div>
            <div class="col-md-3">
                <button class="btn btn-gm-primary btn-gm w-100" onclick="handleScan()">Scan</button>
            </div>
            <div class="col-md-3 text-md-end">
                <button id="printBtn" class="btn btn-gm btn-gm-muted me-2 no-print" onclick="printPage()">Print Table</button>
                <button id="clearDataBtn" class="btn btn-gm btn-gm-muted no-print" onclick="clearData()">Clear Table</button>
            </div>
        </div>
    </div>

    <!-- Pickup details -->
    <div class="gm-card p-3 p-md-4 mb-3">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="pickupBy" class="form-label">Pickup By</label>
                <input id="pickupBy" type="text" class="form-control" placeholder="Enter name of person picking up"/>
            </div>
            <div class="col-md-4">
                <label for="contactNumber" class="form-label">Contact Number</label>
                <input id="contactNumber" type="text" class="form-control" placeholder="Enter contact number"/>
            </div>
            <div class="col-md-4">
                <label for="deviceName" class="form-label">Device Name (auto/optional)</label>
                <input id="deviceName" type="hidden" class="form-control" />
            </div>
        </div>
    </div>

    <!-- AWB table -->
    <div class="gm-card p-2 p-md-3">
        <div class="table-responsive">
            <table id="awbTable" class="table table-hover align-middle mb-0">
                <thead>
                <tr>
                    <th>S.No</th>
                    <th>AWB Number</th>
                    <th>Order ID</th>
                    <th>Customer Name</th>
                    <th>Already Manifested</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</main>

<!-- Watermark -->
<div class="watermark no-print">Geekmonkey Manifest</div>

<!-- Courier confirm modal -->
<div class="modal fade" id="courierModal" tabindex="-1" aria-labelledby="courierModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="courierModalLabel">Select Courier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <select id="modalCourierSelect" class="form-select">
                    <option value="Bluedart">Bluedart</option>
                    <option value="Delhivery">Delhivery</option>
                    <option value="DTDC">DTDC</option>
                    <option value="Ekart">Ekart</option>
                    <option value="Ecom">Ecom</option>
                    <option value="SKYKING">SKYKING</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-gm btn-gm-muted" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-gm btn-gm-primary" onclick="confirmCourier()" data-bs-dismiss="modal">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Header buttons
    document.getElementById('homeBtn').addEventListener('click', () => {
      window.location.href = '/v1/home';
    });
    document.getElementById('backBtn').addEventListener('click', () => {
      if (history.length > 1) { history.back(); } else { window.location.href = '/v1/home'; }
    });

    // DateTime ticker
    function updateDateTime(){
      const now = new Date();
      document.getElementById('dateTime').textContent = now.toLocaleString();
    }
    setInterval(updateDateTime, 1000); updateDateTime();

    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    // --- Sort & duplicate detection ---
    function recomputeAndSort(){
      const tbody = document.querySelector('#awbTable tbody');
      const rows = Array.from(tbody.rows);

      // Duplicate check by Order ID (cell index 2)
      const counts = {};
      rows.forEach(r => {
        const id = (r.cells[2].innerText || '').trim();
        if (id) counts[id] = (counts[id] || 0) + 1;
      });
      rows.forEach(r => {
        r.classList.remove('dup');
        const id = (r.cells[2].innerText || '').trim();
        if (id && counts[id] > 1) r.classList.add('dup');
      });

      // Sort by Customer Name (cell index 3), push "Loading/Not found/Error" to bottom
      rows.sort((a,b) => {
        const an = (a.cells[3].innerText || '').trim().toLowerCase();
        const bn = (b.cells[3].innerText || '').trim().toLowerCase();

        const aBad = !an || an.includes('loading') || an === 'not found' || an === 'error';
        const bBad = !bn || bn.includes('loading') || bn === 'not found' || bn === 'error';

        if (aBad && !bBad) return 1;
        if (!aBad && bBad) return -1;
        return an.localeCompare(bn, undefined, {sensitivity:'base'});
      });

      // Re-append in order + fix S.No
      rows.forEach((r,i) => {
        tbody.appendChild(r);
        r.cells[0].innerText = i + 1;
      });
    }

    // Scan typing detection
    let typingTimeout, lastKeypressTime = 0;
    document.getElementById('awbInput').addEventListener('input', function(){
      const awb = this.value.trim();
      const now = Date.now();
      const dt = now - lastKeypressTime;
      clearTimeout(typingTimeout);

      if (awb){
        if (dt < 500){
          typingTimeout = setTimeout(() => {
            this.disabled = true;
            addAWBToTable(awb);
            this.value = '';
            this.disabled = false;
            this.focus();
          }, 500);
        } else {
          typingTimeout = setTimeout(() => {
            addAWBToTable(awb);
            this.value = '';
          }, 3000);
        }
      }
      lastKeypressTime = now;
    });

    function handleScan(){
      if (isMobile && typeof Android !== 'undefined' && Android.scanBarcodesAndAddToTable){
        Android.scanBarcodesAndAddToTable();
      } else {
        const input = document.getElementById('awbInput');
        const awb = input.value.trim();
        if (awb){
          addAWBToTable(awb);
          input.value = '';
        }
      }
    }

    // WebView hook
    function onBarcodeScanned(awb, deviceName){
      if (deviceName) document.getElementById('deviceName').value = deviceName;
      addAWBToTable(awb);
      handleScan();
    }
    window.onBarcodeScanned = onBarcodeScanned;

    function addAWBToTable(awb){
      const tbody = document.querySelector('#awbTable tbody');
      const exists = Array.from(tbody.rows).some(r => r.getAttribute('data-awb') === awb);
      if (exists || !isValidAWB(awb)){ flashBackground('red'); return; }
      else { flashBackground('green'); }

      const row = tbody.insertRow();
      row.setAttribute('data-awb', awb);

      row.insertCell(0).innerText = tbody.rows.length;     // S.No (temporary; fixed by recompute)
      row.insertCell(1).innerText = awb;                    // AWB
      row.insertCell(2).innerText = 'Order no Loading...';  // Order ID
      row.insertCell(3).innerText = 'Customer name Loading...'; // Customer
      const manifestCell = row.insertCell(4);
      manifestCell.innerText = 'Already manifested Loading...';

      // After inserting, run sort/dup to place "Loading..." at bottom
      recomputeAndSort();

      fetch('/v1/order/outbound/addAWBToManifest/' + encodeURIComponent(awb))
        .then(r => r.json())
        .then(data => {
          row.cells[2].innerText = data.orderId || 'Not found';
          row.cells[3].innerText = data.customerName || 'Not found';
          manifestCell.innerText = data.pickupDate || 'Not found';
          if (data.pickupDate && data.pickupDate !== 'Not found'){
            manifestCell.style.color = 'red';
            manifestCell.style.fontWeight = '600';
          }
          recomputeAndSort(); // resort + duplicate mark after values arrive
        })
        .catch(() => {
          row.cells[2].innerText = 'Error';
          row.cells[3].innerText = 'Error';
          manifestCell.innerText = 'Error';
          recomputeAndSort();
        });
    }

    function flashBackground(color){
      const original = document.body.style.backgroundColor;
      document.body.style.backgroundColor = color;
      setTimeout(() => { document.body.style.backgroundColor = original || 'var(--bg)'; }, 300);
    }

    // Preload existing items
    window.onload = function(){ fetchExistingItems(); };
    function fetchExistingItems(){
      fetch('/v1/order/outbound/existingOrders')
        .then(r => r.json())
        .then(list => {
          const tbody = document.querySelector('#awbTable tbody');
          list.forEach((item, idx) => {
            const row = tbody.insertRow();
            row.setAttribute('data-awb', item.awb);

            row.insertCell(0).innerText = idx + 1;
            row.insertCell(1).innerText = item.awb;
            row.insertCell(2).innerText = item.orderId || 'Not found';
            row.insertCell(3).innerText = item.customerName || 'Not found';
            const manifested = row.insertCell(4);
            manifested.innerText = item.pickupDate || 'Not found';
            if (item.pickupDate && item.pickupDate !== 'Not found'){
              manifested.style.color = 'red';
              manifested.style.fontWeight = '600';
            }
          });
          recomputeAndSort(); // initial sort + duplicate mark
        })
        .catch(err => console.error('Error fetching existing items:', err));
    }

    function printPage(){ saveManifest(); window.print(); }

    function saveManifest(){
      const courier = document.getElementById('courierSelect').value;
      const pickupBy = document.getElementById('pickupBy').value;
      const contactNumber = document.getElementById('contactNumber').value;
      const deviceName = document.getElementById('deviceName').value;
      const dateTime = document.getElementById('dateTime').textContent;

      const ok = confirm(`You selected ${courier}. Is this correct?`);
      if (!ok){
        new bootstrap.Modal(document.getElementById('courierModal')).show();
        return;
      }
      fetch('/v1/order/outbound/savemanifest', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ dateTime, courier, pickedUpBy: pickupBy, phoneNo: contactNumber, deviceName })
      }).catch(()=>{});
    }

    function confirmCourier(){
      const chosen = document.getElementById('modalCourierSelect').value;
      document.getElementById('courierSelect').value = chosen;
    }

    function clearData(){
      if (!confirm('Are you sure you want to clear all data?')) return;
      fetch('/v1/order/outbound/clearData', { method:'GET', headers:{ 'Content-Type':'application/json' }})
        .then(res => { if (res.ok){ alert('Data cleared successfully!'); location.reload(); }
                       else { alert('Failed to clear data. Please try again.'); } })
        .catch(err => { console.error('Error clearing data:', err); alert('An error occurred while clearing data.'); });
    }

    function isValidAWB(awb){
      const courier = document.getElementById('courierSelect').value;
      return !!awb && !!courier;
    }
</script>
<div th:replace="~{fragments/chatbot :: chatbot}"></div>

</body>
</html>
