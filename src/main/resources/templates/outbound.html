<!DOCTYPE html>
<html>
<head>
    <title>Scan Orders</title>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <style>

        @media print {
        body {
            margin: 1in; /* 1-inch margin on all sides */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        table {
            margin: 0 auto; /* Center the table horizontally */
        }

        h1, h2, div, input, button {
            text-align: center; /* Center align text and elements */
        }

        #courierModal, #modalOverlay {
            display: none; /* Hide modals during print */
        }
    }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f6f9;
            color: #333;
            line-height: 1.6;
        }

        h1, h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        input[type="text"] {
            padding: 12px;
            width: 100%;
            max-width: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            padding: 12px 20px;
            margin: 10px 0;
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        button:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        #backButton, #homeButton {
            position: fixed;
            top: 10px;
            padding: 10px 15px;
            font-size: 14px;
        }

        #backButton {
            left: 10px;
            background-color: #e74c3c;
        }

        #homeButton {
            left: 80px;
            background-color: #28a745;
        }

        #backButton:hover, #homeButton:hover {
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        thead {
            background-color: #ecf0f1;
        }

        th, td {
            padding: 15px;
            border: 1px solid #ddd;
            text-align: left;
            font-size: 14px;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            input[type="text"], button {
                width: 100%;
                max-width: none;
            }
        }

        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: calc(14px + 0.5vw);
            color: rgba(0, 0, 0, 0.2);
            pointer-events: none;
            z-index: 9999;
            text-align: center;
            background: rgba(255, 255, 255, 0.5);
            padding: 10px 20px;
            border-radius: 8px;
            backdrop-filter: blur(1px);
        }
    </style>

</head>
<body>

<div>
    <button id="backButton" onclick="goBack()" style="position: fixed; top: 10px; left: 10px;">Back</button>
    <button id="homeButton" onclick="goHome()"
            style="position: fixed; top: 10px; left: 90px;background-color:#28a745;color:#ffff">Home
    </button>
</div>

<div class="container">
    <h1 class="text-center my-4">Manifest</h1>
    <h2>Geekmonkey - Manifest - </h2><label id="dateTime"></label>
    <div>
        <label for="courierSelect">Select Courier:</label>
        <select id="courierSelect">
            <option value="Bluedart">Bluedart</option>
            <option value="Delhivery">Delhivery</option>
            <option value="DTDC">DTDC</option>
            <option value="Ekart">Ekart</option>
            <option value="Ecom">Ecom</option>
        </select>
    </div>
</div>
<!-- Scan Input and Button -->


<div>
    <input id="awbInput" placeholder="Scan or Enter AWB" type="text"/>
    <button onclick="handleScan()">Scan</button>
</div>


<!-- Table to show scanned items -->
<table id="awbTable" style="margin-top: 20px;">
    <thead>
    <tr>
        <th>S.No</th>
        <th>AWB Number</th>
        <th>Order ID</th>
        <th>Customer Name</th>
        <th>Already Manifested</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Print Button -->
<button id="printBtn" onclick="printPage()">Print Table</button>
<button id="clearDataBtn" onclick="clearData()">Clear Table</button>


<div id="courierModal"
     style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); z-index: 1000;">
    <h3>Select Courier</h3>
    <select id="modalCourierSelect">
        <option value="Bluedart">Bluedart</option>
        <option value="Delhivery">Delhivery</option>
        <option value="DTDC">DTDC</option>
        <option value="Ekart">Ekart</option>
        <option value="Ecom">Ecom</option>
    </select>
    <button onclick="confirmCourier()">Confirm</button>
    <button onclick="closeModal()">Cancel</button>
</div>
<div id="modalOverlay"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>

<!-- Input for Pickup By -->
<div style="margin-top: 20px;">
    <label for="pickupBy">Pickup By:</label>
    <input id="pickupBy" type="text" placeholder="Enter name of person picking up" style="margin-left: 10px; padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px;">
</div>

<!-- Input for Contact Number -->
<div style="margin-top: 10px;">
    <label for="contactNumber">Contact Number:</label>
    <input id="contactNumber" type="text" placeholder="Enter contact number" style="margin-left: 10px; padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px;">
    <input id="deviceName" visibility="hidden" type="text" placeholder="Enter contact number" style="margin-left: 10px; padding: 8px; width: 300px; border: 1px solid #ccc; border-radius: 4px;">

</div>

<style>
    .watermark {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-30deg);
        font-size: calc(14px + 0.5vw); /* Scales with screen size */
        color: rgba(0, 0, 0, 0.3);
        pointer-events: auto; /* Allows interaction */
        z-index: 9999;
        text-align: center;
        background: rgba(255, 255, 255, 0.5); /* Semi-transparent background */
        padding: 10px 20px;
        border-radius: 8px;
        backdrop-filter: blur(5px); /* Blur effect */
        cursor: pointer; /* Indicates clickable */
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .watermark:hover {
        opacity: 0.6; /* Changes opacity on hover */
        transform: translate(-50%, -50%) rotate(-30deg) scale(1.1); /* Slight zoom effect */
    }
</style>
<!-- Script -->
<script>
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);


      let typingTimeout; // Variable to store the timeout
    let lastKeypressTime = 0; // To track the time of the last keypress

    document.getElementById('awbInput').addEventListener('input', function () {
        const awb = this.value.trim();
        const currentTime = new Date().getTime();
        const timeDifference = currentTime - lastKeypressTime;

        clearTimeout(typingTimeout); // Clear any existing timeout

        if (awb) {
            if (timeDifference < 500) {
                  typingTimeout = setTimeout(() => {
                 this.disabled = true;
                    addAWBToTable(awb); // Add AWB to the table
                    this.value = ''; // Clear the input field
                    //enable the field
                    this.disabled = false; // Re-enable input after processing


                    //set cursor
                    this.focus(); // Focus back on the input field
                }, 500); // 3-second delay
            } else {
                // Detected as typing
                typingTimeout = setTimeout(() => {
                    addAWBToTable(awb); // Add AWB to the table
                    this.value = ''; // Clear the input field
                }, 3000); // 3-second delay
            }
        }

        lastKeypressTime = currentTime; // Update the last keypress time
    });


    function handleScan() {
        if (isMobile) {
            Android.scanBarcodesAndAddToTable(); // Calls native Android method
        } else {
            const awb = document.getElementById('awbInput').value.trim();
            if (awb) {
                addAWBToTable(awb);
                document.getElementById('awbInput').value = '';
            }
        }
    }

    // Example hook for Android to call when barcode is scanned
    function onBarcodeScanned(awb, deviceName) {
        addAWBToTable(awb);
        //addDeviceName

    }

    function addAWBToTable(awb) {


    const tbody = document.getElementById('awbTable').querySelector('tbody');

    // Check if AWB already exists
    const existingRow = Array.from(tbody.rows).find(row => row.getAttribute('data-awb') === awb);
    if (existingRow || !isValidAWB(awb)) {

      const awbInput = document.getElementById('awbInput');
      updateBackgroundColor('red');
        return; // Exit the function if duplicate is found
    }else{
        updateBackgroundColor('green');
    }

    const row = tbody.insertRow();
    row.setAttribute('data-awb', awb);

    // Add S.No dynamically
    const snoCell = row.insertCell(0);
    snoCell.innerText = tbody.rows.length;

    row.insertCell(1).innerText = awb;
    row.insertCell(2).innerText = 'Order no Loading...';
    row.insertCell(3).innerText = 'Customer name Loading...';
     row.insertCell(4).innerText = 'Already manifested Loading...';

    // AJAX to fetch orderId & customer
    fetch('/v1/order/outbound/addAWBToManifest/' + awb)
        .then(response => response.json())
        .then(data => {
           // row.cells[2].innerText = data.orderId || 'Not found';
            //row.cells[3].innerText = data.customerName || 'Not found';
            //document.getElementById('printBtn').style.display = 'inline-block';
        })
        .catch(() => {
            row.cells[2].innerText = 'Error';
            row.cells[3].innerText = 'Error';
        });
}

    function updateDateTime() {
        const now = new Date();
        const formattedDateTime = now.toLocaleString();
        document.getElementById('dateTime').textContent = formattedDateTime;
    }

    // Update the date and time every second
    setInterval(updateDateTime, 1000);
    updateDateTime();

    function updateBackgroundColor(color){
        document.body.style.backgroundColor = color;

      setTimeout(() => {
              document.body.style.backgroundColor = ''; // Reset to the original background color
        }, 300);

    }

    function goBack() {
        window.history.back();
    }

    function goHome(){
        window.location.href = '/v1/home'; // Redirect to home page
    }

    function onBarcodeScanned(awb,deviceName) {
        console.log("Scanned Barcode: " + awb);
        addAWBToTable(awb)
        Android.scanBarcodesAndAddToTable();
        // Add the barcode to the table or perform other actions
    }

    window.onload = function () {
    fetchExistingItems();
};

function fetchExistingItems() {
    fetch('/v1/order/outbound/existingOrders') // Replace with your API endpoint
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('awbTable').querySelector('tbody');
            data.forEach((item, index) => {
                const row = tbody.insertRow();
                row.setAttribute('data-awb', item.awb);

                const snoCell = row.insertCell(0);
                snoCell.innerText = index + 1;

                row.insertCell(1).innerText = item.awb;
                row.insertCell(2).innerText = item.orderId || 'Not found';
                row.insertCell(3).innerText = item.customerName || 'Not found';
                  const alreadyManifestedCell = row.insertCell(4);
                alreadyManifestedCell.innerText = item.pickupDate || 'Not found';

                if (item.pickupDate && item.pickupDate !== 'Not found') {
                    alreadyManifestedCell.style.color = 'red';
                }
            });
        })
        .catch(error => {
            console.error('Error fetching existing items:', error);
        });
}

    function printPage(){
        saveManifest();
        window.print();
    }

    function saveManifest(){

        //confirm if courier selected is correct or not
        const courier = document.getElementById('courierSelect').value;
        const pickupBy = document.getElementById('pickupBy').value;
        const contactNumber = document.getElementById('contactNumber').value;
        const deviceName = document.getElementById('deviceName').value;

        const isConfirmed = confirm(`You selected ${courier}. Is this correct?`);
        if (!isConfirmed) {
            showCourierModal();
        }else{

        //call api get call to save outbound orders in db
        var dateTime = document.getElementById('dateTime').textContent;
        fetch('/v1/order/outbound/savemanifest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                dateTime: dateTime,
                courier: document.getElementById('courierSelect').value,
                pickedUpBy: pickupBy,
                phoneNo: contactNumber,
                deviceName: deviceName
            })
        })
    }
    }


    function showCourierModal() {
        document.getElementById('courierModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

      function closeModal() {
        document.getElementById('courierModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    function confirmCourier() {
        const selectedCourier = document.getElementById('modalCourierSelect').value;
        document.getElementById('courierSelect').value = selectedCourier;
        closeModal();
    }

    function clearData() {
    const isConfirmed = confirm("Are you sure you want to clear all data?");
    if (isConfirmed) {
        fetch('/v1/order/outbound/clearData', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                alert("Data cleared successfully!");
                location.reload(); // Reload the page
            } else {
                alert("Failed to clear data. Please try again.");
            }
        })
        .catch(error => {
            console.error("Error clearing data:", error);
            alert("An error occurred while clearing data.");
        });
    }
}
    function isValidAWB(awb){
        //check courier selected
        const courier = document.getElementById('courierSelect').value;
        if("Bluedart" == courier && (!(/^76\d{9}$/.test(awb)) && !(/^77\d{9}$/.test(awb)) && !(/^75\d{9}$/.test(awb)))){
            return false;
        }
        if("DTDC" == courier && !(/^7X\d{8,}$/.test(awb))){
            return false;
        }
        return true;

    }
</script>

</body>
</html>
