<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Geekmonkey ‚Äî Inbound Steps</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- jsPDF & QRCode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root{
          --bg:#F9FAFB; --card:#fff; --stroke:#E5E7EB; --text:#111827; --muted:#6B7280;
          --accent:#FF7A00; --accent-ink:#9A4D00; --radius:16px;
        }
        html,body{height:100%}
        body{background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}

        /* Header */
        .gm-header{
          position:sticky; top:0; z-index:1000; background:#fff; border-bottom:1px solid var(--stroke);
        }
        .gm-header .inner{
          display:flex; align-items:center; gap:.75rem; padding:.75rem 1rem; max-width:1200px; margin:0 auto;
        }
        .gm-brand{
          display:flex; align-items:center; gap:.55rem; font-weight:800; color:var(--text); text-decoration:none;
        }
        .gm-dot{width:10px; height:10px; border-radius:50%; background:var(--accent)}
        .gm-actions{margin-left:auto; display:flex; gap:.5rem}
        .gm-btn{
          display:inline-flex; align-items:center; gap:.4rem; border:1px solid var(--stroke);
          background:#fff; color:var(--text); padding:.45rem .7rem; border-radius:12px; text-decoration:none;
        }
        .gm-btn:hover{background:#F3F4F6}
        .gm-btn-primary{border-color:transparent; background:var(--accent); color:#fff;}
        .gm-btn-primary:hover{background:#ff8f29}

        /* Card container */
        .wizard-container{
          max-width: 1200px; margin: 18px auto; padding: 0; background:var(--card);
          border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:0 6px 16px rgba(17,24,39,.06);
        }
        .wizard-container .head{
          padding:1rem 1.25rem; border-bottom:1px solid var(--stroke); display:flex; align-items:center; gap:1rem; flex-wrap:wrap;
        }
        .wizard-container .head h2{margin:0; font-size:1.15rem}
        .wizard-container .body{padding:1rem 1.25rem}
        .muted{color:var(--muted)}

        .wizard-step{display:none}
        .wizard-step.active{display:block}

        .modal-content{
          background:#fff; border-radius:12px; border:1px solid var(--stroke);
          max-height:80vh; overflow-y:auto;
        }

        .table thead th{background:#F3F4F6}
        .list-group-item{cursor:pointer}

        .video-wrap video{max-width:100%; border-radius:12px; border:1px solid var(--stroke)}
    </style>
</head>
<body>
<!-- Header -->
<header class="gm-header">
    <div class="inner">
        <span class="gm-dot" aria-hidden="true"></span>
        <a class="gm-brand" href="/v1/home" aria-label="Geekmonkey Home">Geekmonkey</a>
        <div class="gm-actions">
            <button type="button" class="gm-btn" id="btnBack" title="Go Back">‚Üê Back</button>
            <a class="gm-btn gm-btn-primary" href="/v1/home" title="Home">üè† Home</a>
        </div>
    </div>
</header>

<!-- Inbound Wizard -->
<div class="wizard-container">
    <div class="head">
        <h2>Inbound Wizard</h2>
        <span class="muted">Scan, pack, record, and complete inbound cartons.</span>
    </div>
    <div class="body">
        <!-- Existing Cartons (Thymeleaf) -->
        <section class="mb-3">
            <h5>Existing Cartons</h5>
            <div th:if="${cartons != null}">
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                        <tr>
                            <th>Product ID</th>
                            <th>Product Name</th>
                            <th class="text-end">Quantity</th>
                            <th class="text-end">Cost</th>
                            <th>Image</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="carton, cartonStat : ${cartons}">
                            <td th:text="${carton.productId}"></td>
                            <td th:text="${carton.productName}"></td>
                            <td class="text-end" th:text="${carton.quantity}"></td>
                            <td class="text-end" th:text="${carton.productCost}"></td>
                            <td><img th:src="${carton.image}" style="height:60px;width:60px;object-fit:cover;border-radius:8px;border:1px solid var(--stroke);"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Dynamic Steps -->
        <div id="wizardSteps"></div>

        <!-- Product Picker Modal -->
        <div class="modal" id="productListModal" role="dialog" tabindex="-1">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Select Product</h5>
                        <button class="btn-close" onclick="closeProductListModal()" type="button" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul id="productList" class="list-group"></ul>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeProductListModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Webcam Recording -->
        <section class="mt-3">
            <h5>Webcam Recording</h5>
            <div class="video-wrap">
                <video autoplay id="cameraFeed" playsinline></video>
            </div>
            <canvas id="imageCanvas" style="display:none;"></canvas>
            <div class="d-flex flex-wrap gap-2 mt-3">
                <button class="btn gm-btn-primary" id="startButton" onclick="startCamera()">Start Camera</button>
                <button class="btn btn-outline-danger" disabled id="stopButton" onclick="stopRecording()">Stop Recording</button>
                <button class="btn btn-outline-primary" id="saveCarton" onclick="saveCarton()">Save Carton</button>
                <button class="btn btn-success" id="completeOrder" onclick="completeOrder()" disabled>Complete Order</button>
            </div>
        </section>

        <!-- Pager -->
        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-outline-secondary" id="prevButton" onclick="prevStep()">Previous</button>
            <button class="btn gm-btn-primary" id="nextButton" onclick="nextStep()">Next</button>
        </div>
    </div>
</div>

<!-- Capture Image Modal -->
<div class="modal" id="captureImageModal" role="dialog" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Capture Image</h5>
                <button class="btn-close" onclick="closeModal()" type="button" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <video autoplay id="cameraFeedPopup" style="width:100%;" playsinline></video>
                <canvas id="imageCanvasPopup" style="display:none;"></canvas>
                <img id="imgPreview" src="" alt="Captured Image" style="width:100%; height:auto; border:1px solid var(--stroke); border-radius:12px; margin-top:10px;">
            </div>
            <div class="modal-footer d-flex justify-content-between align-items-center">
                <div class="small text-muted">
                    <label id="productIdPopup" class="me-3"></label>
                    <label id="rowCountIdPopup" hidden="true"></label>
                </div>
                <div>
                    <button class="btn gm-btn-primary" id="clickImage" onclick="clickImage()">Capture</button>
                    <button class="btn btn-success" disabled id="saveButton" onclick="saveImage()">Save</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Packaging Modal -->
<div class="modal" id="packagingModal" role="dialog" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enter Packaging Dimensions</h5>
                <button class="btn-close" onclick="closePackagingModal()" type="button" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2">
                    <div class="col-12">
                        <input type="text" class="form-control" id="popupProductId" hidden>
                    </div>
                    <div class="col-md-4">
                        <label for="length" class="form-label">Length</label>
                        <input type="number" class="form-control" id="length" placeholder="e.g. 20">
                    </div>
                    <div class="col-md-4">
                        <label for="breadth" class="form-label">Breadth</label>
                        <input type="number" class="form-control" id="breadth" placeholder="e.g. 15">
                    </div>
                    <div class="col-md-4">
                        <label for="height" class="form-label">Height</label>
                        <input type="number" class="form-control" id="height" placeholder="e.g. 10">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn gm-btn-primary" onclick="savePackagingDetails()">Save</button>
                <button class="btn btn-secondary" onclick="closePackagingModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal" id="qrcodeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">QR Code</h5>
                <button type="button" class="btn-close" onclick="closeQRCode()" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrcode"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeQRCode()">Close</button>
                <button type="button" class="btn gm-btn-primary" onclick="printQRCode()">Print</button>
            </div>
        </div>
    </div>
</div>

<!-- Spinner -->
<div id="spinner" style="display:none; text-align:center; margin-top:10px;">
    <div class="spinner-border" role="status" aria-label="Loading"></div>
</div>

<script>
    // ===== Header Back handling =====
    document.getElementById('btnBack').addEventListener('click', function(){
      if (window.history.length > 1) window.history.back();
      else window.location.href = '/v1/home';
    });

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const urlParams = new URLSearchParams(window.location.search);
    const getParamNum = (k, def=0) => {
      const v = urlParams.get(k);
      const n = Number(v);
      return Number.isFinite(n) && n > 0 ? n : def;
    };
    const getParamStr = (k, def='') => (urlParams.get(k) ?? def);

    const totalCartons = getParamNum('cartonNo', 1);
    let currentStep = getParamNum('currentStep', 1);
    const inboundId = getParamStr('inboundId', '');

    let stream = null;
    let imageStream = null;
    let mediaRecorder = null;
    let recordedChunks = [];

    function updatePagerButtons(){
      $('prevButton').disabled = (currentStep <= 1);
      $('nextButton').disabled = (currentStep >= totalCartons);
      $('completeOrder').disabled = !(currentStep === totalCartons);
    }

    function generateWizardSteps(){
      const wizardSteps = $('wizardSteps');
      wizardSteps.innerHTML = '';
      for (let i = 1; i <= totalCartons; i++) {
        const stepDiv = document.createElement('div');
        stepDiv.className = `wizard-step ${i === currentStep ? 'active' : ''}`;
        stepDiv.id = `step${i}`;
        stepDiv.innerHTML = `
          <div class="border rounded-3 p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Carton ${i}</h6>
              <div class="small text-muted">Inbound: ${inboundId || '-'}</div>
            </div>
            <div class="table-responsive mt-3">
              <table id="productTable${i}" class="table table-bordered table-sm align-middle">
                <thead>
                  <tr>
                    <th style="width:60px;">Sno</th>
                    <th style="min-width:140px;">Product ID</th>
                    <th style="min-width:240px;">Product Name</th>
                    <th class="text-end" style="width:90px;">Qty</th>
                    <th class="text-end" style="width:110px;">Cost</th>
                    <th style="width:120px;">Is Packaging?</th>
                    <th style="width:130px;">Capture Image</th>
                    <th style="width:120px;">Preview</th>
                    <th style="width:130px;">Upload Image</th>
                    <th style="width:90px;">Actions</th>
                    <th style="width:120px;">Print QR</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="addProductRow(${i})">+ Add Product</button>
          </div>
        `;
        wizardSteps.appendChild(stepDiv);
      }
      updatePagerButtons();
    }

    function addProductRow(cartonNo){
      const tbody = document.querySelector(`#productTable${cartonNo} tbody`);
      const rowCount = tbody.rows.length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="form-control form-control-sm" name="rowCount[]" readonly value="${rowCount}"></td>
        <td><input type="text" class="form-control form-control-sm" name="productId[]" id="productID${rowCount}" value="${rowCount}" readonly></td>
        <td><input type="text" class="form-control form-control-sm" name="productName[]" id="productName${rowCount}" oninput="fetchAndShowProducts(${rowCount})"></td>
        <td><input type="number" class="form-control form-control-sm text-end" name="quantity[]" min="1" value="1" required></td>
        <td><input type="number" class="form-control form-control-sm text-end" name="cost[]" step="0.01"></td>
        <td class="text-center">
          <input type="checkbox" class="form-check-input" onchange="showPackagingPopup(${rowCount})" name="isPackaging[]">
        </td>
        <td class="text-center">
          <button class="btn btn-sm gm-btn-primary" onclick="captureImage(${rowCount})">Capture</button>
        </td>
        <td class="text-center">
          <img id="productImage${rowCount}" src="" alt="Captured Image" style="width:100px; height:auto; display:none; border:1px solid var(--stroke); border-radius:8px;">
        </td>
        <td><input type="file" class="form-control form-control-sm" name="image[]"></td>
        <td class="text-center"><button class="btn btn-sm btn-outline-danger" type="button" onclick="removeRow(this)">Remove</button></td>
        <td class="text-center"><button class="btn btn-sm btn-outline-secondary" type="button" onclick="generateQRCode(${rowCount})">QRCode</button></td>
      `;
      tbody.appendChild(tr);
    }

    function removeRow(button){
      const row = button.closest('tr');
      row.parentElement.removeChild(row);
    }

    // ==== Product search modal ====
    let selectedRowId = null;

    function fetchAndShowProducts(rowId){
      selectedRowId = rowId;
      const query = $(`productName${rowId}`).value.trim();
      if (query.length <= 4) return;

      $('spinner').style.display = 'block';
      fetch(`/v1/inventory/search?query=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
          const ul = $('productList');
          ul.innerHTML = '';
          (data || []).forEach(product => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = `${product.productTitle} (ID: ${product.productVariantId})`;
            li.onclick = () => selectProduct(product);
            ul.appendChild(li);
          });
          $('productListModal').style.display = 'block';
        })
        .catch(err => console.error('Error fetching products:', err))
        .finally(() => $('spinner').style.display = 'none');
    }

    function selectProduct(product){
      $(`productID${selectedRowId}`).value = product.productVariantId;
      $(`productName${selectedRowId}`).value = product.productTitle;
      closeProductListModal();
    }

    function closeProductListModal(){
      $('productListModal').style.display = 'none';
    }

    // ==== Camera (recording) ====
    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        $('cameraFeed').srcObject = stream;

        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type:'video/webm' });
          const url = URL.createObjectURL(blob);

          const playbackVideo = document.createElement('video');
          playbackVideo.controls = true;
          playbackVideo.src = url;
          playbackVideo.style.marginTop = '10px';
          $('cameraFeed').parentElement.appendChild(playbackVideo);

          const a = document.createElement('a');
          a.href = url;
          a.download = `InboundId_${inboundId || 'NA'}_Carton_${currentStep}_recorded.webm`;
          a.textContent = 'Download Video';
          a.className = 'btn btn-sm btn-outline-secondary ms-2';
          $('cameraFeed').parentElement.appendChild(a);

          // Auto-click download
          a.click();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
        };

        mediaRecorder.start();
        $('startButton').disabled = true;
        $('stopButton').disabled = false;
      } catch(err){
        console.error('Error accessing webcam:', err);
      }
    }

    function stopRecording(){
      if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      if (stream) stream.getTracks().forEach(t => t.stop());
      $('startButton').disabled = false;
      $('stopButton').disabled = true;
    }

    // ==== Camera (image capture modal) ====
    async function startCameraForImage(){
      try{
        imageStream = await navigator.mediaDevices.getUserMedia({ video:true });
        $('cameraFeedPopup').srcObject = imageStream;
      } catch(err){
        console.error('Error accessing webcam for image:', err);
      }
    }

    function stopCameraForImage(){
      if (imageStream) imageStream.getTracks().forEach(t => t.stop());
      imageStream = null;
    }

    function openModal(rowCount){
      $('captureImageModal').style.display = 'block';
      const productId = $(`productID${rowCount}`).value;
      $('productIdPopup').innerText = productId || '';
      $('rowCountIdPopup').innerText = String(rowCount);
      startCameraForImage();
    }

    function closeModal(){
      $('captureImageModal').style.display = 'none';
      stopCameraForImage();
      $('saveButton').disabled = true;
    }

    function captureImage(rowCount){
      openModal(rowCount);
      // Save button gets enabled after actual click (handled in clickImage)
    }

    function clickImage(){
      const vid = $('cameraFeedPopup');
      const canvas = $('imageCanvasPopup');
      const ctx = canvas.getContext('2d');
      canvas.width = vid.videoWidth;
      canvas.height = vid.videoHeight;
      ctx.drawImage(vid, 0, 0, canvas.width, canvas.height);
      const imageData = canvas.toDataURL('image/png');
      const preview = $('imgPreview');
      preview.src = imageData;
      $('saveButton').disabled = false;
    }

    function saveImage(){
      const canvas = $('imageCanvasPopup');
      const imageData = canvas.toDataURL('image/png');
      const rowCount = $('rowCountIdPopup').innerText;
      const productImage = $(`productImage${rowCount}`);
      productImage.src = imageData;
      productImage.style.display = 'block';

      const productId = $('productIdPopup').innerText || '';
      fetch('/v1/inbound/saveImage', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          image: imageData,
          carton: currentStep,
          inboundId: inboundId || '',
          productId: productId
        }),
      })
      .then(r => { if(!r.ok) throw new Error('Failed to save image'); return r; })
      .then(() => {
        alert('Image saved successfully!');
        closeModal();
      })
      .catch(err => console.error('Error saving image:', err));
    }

    // ==== Packaging ====
    function showPackagingPopup(rowCount){
      $('packagingModal').style.display = 'block';
      $('popupProductId').value = String(rowCount);
    }

    function closePackagingModal(){
      $('packagingModal').style.display = 'none';
      $('popupProductId').value = '';
    }

    function savePackagingDetails(){
      const L = Number($('length').value);
      const B = Number($('breadth').value);
      const H = Number($('height').value);
      const pidRow = $('popupProductId').value;

      if (!L || !B || !H){ alert('Please fill all dimensions.'); return; }
      const productName = `pkg-${L}-${B}-${H}`;
      $(`productID${pidRow}`).value = productName;
      closePackagingModal();
    }

    // ==== QR Code ====
    function generateQRCode(rowId){
      const productId = $(`productID${rowId}`).value;
      let productName = $(`productName${rowId}`).value || '';
      if (!productId && !productName){
        alert('Product ID is required to generate QR code.');
        return;
      }

      const box = $('qrcode');
      box.innerHTML = '';
      new QRCode(box, { text: productId || productName, width:128, height:128 });

      const textDiv = document.createElement('div');
      textDiv.style.textAlign = 'center';
      textDiv.style.marginTop = '10px';
      if (productName.length > 60) productName = productName.substring(0,60) + '‚Ä¶';
      textDiv.textContent = productName;
      box.appendChild(textDiv);

      $('qrcodeModal').style.display = 'block';
    }

    function closeQRCode(){ $('qrcodeModal').style.display = 'none'; }

    async function printQRCode(){
      const qrBox = $('qrcode');
      const img = qrBox.querySelector('img');
      const textEl = qrBox.querySelector('div');
      if (!img || !textEl){ alert('No QR code or text found to print.'); return; }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:'landscape', unit:'in', format:[4,1] });

      const qr = img.src;
      const label = textEl.textContent || '';
      const size = .5;

      const slots = [
        {x:.2, y:.1},
        {x:1.3, y:.1},
        {x:2.3, y:.1},
        {x:3.2, y:.1},
      ];

      pdf.setFontSize(5);
      const maxWidth = .7;

      slots.forEach(({x,y}) => {
        pdf.addImage(qr, 'PNG', x, y, size, size);
        const wrapped = pdf.splitTextToSize(label, maxWidth);
        pdf.text(wrapped, x, y + size + .1);
      });

      const blob = pdf.output('blob');
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }

    // ==== Save Carton ====
    function saveCarton(){
      const cartonNo = currentStep;
      const rows = document.querySelectorAll(`#productTable${cartonNo} tbody tr`);
      const products = Array.from(rows).map(row => ({
        productId: row.querySelector('[name="productId[]"]').value,
        productName: row.querySelector('[name="productName[]"]').value,
        quantity: row.querySelector('[name="quantity[]"]').value,
        cost: row.querySelector('[name="cost[]"]').value,
      }));

      const formData = new FormData();
      formData.append('inboundId', inboundId || '');
      formData.append('cartonNo', cartonNo);
      formData.append('products', JSON.stringify(products));

      fetch('/v1/inbound/saveCarton', { method:'POST', body: formData })
        .then(resp => resp)
        .then(() => alert('Carton saved successfully!'))
        .catch(err => console.error('Error saving carton:', err));
    }

    // ==== Navigation ====
    function nextStep(){
      if (currentStep < totalCartons){
        $(`step${currentStep}`).classList.remove('active');
        currentStep++;
        $(`step${currentStep}`).classList.add('active');
      }
      updatePagerButtons();
    }

    function prevStep(){
      if (currentStep > 1){
        $(`step${currentStep}`).classList.remove('active');
        currentStep--;
        $(`step${currentStep}`).classList.add('active');
      }
      updatePagerButtons();
    }

    function completeOrder(){
      saveCarton();

      if (!confirm('Are you sure you want to complete the order?')) return;

      alert(`Total number of cartons opened: ${totalCartons}`);

      const employeeName = prompt('Please enter your name to confirm completion:');
      if (!employeeName){
        alert('Employee name is required to complete the order.');
        return;
      }

      fetch('/v1/inbound/completeOrder', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: inboundId || '', closedBy: employeeName }),
      })
      .then(r => { if(!r.ok) throw new Error('Failed to complete the order'); return r.json(); })
      .then(() => {
        alert('Order completed successfully!');
        window.location.href = '/v1/inbound/completedOrders';
      })
      .catch(err => {
        console.error('Error completing order:', err);
        alert('Failed to complete the order. Please try again.');
      });
    }

    // ==== Init ====
    generateWizardSteps();
    updatePagerButtons();
</script>
</body>
</html>
