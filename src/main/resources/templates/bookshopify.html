<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Geekmonkey — Shopify Orders → Ship</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        :root{
          --bg:#F9FAFB; --card:#fff; --stroke:#E5E7EB; --text:#111827; --muted:#6B7280;
          --accent:#FF7A00; --ok:#065F46; --warn:#B45309; --err:#B91C1C; --radius:12px;
          --tier-new-bg:#ECEFF1; --tier-new-fg:#111827;
          --tier-good-bg:#E0F2FE; --tier-good-fg:#075985;
          --tier-premium-bg:#ECFDF5; --tier-premium-fg:#065F46;
          --tier-extreme-bg:#FEF3C7; --tier-extreme-fg:#92400E;
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

        /* Header */
        .gm-topbar{position:sticky;top:0;z-index:1000;background:#fff;border-bottom:1px solid var(--stroke)}
        .gm-topbar .inner{max-width:1200px;margin:0 auto;padding:10px 20px;display:flex;align-items:center;gap:12px;justify-content:space-between}
        .brand{display:flex;align-items:center;gap:10px;font-weight:800}
        .logo{width:32px;height:32px;border-radius:8px;background:var(--accent);display:grid;place-items:center;color:#fff;font-weight:700}
        .gm-actions{display:flex;gap:8px}

        /* Base UI */
        main{max-width:1200px;margin:16px auto;padding:0 20px}
        .view{display:none}.view.active{display:block}
        .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius)}
        .row{display:flex;gap:12px;flex-wrap:wrap}
        .btn{height:36px;padding:0 12px;border:none;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
        .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--stroke)}
        .btn.small{height:30px;border-radius:8px}
        .btn.linklike{background:#fff;border:1px solid var(--stroke);color:#var(--text)}
        .btn.linklike:hover{background:#fff8f2}
        .field{display:grid;gap:6px}
        .field input,.field select,.field textarea{height:36px;padding:0 10px;border:1px solid var(--stroke);border-radius:10px;background:#fff}
        .field textarea{height:72px;padding:8px 10px;resize:vertical}
        .hint{color:var(--muted);font-size:12px}
        .ok{color:var(--ok);font-size:12px}.error{color:var(--err);font-size:12px}
        table{width:100%;border-collapse:separate;border-spacing:0}
        th,td{padding:12px 14px;border-bottom:1px solid var(--stroke);vertical-align:top}
        th{font-size:12px;color:var(--muted);text-align:left;background:#fff}
        tr{cursor:pointer} tr:hover{background:#fff8f2}
        .status{padding:4px 8px;border-radius:999px;font-size:12px;background:#FFF3E6;color:#9A4D00;display:inline-block}
        .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--stroke);background:#fff;margin-right:4px}
        .tag{display:inline-block;padding:2px 8px;border-radius:6px;font-size:12px;background:#FFF3E6;color:#9A4D00;margin-right:6px}
        .grid{display:grid;gap:12px}
        .grid.cols2{grid-template-columns:1fr 1fr}
        .grid.cols3{grid-template-columns:repeat(3,1fr)}
        .grid.cols4{grid-template-columns:repeat(4,1fr)}

        /* Customer tier colors */
        .pill.tier-new{background:var(--tier-new-bg); color:var(--tier-new-fg); border-color:rgba(0,0,0,.06)}
        .pill.tier-good{background:var(--tier-good-bg); color:var(--tier-good-fg); border-color:#BAE6FD}
        .pill.tier-premium{background:var(--tier-premium-bg); color:var(--tier-premium-fg); border-color:#A7F3D0}
        .pill.tier-extreme{background:var(--tier-extreme-bg); color:var(--tier-extreme-fg); border-color:#F59E0B}

        /* Line items with images */
        .item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;border:1px solid #E5E7EB;border-radius:10px;padding:8px}
        .item-thumb{width:56px;height:56px;border-radius:8px;border:1px solid #E5E7EB;background:#F3F4F6;overflow:hidden}
        .item-thumb img{width:100%;height:100%;object-fit:cover}
        .item-title{font-weight:600}
        .item-sub{font-size:12px;color:#6B7280}

        /* Packages manager */
        .pkg-list{display:grid;gap:10px}
        .pkg{border:1px dashed var(--stroke);border-radius:10px;padding:10px}
        .pkg-head{display:flex;align-items:center;justify-content:space-between}
        .pkg-grid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px;margin-top:8px}
        .pkg .field input,.pkg .field select{height:34px}
        .pkg-actions{display:flex;gap:8px}
        .pkg-badge{font-size:12px;border:1px solid var(--stroke);border-radius:999px;padding:2px 8px;background:#fff}

        /* Media capture */
        .cam-wrap{display:grid;grid-template-columns:360px 1fr;gap:12px}
        video, canvas{width:100%;max-width:360px;border-radius:12px;border:1px solid var(--stroke);background:#000}
        .thumbs{display:flex;gap:8px;flex-wrap:wrap}
        .thumb{position:relative;width:96px;height:96px;border:1px solid #E5E7EB;border-radius:8px;overflow:hidden;background:#F3F4F6}
        .thumb img, .thumb video{width:100%;height:100%;object-fit:cover}
        .rm{position:absolute;right:4px;top:4px;background:#fff;border:1px solid #E5E7EB;border-radius:50%;width:22px;height:22px;line-height:20px;text-align:center;cursor:pointer}
        .cap-note{font-size:12px;color:#6B7280;text-align:center;margin-top:4px}
        .control{display:flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #E5E7EB;border-radius:8px;background:#F9FAFB}

        /* Spinner */
        .loading-overlay{position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; background:rgba(17,24,39,.55); backdrop-filter:blur(2px)}
        .loader-card{width:min(420px,90vw); background:#111827; color:#E5E7EB; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:18px; box-shadow:0 0 20px rgba(0,0,0,.35); display:grid; place-items:center; gap:10px; text-align:center}
        .spinner{width:96px;height:96px;border-radius:50%; border:8px solid rgba(255,255,255,.15); border-top:8px solid var(--accent); animation:spin 1.1s linear infinite; box-shadow:0 0 28px rgba(255,122,0,.45), 0 0 60px rgba(255,122,0,.25)}
        @keyframes spin{to{transform:rotate(360deg)}}
        .spin-text{font-size:14px;color:#e5e7eb}
        .spin-hint{font-size:12px;color:#a7abb3}

        @media (max-width: 960px){
          .grid.cols2{grid-template-columns:1fr}
          .cam-wrap{grid-template-columns:1fr}
          .pkg-grid{grid-template-columns:repeat(2,1fr)}
          video, canvas{max-width:100%}
        }
    </style>
</head>
<body>

<!-- Header -->
<div class="gm-topbar">
    <div class="inner">
        <div class="brand">
            <div class="logo">GM</div>
            <div>Orders — Picked / Packed</div>
        </div>
        <div class="gm-actions">
            <button id="btnBack" class="btn linklike" type="button">← Back</button>
            <a class="btn" href="/v1/home">⌂ Home</a>
        </div>
    </div>
</div>

<main>
    <!-- LIST -->
    <section id="listView" class="view active">
        <div class="row" style="margin-bottom:12px">
            <input id="search" type="search" placeholder="Search by order # or customer" style="flex:1;min-width:260px">
            <select id="statusFilter">
                <option value="">Status: Picked + Packed</option>
                <option value="Picked">Picked</option>
                <option value="Packed">Packed</option>
                <option value="DISPATCHED">Dispatched</option>
            </select>
            <button class="btn" id="refreshBtn">Refresh</button>
            <button class="btn" id="syncShopifyBtn"><i class="fas fa-cloud"></i> Sync Shopify</button>
        </div>

        <div class="card">
            <table id="ordersTable">
                <thead>
                <tr>
                    <th style="width:60px">S. No.</th>
                    <th style="width:120px">Order #</th>
                    <th>Customer</th>
                    <th style="width:160px">Date</th>
                    <th style="width:120px">Total</th>
                    <th style="width:160px">Courier (last)</th>
                    <th style="width:140px">Status</th>
                    <th style="width:80px">Items</th>
                    <th style="width:170px">Notes</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <!-- DETAIL -->
    <section id="detailView" class="view">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:12px">
            <div class="row" style="align-items:center">
                <button class="btn secondary" id="backBtn">← Back</button>
                <div style="font-weight:700;margin-left:8px" id="detailTitle">Order #—</div>
            </div>
            <div class="row">
                <button class="btn small" id="actionSave">Save Draft</button>
                <button class="btn small" id="actionLabel">Generate Label</button>
                <button class="btn small" id="actionPickup">Book Pickup</button>
                <button class="btn small" id="actionShip">Mark Shipped</button>
            </div>
        </div>

        <!-- Summary -->
        <div class="grid cols2" style="margin-bottom:12px">
            <div class="card" style="padding:12px">
                <div class="row" style="align-items:center">
                    <div class="field" style="min-width:200px">
                        <div class="hint">Customer</div>
                        <div id="customerName" style="font-weight:600"></div>
                        <div class="hint" id="customerEmail"></div>
                        <div class="hint" id="customerPhone"></div>
                        <div class="hint" id="customerAddress"></div>
                    </div>
                    <div class="field">
                        <div class="hint">Customer Tier</div>
                        <div id="customerTier" class="pill"></div>
                    </div>
                    <div class="field">
                        <div class="hint">Pincode Avg Delivery</div>
                        <div id="avgDelivery" class="pill">N/A</div>
                    </div>
                </div>
            </div>

            <div class="card" style="padding:12px">
                <div class="row">
                    <div class="pill" id="orderStatus"></div>
                    <div class="pill" id="orderGift"></div>
                    <div class="pill" id="orderNote"></div>
                    <div class="pill">Items: <b id="orderItems" style="margin-left:6px"></b></div>
                    <div class="pill">Total: <b id="orderTotal" style="margin-left:6px"></b></div>
                </div>
                <div class="row" style="margin-top:10px;align-items:center">
                    <label class="hint">Ship from warehouse</label>
                    <select id="warehouse">
                        <option value="Primary">Primary</option>
                        <option value="Secondary">Secondary</option>
                        <option value="Bangalore">Bangalore</option>
                        <option value="Delhi">Delhi</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Courier options -->
        <div class="card" style="padding:12px;margin-bottom:12px">
            <div style="font-weight:600;margin-bottom:6px">All Courier Options (cost + ETA)</div>
            <table id="courierTable">
                <thead>
                <tr>
                    <th>Courier</th><th>Service</th><th style="width:120px">ETA</th>
                    <th style="width:110px">Cost</th><th style="width:140px">COD</th><th style="width:120px">Select</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="courierHint" class="hint" style="margin-top:6px"></div>
        </div>

        <!-- Line items (with images) + assignment -->
        <div class="card" style="padding:12px;margin-bottom:12px">
            <div style="font-weight:600;margin-bottom:6px">Line Items (assign to packages)</div>
            <div id="lineItems"></div>
        </div>

        <!-- Packages & Tracking (MULTI-PACK) -->
        <div class="card" style="padding:12px;margin-bottom:12px">
            <div class="row" style="align-items:center;justify-content:space-between">
                <div style="font-weight:600">Packages & Tracking</div>
                <div class="pkg-actions">
                    <label class="hint" style="display:flex;align-items:center;gap:6px">
                        <input id="sameTrackingAll" type="checkbox"> Use same Tracking ID for all
                    </label>
                    <button id="addPackageBtn" class="btn small">+ Add Package</button>
                </div>
            </div>
            <div id="packagesWrap" class="pkg-list" style="margin-top:10px"></div>
        </div>

        <!-- Media: product photos -->
        <div class="card" style="padding:12px;margin-bottom:12px">
            <div style="font-weight:600;margin-bottom:6px">Product Images (Webcam Only)</div>
            <div class="cam-wrap">
                <div>
                    <video id="camPhoto" playsinline autoplay muted></video>
                    <canvas id="photoCanvas" hidden></canvas>
                    <div class="row" style="margin-top:8px">
                        <button class="btn small" id="startPhotoCam">Start Camera</button>
                        <button class="btn small" id="stopPhotoCam" disabled>Stop</button>
                        <div class="control" id="zoomCtlPhoto" hidden>
                            <span class="hint">Zoom</span><input type="range" id="zoomPhoto" min="1" max="1" step="0.1" value="1">
                        </div>
                        <div class="control">
                            <span class="hint">Quality</span>
                            <select id="photoQuality">
                                <option value="0.92" selected>High</option>
                                <option value="0.98">Very High</option>
                                <option value="0.80">Medium</option>
                            </select>
                        </div>
                        <button class="btn small" id="takePhoto" disabled>Take Photo</button>
                        <select id="photoTarget" class="btn small" style="background:#fff;color:#111;border:1px solid #E5E7EB"></select>
                    </div>
                    <div class="hint" id="photoMsg">Use HTTPS/localhost and allow camera.</div>
                </div>
                <div>
                    <div class="hint" style="margin-bottom:6px">Captured Photos</div>
                    <div id="photoGallery" class="thumbs"></div>
                </div>
            </div>
        </div>

        <!-- Packaging video + dims -->
        <div class="grid cols2" style="margin-bottom:12px">
            <div class="card" style="padding:12px">
                <div style="font-weight:600;margin-bottom:6px">Final Packaging — Video Capture</div>
                <div class="cam-wrap" style="grid-template-columns:360px 1fr">
                    <div>
                        <video id="camVideo" playsinline autoplay muted></video>
                        <div class="row" style="margin-top:8px">
                            <button class="btn small" id="startVideoCam">Start Camera</button>
                            <button class="btn small" id="stopVideoCam" disabled>Stop</button>
                            <button class="btn small" id="recStart" disabled>Start Rec</button>
                            <button class="btn small" id="recStop" disabled>Stop Rec</button>
                        </div>
                        <div class="hint" id="videoMsg">Recording saves as WebM in most browsers.</div>
                    </div>
                    <div>
                        <div class="hint" style="margin-bottom:6px">Captured Packaging Videos</div>
                        <div id="videoGallery" class="thumbs"></div>
                    </div>
                </div>
            </div>

            <div class="card" style="padding:12px">
                <div style="font-weight:600;margin-bottom:6px">Packaging Dimensions</div>
                <div class="grid cols4">
                    <!-- start with EMPTY values; placeholders guide the user -->
                    <div class="field"><label class="hint">Length (cm)</label><input id="lenCm" type="number" min="0" placeholder="e.g., 20"></div>
                    <div class="field"><label class="hint">Width (cm)</label><input id="widCm" type="number" min="0" placeholder="e.g., 15"></div>
                    <div class="field"><label class="hint">Height (cm)</label><input id="heiCm" type="number" min="0" placeholder="e.g., 10"></div>
                    <div class="field"><label class="hint">Dead wt (kg)</label><input id="deadWt" type="number" step="0.01" min="0" placeholder="e.g., 0.80"></div>
                </div>
                <div class="row" style="margin-top:8px">
                    <div>Volumetric weight: <b id="volWt">—</b> kg</div>
                    <div class="hint">Vol wt = (L×W×H)/5000</div>
                </div>
            </div>
        </div>

        <!-- Contact (mapped from order details automatically) -->
        <div class="card" style="padding:12px;margin-bottom:12px">
            <div style="font-weight:600;margin-bottom:6px">Contact & Address</div>
            <div class="grid cols3">
                <div class="field"><label class="hint" for="phoneInput">Phone (India)</label><input id="phoneInput" placeholder="10 digits starting 6-9"></div>
                <div class="field"><label class="hint" for="addressInput">Address</label><input id="addressInput" placeholder="Min 9 characters"></div>
                <div class="field"><label class="hint" for="pincodeInput">Pincode</label><input id="pincodeInput" placeholder="6-digit"></div>
            </div>
            <div class="row" style="margin-top:8px">
                <span id="phoneMsg" class="hint"></span>
                <span id="addrMsg" class="hint" style="margin-left:16px"></span>
                <span id="pinMsg" class="hint" style="margin-left:16px"></span>
                <button class="btn secondary right" id="validateBtn">Validate</button>
            </div>
        </div>
    </section>
</main>

<!-- Spinner -->
<div id="syncOverlay" class="loading-overlay" aria-hidden="true">
    <div class="loader-card" role="dialog" aria-live="polite" aria-label="Syncing Shopify">
        <div class="spinner" aria-hidden="true"></div>
        <div id="spinnerText" class="spin-text">Connecting to Shopify…</div>
        <div class="spin-hint">You can keep this open — we’ll rotate tasks & jokes ✨</div>
        <button id="overlayHide" class="btn small secondary" style="margin-top:6px">Hide</button>
    </div>
</div>

<!-- Inject server-fetched orders (if any) -->
<script th:inline="javascript">
    /*<![CDATA[*/
    window.FETCHED_ORDERS = /*[[${fetchedOrders}]]*/ [];
    /*]]>*/
</script>

<script>
    // Back/Home
    document.getElementById('btnBack').addEventListener('click', ()=>{
      if (history.length > 1) { try{ history.back(); return; }catch(e){} }
      location.href = '/v1/home';
    });

    /* Dummy fallback */
    const DUMMY = [{
      id:"#100045", status:"Packed", date:"2025-08-10", total:1899, courier:"Delhivery",
      note:"Please call before delivery", gift:false,
      customer:{ name:"Deepthi Rao", email:"deepthi@example.com", phone:"+91 9876543210",
        address:"403, Sunrise Apts, Bandra West, Mumbai 400050", pincode:"400050" },
      items:[
        {sku:"ZORO-01", name:"Zoro Figure", quantity:1, weight:0.45, imageUrl:"https://picsum.photos/seed/z1/200/200"},
        {sku:"LUFF-02", name:"Luffy Keychain", quantity:2, weight:0.08, imageUrl:"https://picsum.photos/seed/z2/200/200"}
      ],
      pastOrders: 2
    }];

    // Fallback static options
    const COURIERS_FALLBACK = [
      {name:"BlueDart", service:"Priority", eta:"1-3 days", cost:160, cod:true},
      {name:"Delhivery", service:"Express", eta:"2-4 days", cost:135, cod:true},
      {name:"Xpressbees", service:"Surface", eta:"4-7 days", cost:99, cod:false},
      {name:"Ecom Express", service:"Air", eta:"2-3 days", cost:149, cod:true}
    ];
    const PINCODE_HISTORY = { "400050":[2,3,3,2], "411001":[4,5], "560001":[3] };

    const COURIER_CHOICES = [
      "Delhivery","Xpressbees","Bluedart","FedEx","PostOffice","Self Delivery","Skyking","Trackon"
    ];

    function imageFromLineItem(li){
      try {
        return li?.variant?.image?.url
            || li?.variant?.product?.featuredImage?.url
            || (li?.variant?.product?.images?.nodes?.[0]?.url)
            || li?.imageUrl
            || '';
      } catch(e){ return ''; }
    }

    function normalizeFromApi(list){
      if (!Array.isArray(list)) return [];
      return list.map(o=>{
        const cust = o.customer || {};
        const ship = o.shipping_address || {};
        const first = (cust.firstName || cust.displayName || '').trim();
        const last  = (cust.lastName || '').trim();
        const fullName = (first || (cust.email||'').split('@')[0] || '—') + (last ? (' ' + last) : '');

        let items = [];
        if (Array.isArray(o.items)) {
          items = o.items.map(it => ({
            sku: it.sku || it.SKU || '',
            name: it.name || '',
            quantity: it.quantity || it.qty || 0,
            weight: it.weight || 0,
            imageUrl: it.imageUrl || imageFromLineItem(it)
          }));
        } else if (o.fulfillmentOrders?.nodes?.length) {
          o.fulfillmentOrders.nodes.forEach(fo=>{
            fo.lineItems?.nodes?.forEach(n=>{
              const li = n.lineItem || n;
              items.push({
                sku: li?.sku || '',
                name: li?.name || '',
                quantity: li?.quantity || n?.remainingQuantity || 0,
                weight: 0,
                imageUrl: imageFromLineItem(li)
              });
            });
          });
        }

        return {
          id: o.name || o.id || '—',
          status: o.customStatus || o.fulfillment_status || 'Picked',
          date: o.created_at || o.processedAt || '',
          total: Number(o.total_price || o.current_total_price || 0),
          courier: (o.courierCompany && o.courierCompany.name) ? o.courierCompany.name : '-',
          note: o.note || '',
          gift: false,
          customer: {
            name: fullName,
            email: cust.email || '',
            phone: cust.phone || o.phone || '',
            address: ship.address1 ? `${ship.address1}, ${ship.city||''}`.replace(/, $/,'') : '',
            pincode: o.pincode || ship.zip || ''
          },
          items,
          pastOrders: cust.numberOfOrders || 1
        };
      });
    }

    const FROM_API = (Array.isArray(window.FETCHED_ORDERS) && window.FETCHED_ORDERS.length)
      ? normalizeFromApi(window.FETCHED_ORDERS) : [];
    let ORDERS = (FROM_API.length ? FROM_API : DUMMY);

    const listView = document.getElementById("listView");
    const detailView = document.getElementById("detailView");
    const tbody = document.querySelector("#ordersTable tbody");
    const search = document.getElementById("search");
    const statusFilter = document.getElementById("statusFilter");
    document.getElementById("refreshBtn").addEventListener("click", renderList);

    function classifyCustomerTier(n){
      if(n<=1) return {label:"New", cls:"tier-new"};
      if(n===2) return {label:"Good (delivered order)", cls:"tier-good"};
      if(n<=5) return {label:"Premium", cls:"tier-premium"};
      return {label:"Extremely Premium", cls:"tier-extreme"};
    }
    function avgDaysForPincode(pin){ const arr = PINCODE_HISTORY[pin]||[]; if(arr.length<2) return null; const sum = arr.reduce((a,b)=>a+b,0); return (sum/arr.length).toFixed(1)+" days"; }

    function tsFromAny(d){
      if(!d) return 0;
      if (d instanceof Date) return d.getTime() || 0;
      const t = Date.parse(d);
      if (!isNaN(t)) return t;
      const alt = Date.parse(String(d).replace(' ', 'T'));
      return isNaN(alt) ? 0 : alt;
    }

    function renderList(){
      const q=(search.value||"").toLowerCase(), f=statusFilter.value;
      const rows = ORDERS
        .filter(o => ["DISPATCHED","Picked","Packed"].includes(o.status||''))
        .filter(o => !f || o.status===f)
        .filter(o => !q || ((o.id||'')+(o.customer?.name||'')).toLowerCase().includes(q))
        .sort((a,b)=>{
          const tb = tsFromAny(b.date);
          const ta = tsFromAny(a.date);
          if (tb!==ta) return tb - ta;
          return String(b.id).localeCompare(String(a.id));
        });

      tbody.innerHTML = rows.map((o, i) => `
        <tr data-id="${o.id}">
          <td>${i + 1}</td>
          <td>${o.id}</td>
          <td>${o.customer?.name || '—'}</td>
          <td>${o.date || ''}</td>
          <td>Rs ${Number(o.total||0).toLocaleString('en-IN')}</td>
          <td>${o.courier||"-"}</td>
          <td><span class="status">${o.status||''}</span></td>
          <td>${(o.items||[]).reduce((n,i)=>n+(i.quantity||0),0)}</td>
          <td>${o.note ? '<span class="tag">Note</span>' : ''}</td>
        </tr>
      `).join("");
    }
    renderList();

    tbody.addEventListener("click", (e)=>{
      const tr = e.target.closest("tr"); if(!tr) return;
      const order = ORDERS.find(o=>String(o.id)===String(tr.dataset.id));
      if (order) openDetail(order);
    });

    const detailTitle = document.getElementById("detailTitle");
    const customerName = document.getElementById("customerName");
    const customerEmail = document.getElementById("customerEmail");
    const customerPhone = document.getElementById("customerPhone");
    const customerAddress = document.getElementById("customerAddress");
    const customerTier = document.getElementById("customerTier");
    const orderStatus = document.getElementById("orderStatus");
    const orderGift = document.getElementById("orderGift");
    const orderNote = document.getElementById("orderNote");
    const orderItems = document.getElementById("orderItems");
    const orderTotal = document.getElementById("orderTotal");
    const avgDelivery = document.getElementById("avgDelivery");
    const courierTbody = document.querySelector("#courierTable tbody");
    const courierHint = document.getElementById("courierHint");
    const lineItemsDiv = document.getElementById("lineItems");
    const packagesWrap = document.getElementById("packagesWrap");
    const sameTrackingAll = document.getElementById("sameTrackingAll");

    const phoneInput = document.getElementById("phoneInput");
    const addressInput = document.getElementById("addressInput");
    const pincodeInput = document.getElementById("pincodeInput");
    const phoneMsg = document.getElementById("phoneMsg");
    const addrMsg = document.getElementById("addrMsg");
    const pinMsg = document.getElementById("pinMsg");

    const lenInput = document.getElementById("lenCm");
    const widInput = document.getElementById("widCm");
    const heiInput = document.getElementById("heiCm");
    const deadWtInput = document.getElementById("deadWt");
    const volWtEl = document.getElementById("volWt");
    const warehouseSel = document.getElementById("warehouse");

    document.getElementById("backBtn").addEventListener("click", ()=>{
      detailView.classList.remove("active");
      listView.classList.add("active");
    });

    let PACKAGES = [];
    let CURRENT_ORDER = null;

    function newPackage(idx){
      return {
        id: crypto.randomUUID(),
        name: `Package ${idx+1}`,
        courier: '',
        trackingId: '',
        length: '', width: '', height: '', weight: ''
      };
    }

    function optionHtml(val, current){
      const sel = (String(val).toLowerCase() === String(current||'').toLowerCase()) ? ' selected' : '';
      return `<option value="${val}"${sel}>${val}</option>`;
    }

    function renderPackages(){
      packagesWrap.innerHTML = PACKAGES.map((p,idx)=>`
        <div class="pkg" data-id="${p.id}">
          <div class="pkg-head">
            <div class="pkg-badge">${p.name}</div>
            <div class="pkg-actions">
              ${idx>0 ? `<button class="btn small secondary" data-act="copyTrack" data-id="${p.id}">Same tracking as previous</button>`:''}
              <button class="btn small secondary" data-act="remove" data-id="${p.id}">Remove</button>
            </div>
          </div>
          <div class="pkg-grid">
            <div class="field">
              <label class="hint">Courier</label>
              <select data-field="courier">
                <option value="">Select courier</option>
                ${COURIER_CHOICES.map(c => optionHtml(c, p.courier)).join('')}
              </select>
            </div>
            <div class="field"><label class="hint">Tracking ID</label><input data-field="trackingId" value="${p.trackingId||''}" placeholder="AWB / Tracking"></div>
            <div class="field"><label class="hint">Length (cm)</label><input type="number" min="0" data-field="length" value="${p.length||''}"></div>
            <div class="field"><label class="hint">Width (cm)</label><input type="number" min="0" data-field="width" value="${p.width||''}"></div>
            <div class="field"><label class="hint">Height (cm)</label><input type="number" min="0" data-field="height" value="${p.height||''}"></div>
            <div class="field"><label class="hint">Weight (kg)</label><input type="number" step="0.01" min="0" data-field="weight" value="${p.weight||''}"></div>
          </div>
        </div>
      `).join("");

      packagesWrap.querySelectorAll('.pkg input, .pkg select').forEach(inp=>{
        inp.addEventListener('input', (e)=>{
          const wrap = e.target.closest('.pkg');
          const id = wrap.dataset.id;
          const f = e.target.dataset.field;
          const pkg = PACKAGES.find(x=>x.id===id);
          if (pkg){ pkg[f] = e.target.value; }
          if (sameTrackingAll.checked && f==='trackingId'){
            PACKAGES.forEach(x=>x.trackingId = pkg.trackingId);
            renderPackages();
          }
        });
        inp.addEventListener('change', (e)=>{
          const wrap = e.target.closest('.pkg');
          const pkg = PACKAGES.find(x=>x.id===wrap.dataset.id);
          if (pkg && e.target.dataset.field==='courier'){ pkg.courier = e.target.value; }
        });
      });
    }

    document.getElementById('addPackageBtn').addEventListener('click', ()=>{
      PACKAGES.push(newPackage(PACKAGES.length));
      renderPackages();
    });

    sameTrackingAll.addEventListener('change', ()=>{
      if (sameTrackingAll.checked){
        const first = PACKAGES[0]?.trackingId || '';
        PACKAGES.forEach(p=>p.trackingId = first);
        renderPackages();
      }
    });

    function openDetail(o){
      CURRENT_ORDER = o;
      listView.classList.remove("active");
      detailView.classList.add("active");

      detailTitle.textContent = `${o.id} — ${o.customer?.name || '—'}`;
      customerName.textContent = o.customer?.name || '—';
      customerEmail.textContent = o.customer?.email || '';
      customerPhone.textContent = o.customer?.phone || '';
      customerAddress.textContent = `${o.customer?.address || ''}${o.customer?.pincode ? ' (Pin: '+o.customer.pincode+')' : ''}`;

      const tier = classifyCustomerTier(o.pastOrders||1);
      customerTier.textContent = tier.label;
      customerTier.className = `pill ${tier.cls}`;

      orderStatus.textContent = o.status || '';
      orderGift.textContent = o.gift ? "Gift wrap: Yes" : "Gift wrap: No";
      orderNote.textContent = o.note ? "Note present" : "No note";
      orderItems.textContent = (o.items||[]).reduce((n,i)=>n+(i.quantity||0),0);
      orderTotal.textContent = `Rs ${Number(o.total||0).toLocaleString('en-IN')}`;
      avgDelivery.textContent = avgDaysForPincode(o.customer?.pincode||'') || "N/A";

      phoneInput.value   = o.customer?.phone   || '';
      addressInput.value = o.customer?.address || '';
      pincodeInput.value = o.customer?.pincode || '';
      phoneMsg.textContent = '';
      addrMsg.textContent  = '';
      pinMsg.textContent   = '';

      const items = (o.items && o.items.length) ? o.items : [];
      lineItemsDiv.innerHTML = items.map((it)=>`
        <div class="item" data-sku="${it.sku||''}">
          <div class="item-thumb">${(it.imageUrl)?`<img src="${it.imageUrl}" alt="${(it.name||'Item')}" loading="lazy">`:'</div>'}
          </div>
          <div>
            <div class="item-title">${it.name||'(Unnamed item)'}</div>
            <div class="item-sub">SKU: ${it.sku||'-'} • Qty: ${it.quantity||0} • ${it.weight||0} kg</div>
          </div>
          <div>
            <select class="assignSel">
              ${PACKAGES.map((p,i)=>`<option value="${i}">${p.name}</option>`).join('')}
            </select>
          </div>
        </div>
      `).join("") || '<div class="hint">No items present for this order.</div>';

      PACKAGES = [newPackage(0)];
      renderPackages();

      const photoTarget = document.getElementById("photoTarget");
      photoTarget.innerHTML = items.map(it=>`<option value="item:${it.sku||'NA'}">Item: ${it.name||it.sku||'NA'}</option>`).join("")
        + `<option value="item:OTHER">Item: Other</option>`;

      renderCourierRows([], 'Add package dimensions (L, W, H) and Dead weight to see courier quotes.');
    }

    function selectCourier(name, svc, cost){ alert(`Selected: ${name} – ${svc} (Rs ${cost})`); }

    ["lenCm","widCm","heiCm"].forEach(id=>document.getElementById(id)?.addEventListener("input", ()=>{
      const L=+lenInput.value||0, W=+widInput.value||0, H=+heiInput.value||0;
      if (L>0 && W>0 && H>0){
        volWtEl.textContent = ((L*W*H)/5000).toFixed(2);
      } else {
        volWtEl.textContent = '—';
      }
      debouncedFetchCourierOptions();
    }));
    deadWtInput.addEventListener("input", debouncedFetchCourierOptions);
    pincodeInput.addEventListener("input", debouncedFetchCourierOptions);
    warehouseSel.addEventListener("change", debouncedFetchCourierOptions);

    document.getElementById("validateBtn").addEventListener("click", ()=>{
      const ph = (phoneInput.value||'').trim(), ad = (addressInput.value||'').trim(), pc = (pincodeInput.value||'').trim();
      const validPhone = /^[6-9]\d{9}$/.test(ph);
      const validAddr  = ad.replace(/\s/g,'').length>8;
      const validPin   = /^\d{6}$/.test(pc);
      phoneMsg.textContent = validPhone ? "Phone OK" : "Invalid Indian mobile (10 digits, starts 6-9)";
      phoneMsg.className = validPhone ? "ok" : "error";
      addrMsg.textContent = validAddr ? "Address OK" : "Address must be > 8 characters";
      addrMsg.className = validAddr ? "ok" : "error";
      pinMsg.textContent = validPin ? "Pincode OK" : "Invalid pincode (6 digits)";
      pinMsg.className = validPin ? "ok" : "error";
      document.getElementById("avgDelivery").textContent = avgDaysForPincode(pc) || "N/A";
    });

    /* Webcam: Photos */
    const videoPhoto = document.getElementById("camPhoto");
    const photoCanvas = document.getElementById("photoCanvas");
    const startPhotoCam = document.getElementById("startPhotoCam");
    const stopPhotoCam = document.getElementById("stopPhotoCam");
    const zoomCtlPhoto = document.getElementById("zoomCtlPhoto");
    const zoomPhoto = document.getElementById("zoomPhoto");
    const takePhotoBtn = document.getElementById("takePhoto");
    const photoMsg = document.getElementById("photoMsg");
    const photoGallery = document.getElementById("photoGallery");
    const photoTargetSel = document.getElementById("photoTarget");
    let photoStream=null, photoTrack=null; const PHOTO_CAPTURES=[];

    startPhotoCam.addEventListener("click", async ()=>{
      try{
        if (photoStream) photoStream.getTracks().forEach(t=>t.stop());
        photoStream = await navigator.mediaDevices.getUserMedia({
          video: { width:{ideal:4032}, height:{ideal:3024}, focusMode:"continuous", facingMode:{ideal:"environment"} }, audio:false
        });
        videoPhoto.srcObject = photoStream;
        photoTrack = photoStream.getVideoTracks()[0];
        takePhotoBtn.disabled = false; stopPhotoCam.disabled = false; startPhotoCam.disabled = true;
        const caps = photoTrack.getCapabilities ? photoTrack.getCapabilities() : {};
        if (caps.zoom){
          zoomPhoto.min=caps.zoom.min||1; zoomPhoto.max=caps.zoom.max||1; zoomPhoto.step=caps.zoom.step||0.1;
          zoomPhoto.value = photoTrack.getSettings().zoom || zoomPhoto.min; zoomCtlPhoto.hidden=false;
        } else { zoomCtlPhoto.hidden=true; }
        photoMsg.textContent = "Camera started."; photoMsg.style.color = "#065F46";
      }catch(e){ photoMsg.textContent = "Camera error: "+e.message+" (use HTTPS/localhost and allow permissions)"; photoMsg.style.color = "#B91C1C"; }
    });
    stopPhotoCam.addEventListener("click", ()=>{ if(photoStream) photoStream.getTracks().forEach(t=>t.stop()); videoPhoto.srcObject=null; photoStream=null; photoTrack=null; takePhotoBtn.disabled=true; startPhotoCam.disabled=false; stopPhotoCam.disabled=true; });
    zoomPhoto.addEventListener("input", async ()=>{ if (!photoTrack) return; try{ await photoTrack.applyConstraints({ advanced:[{ zoom: parseFloat(zoomPhoto.value) }] }); }catch(e){} });
    takePhotoBtn.addEventListener("click", ()=>{
      if (!photoTrack) return;
      const s = photoTrack.getSettings ? photoTrack.getSettings() : {};
      const w = s.width || 1920, h = s.height || 1080;
      photoCanvas.width = w; photoCanvas.height = h;
      const ctx = photoCanvas.getContext("2d", { alpha:false });
      ctx.drawImage(videoPhoto, 0, 0, w, h);
      const q = parseFloat(document.getElementById("photoQuality").value || "0.92");
      photoCanvas.toBlob(blob=>{
        if(!blob) return;
        const url = URL.createObjectURL(blob);
        PHOTO_CAPTURES.push({blob, url, target: photoTargetSel.value});
        renderPhotoThumbs();
      }, "image/jpeg", q);
    });

    function renderPhotoThumbs(){
      photoGallery.innerHTML = "";
      PHOTO_CAPTURES.forEach((c, idx)=>{
        const wrap = document.createElement("div"); wrap.style.display="grid"; gap="4px";
        const cell = document.createElement("div"); cell.className="thumb";
        const img = document.createElement("img"); img.src=c.url; cell.appendChild(img);
        const rm = document.createElement("div"); rm.className="rm"; rm.textContent="×";
        rm.onclick=()=>{ URL.revokeObjectURL(c.url); PHOTO_CAPTURES.splice(idx,1); renderPhotoThumbs(); };
        cell.appendChild(rm);
        const note = document.createElement("div"); note.className="cap-note";
        note.textContent = c.target?.startsWith("item:") ? c.target.replace("item:","Item: ") : "Packaging";
        wrap.appendChild(cell); wrap.appendChild(note); photoGallery.appendChild(wrap);
      });
    }

    /* Webcam: Video */
    const camVideo = document.getElementById("camVideo");
    const startVideoCam = document.getElementById("startVideoCam");
    const stopVideoCam  = document.getElementById("stopVideoCam");
    const recStart      = document.getElementById("recStart");
    const recStop       = document.getElementById("recStop");
    const videoMsg      = document.getElementById("videoMsg");
    const videoGallery  = document.getElementById("videoGallery");
    let vidStream=null, vidRecorder=null, vidChunks=[]; const VIDEO_CAPTURES=[];

    startVideoCam.addEventListener("click", async ()=>{
      try{
        if (vidStream) vidStream.getTracks().forEach(t=>t.stop());
        vidStream = await navigator.mediaDevices.getUserMedia({ video:{width:{ideal:1920},height:{ideal:1080},facingMode:{ideal:"environment"}}, audio:false });
        camVideo.srcObject = vidStream;
        startVideoCam.disabled = true; stopVideoCam.disabled = false; recStart.disabled=false; recStop.disabled=true;
        videoMsg.textContent = "Video camera ready."; videoMsg.style.color = "#065F46";
      }catch(e){ videoMsg.textContent = "Camera error: "+e.message; videoMsg.style.color = "#B91C1C"; }
    });
    stopVideoCam.addEventListener("click", ()=>{ if (vidStream) vidStream.getTracks().forEach(t=>t.stop()); camVideo.srcObject=null; vidStream=null; startVideoCam.disabled=false; stopVideoCam.disabled=true; recStart.disabled=true; recStop.disabled=true; });
    recStart.addEventListener("click", ()=>{
      if (!vidStream) return; vidChunks=[];
      const mime = MediaRecorder.isTypeSupported("video/webm;codecs=vp9") ? "video/webm;codecs=vp9" :
                   (MediaRecorder.isTypeSupported("video/webm;codecs=vp8") ? "video/webm;codecs=vp8" : "video/webm");
      vidRecorder = new MediaRecorder(vidStream, { mimeType: mime, videoBitsPerSecond: 4_000_000 });
      vidRecorder.ondataavailable = e => { if (e.data && e.data.size) vidChunks.push(e.data); };
      vidRecorder.onstop = ()=>{ const blob = new Blob(vidChunks, { type: vidRecorder.mimeType || "video/webm" }); const url = URL.createObjectURL(blob); VIDEO_CAPTURES.push({ blob, url }); renderVideoThumbs(); };
      vidRecorder.start(); recStart.disabled=true; recStop.disabled=false; videoMsg.textContent="Recording… click Stop Rec";
    });
    recStop.addEventListener("click", ()=>{ if (vidRecorder && vidRecorder.state!=="inactive") vidRecorder.stop(); recStart.disabled=false; recStop.disabled=true; });
    function renderVideoThumbs(){
      videoGallery.innerHTML = "";
      VIDEO_CAPTURES.forEach((v, idx)=>{
        const wrap = document.createElement("div"); wrap.style.display="grid"; gap="4px";
        const cell = document.createElement("div"); cell.className="thumb";
        const vid = document.createElement("video"); vid.src=v.url; vid.controls=true; vid.muted=true;
        cell.appendChild(vid);
        const rm = document.createElement("div"); rm.className="rm"; rm.textContent="×";
        rm.onclick=()=>{ URL.revokeObjectURL(v.url); VIDEO_CAPTURES.splice(idx,1); renderVideoThumbs(); };
        cell.appendChild(rm);
        const note = document.createElement("div"); note.className="cap-note"; note.textContent="Packaging";
        wrap.appendChild(cell); wrap.appendChild(note); videoGallery.appendChild(wrap);
      });
    }

    const overlay = document.getElementById("syncOverlay");
    const overlayHideBtn = document.getElementById("overlayHide");
    const spinnerText = document.getElementById("spinnerText");
    const SPINNER_LINES = [
      "Connecting to Shopify…","Fetching orders from the multiverse…","Polishing kunai knives… just in case.",
      "Counting Zoros (he got lost again)…","Breathing forms loading…","Summoning ramen bowls for stamina…",
      "Calling courier spirits…","Bankai prep complete. Parsing payload…"
    ];
    let spinTimer = null;
    function showOverlay(){ overlay.style.display="flex"; overlay.setAttribute("aria-hidden","false"); let i=0; spinnerText.textContent=SPINNER_LINES[0]; clearInterval(spinTimer); spinTimer=setInterval(()=>{ i++; spinnerText.textContent = SPINNER_LINES[i % SPINNER_LINES.length]; }, 2500); }
    function hideOverlay(){ overlay.style.display="none"; overlay.setAttribute("aria-hidden","true"); clearInterval(spinTimer); }
    overlayHideBtn.addEventListener("click", hideOverlay);

    ["actionSave","actionLabel","actionPickup","actionShip"].forEach(id=>{
      document.getElementById(id).addEventListener("click", ()=>{
        const payload = {
          orderId: detailTitle.textContent.split(' — ')[0],
          packages: PACKAGES,
          photosCount: PHOTO_CAPTURES.length,
          videosCount: VIDEO_CAPTURES.length
        };
        alert(`${id.replace('action','Action: ')}\nPackages: ${payload.packages.length}\nPhotos: ${payload.photosCount}\nVideos: ${payload.videosCount}`);
      });
    });

    document.getElementById("syncShopifyBtn").addEventListener("click", async () => {
      showOverlay();
      try {
        const response = await fetch("/v1/order/bookshopify/fetchorders", { method: "GET" });
        if (response.ok) {
          const message = await response.text();
          hideOverlay();
          alert(`Success: ${message}`);
          renderList();
        } else {
          const error = await response.text();
          hideOverlay();
          alert(`Error: ${error}`);
        }
      } catch (err) {
        hideOverlay();
        alert(`Failed to sync orders: ${err.message}`);
      }
    });

    /* ------------------------
       Courier options (AJAX)
       ------------------------ */

    // UPDATED: Build payload with required fields nested under payload.dimension
    function currentShipmentPayload(){
      const L = +lenInput.value || 0;
      const W = +widInput.value || 0;
      const H = +heiInput.value || 0;
      const dead = +deadWtInput.value || 0;
      const vol = (L>0 && W>0 && H>0) ? +((L*W*H)/5000).toFixed(2) : 0;
      const chargeable = Math.max(dead, vol);
      volWtEl.textContent = (vol>0) ? vol.toFixed(2) : '—';

      return {
        // keep non-dimension fields at root
        delivery_pincode: (pincodeInput.value || CURRENT_ORDER?.customer?.pincode || '').trim(),
        origin: warehouseSel.value || 'Primary',
        order_id: CURRENT_ORDER?.id || '',
        order_amount: Number(CURRENT_ORDER?.total || 0),
        items_count: (CURRENT_ORDER?.items||[]).reduce((n,i)=>n+(i.quantity||0),0),

        // nest all required fields under 'dimension'
        dimension: {
          length_cm: L,
          width_cm: W,
          height_cm: H,
          dead_weight_kg: +(dead||0).toFixed(3),
          volumetric_weight_kg: +(vol||0).toFixed(3),
          chargeable_weight_kg: +(chargeable||0).toFixed(3),
        }
      };
    }

    function renderCourierRows(list, hintText=''){
      const rows = (list||[]).map(c=>`
        <tr>
          <td>${c.name||'-'}</td>
          <td>${c.service||'-'}</td>
          <td>${c.etaText || c.eta || (c.etaDays? (c.etaDays+' days') : '-')}</td>
          <td>Rs ${Number(c.cost || 0)}</td>
          <td>${(c.codAvailable ?? c.cod) ? 'Yes' : 'No'}</td>
          <td><button class="btn small" onclick="selectCourier('${(c.name||'').replace(/'/g,"\\'")}','${(c.service||'').replace(/'/g,"\\'")}',${Number(c.cost||0)})">Select</button></td>
        </tr>
      `).join("");

      courierTbody.innerHTML = rows || `<tr><td colspan="6" class="hint">No options returned.</td></tr>`;
      courierHint.textContent = hintText || '';
    }

    function showCourierLoading(){
      courierTbody.innerHTML = `<tr><td colspan="6">Fetching courier options…</td></tr>`;
      courierHint.textContent = '';
    }

    // UPDATED: Use payload.dimension.* where applicable
    async function fetchCourierOptions(){
      const payload = currentShipmentPayload();

      const dimsReady = payload.dimension.length_cm>0 && payload.dimension.width_cm>0 &&
                        payload.dimension.height_cm>0 && payload.dimension.dead_weight_kg>0;
      const pinReady  = payload.delivery_pincode && /^\d{6}$/.test(payload.delivery_pincode);

      if (!dimsReady){
        renderCourierRows([], 'Add package dimensions and dead weight to fetch live quotes.');
        return;
      }
      if (!pinReady){
        renderCourierRows([], 'Enter a valid 6-digit pincode to fetch live quotes.');
        return;
      }

      showCourierLoading();
      try{
        const res = await fetch('/v1/courier/quotes', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        if (!res.ok){
          const errTxt = await res.text().catch(()=>res.statusText);
          renderCourierRows(COURIERS_FALLBACK, `Live quotes failed (${res.status}). Showing fallback. ${errTxt||''}`);
          return;
        }

        const data = await res.json();
        const list = Array.isArray(data) ? data
                  : Array.isArray(data?.quotes) ? data.quotes
                  : [];

        if (!list.length){
          renderCourierRows(COURIERS_FALLBACK, 'No live quotes available. Showing fallback.');
          return;
        }

        list.sort((a,b)=> (Number(a.cost||Infinity) - Number(b.cost||Infinity)));
        renderCourierRows(
          list,
          `Quotes for ${payload.dimension.chargeable_weight_kg} kg (chargeable), ${payload.dimension.length_cm}×${payload.dimension.width_cm}×${payload.dimension.height_cm} cm.`
        );
      }catch(err){
        renderCourierRows(COURIERS_FALLBACK, `Error fetching quotes. Showing fallback. ${err.message||err}`);
      }
    }

    // Debounce
    let fetchTimer=null;
    function debouncedFetchCourierOptions(){
      clearTimeout(fetchTimer);
      fetchTimer = setTimeout(fetchCourierOptions, 450);
    }
</script>
</body>
</html>
