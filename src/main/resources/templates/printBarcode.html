<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Print label Inventory — Geekmonkey</title>

    <!-- Brand Spinner (kept from your stack) -->
    <link rel="stylesheet" th:href="@{../../assets/css/spinner.css}" />

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <!-- Your utilities -->
    <script th:src="@{../../../assets/scripts/inventory-utils.js}"></script>

    <style>
        :root{
          --bg:#F9FAFB; --card:#FFFFFF; --stroke:#E5E7EB; --text:#111827; --muted:#6B7280;
          --accent:#FF7A00; --accent-ink:#9A4D00; --radius:14px;
        }

        html, body { height: 100%; background: var(--bg); color: var(--text); }

        /* ===== Header (Orange/White theme) ===== */
        .gm-navbar { background: var(--accent); border-bottom:1px solid var(--accent-ink); }
        .gm-brand { font-weight:700; letter-spacing:.2px; color: #fff; }
        .gm-icon-btn { border-radius:12px; border:1px solid #fff; background: transparent; color:#fff; }
        .gm-icon-btn:hover{ background: #fff; color: var(--accent); border-color:#fff; }
        .gm-accent { color: var(--accent); }

        /* ===== Layout ===== */
        .gm-container { max-width: 1000px; margin: 0 auto; padding: 24px; }
        .gm-card { background: var(--card); border:1px solid var(--stroke); border-radius: var(--radius); }
        .gm-card-header { border-bottom:1px solid var(--stroke); }

        /* Inputs */
        .form-control:focus { box-shadow: none; border-color: #FFC08F; }

        /* Buttons */
        .btn-accent { background: var(--accent); color:#fff; border:none; border-radius:12px; }
        .btn-accent:hover{ background:#FF8F29; color:#fff; }

        /* Helpers */
        .gm-muted { color: var(--muted); }
        .gm-img { max-width: 220px; border-radius:12px; border:1px solid var(--stroke); }

        /* Modal tweaks */
        .modal-content { border-radius: 16px; }

        /* Spacer for fixed header */
        main { padding-top: 84px; }

        /* List group refined */
        .list-group-item { cursor:pointer; }
        .list-group-item:hover { background:#FFF7EF; }

        /* Compact label preview text under QR */
        #qrcode div { font-size: 10px; line-height: 1.2; }

        .nav-pills .nav-link.active{ background: var(--accent); }
    </style>
</head>
<body>
<!-- ===== Header (fixed) ===== -->
<nav class="navbar navbar-expand-lg gm-navbar fixed-top">
    <div class="container-fluid px-3">
        <div class="d-flex align-items-center gap-2">
            <button id="btnBack" class="btn gm-icon-btn me-2" type="button" title="Back">
                <i class="bi bi-arrow-left"></i>
            </button>
            <a id="btnHome" class="btn gm-icon-btn me-2" role="button" title="Home">
                <i class="bi bi-house"></i>
            </a>
            <span class="gm-brand">Geekmonkey</span>
        </div>
        <div class="d-flex align-items-center">
            <span class="text-white small">Inventory · Labels</span>
        </div>
    </div>
</nav>

<!-- ===== Content ===== -->
<main>
    <div class="gm-container">
        <div class="gm-card shadow-sm">
            <div class="gm-card-header p-3">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="mb-0"><i class="bi bi-upc-scan gm-accent me-2"></i>Print Labels</h5>
                    <ul class="nav nav-pills" id="labelTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="product-tab" data-bs-toggle="pill" data-bs-target="#productPane" type="button" role="tab">Product Labels</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="storage-tab" data-bs-toggle="pill" data-bs-target="#storagePane" type="button" role="tab">Storage Labels</button>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="p-3 p-md-4">
                <div class="tab-content" id="labelTabContent">

                    <!-- ===== Product Labels Pane ===== -->
                    <div class="tab-pane fade show active" id="productPane" role="tabpanel" aria-labelledby="product-tab">
                        <!-- Search Product -->
                        <div class="mb-3">
                            <label for="searchProduct" class="form-label">Search Product Name or ID</label>
                            <input type="text" id="searchProduct" class="form-control" placeholder="Start typing at least 3 characters..." />
                            <div id="spinner" class="mt-2" style="display:none;">
                                <div class="spinner-border text-warning spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>
                                <span class="ms-2 small gm-muted">Searching...</span>
                            </div>
                        </div>

                        <!-- Product List -->
                        <div id="productList" class="list-group mb-3" style="display:none;"></div>

                        <!-- Product Details -->
                        <div id="productDetails" class="row g-4 align-items-start" style="display:none;">
                            <div class="col-12 col-md-4">
                                <img id="productImagePreview" src="" alt="Product Image" class="gm-img d-none"/>
                            </div>
                            <div class="col-12 col-md-8">
                                <div class="row g-2">
                                    <div class="col-6"><span class="gm-muted small">Quantity</span><div class="fw-semibold" id="quantity">—</div></div>
                                    <div class="col-6"><span class="gm-muted small">Shopify Quantity</span><div class="fw-semibold" id="shopifyQuantity">—</div></div>
                                    <div class="col-6"><span class="gm-muted small">Location</span><div class="fw-semibold" id="location">—</div></div>
                                    <div class="col-6"><span class="gm-muted small">Name</span><div class="fw-semibold" id="name">—</div></div>
                                    <div class="col-12"><span class="gm-muted small">Product / Variation ID</span><div class="fw-semibold" id="productVariantId">—</div></div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="mt-4 d-grid d-md-flex gap-2">
                            <button id="generateBarcodeButton" class="btn btn-accent px-4" style="display:none;">
                                <i class="bi bi-printer me-2"></i>Generate Barcode Label
                            </button>
                        </div>
                    </div>

                    <!-- ===== Storage Labels Pane ===== -->
                    <div class="tab-pane fade" id="storagePane" role="tabpanel" aria-labelledby="storage-tab">
                        <div class="row g-3">
                            <div class="col-12 col-md-3">
                                <label class="form-label">Prefix (e.g., Rack / Bin)</label>
                                <input type="text" id="stPrefix" class="form-control" value="Rack" />
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label">Rack / Area</label>
                                <input type="text" id="stRack" class="form-control" placeholder="e.g., 122" />
                            </div>
                            <div class="col-6 col-md-2">
                                <label class="form-label">Start #</label>
                                <input type="number" id="stStart" class="form-control" value="1" min="0" />
                            </div>
                            <div class="col-6 col-md-2">
                                <label class="form-label">Digits</label>
                                <input type="number" id="stDigits" class="form-control" value="3" min="1" />
                            </div>
                            <div class="col-12 col-md-2">
                                <label class="form-label">Labels</label>
                                <input type="number" id="stCount" class="form-control" value="20" min="1" />
                            </div>
                            <div class="col-12">
                                <div class="form-text">Example output → <code>Rack 122-001</code>, <code>Rack 122-002</code>, ... The QR and printed text will be the same string.</div>
                            </div>
                        </div>
                        <div class="mt-3 d-grid d-md-flex gap-2">
                            <button id="btnPreviewStorage" class="btn btn-outline-secondary"><i class="bi bi-eye me-2"></i>Preview first label</button>
                            <button id="btnPrintStorage" class="btn btn-accent"><i class="bi bi-printer me-2"></i>Print Storage Labels</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</main>

<!-- ===== QR Code Modal ===== -->
<div class="modal fade" id="qrcodeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">QR Code Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrcode" class="d-inline-block"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-accent" id="btnPrintQr">Print</button>
            </div>
        </div>
    </div>
</div>

<!-- ===== Scripts ===== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const qrcodeModal = new bootstrap.Modal(document.getElementById('qrcodeModal'));

    // Header actions
    document.getElementById('btnBack').addEventListener('click', () => window.history.back());
    document.getElementById('btnHome').addEventListener('click', () => window.location.href = '/v1/home');

    (function(){
      const backBtn = document.getElementById('btnBack');
      if (['/','/v1/home'].includes(window.location.pathname)) backBtn.classList.add('d-none');
    })();

    // ---------------- Product Labels logic ----------------
    document.getElementById('searchProduct').addEventListener('input', function(){
      const query = this.value.trim();
      const list = document.getElementById('productList');
      list.style.display = query ? 'block' : 'none';
      if (query.length < 3) return;

      enableSpinner(true);
      fetch(`/v1/inventory/search?query=${encodeURIComponent(query.toLowerCase())}`)
        .then(r => r.json())
        .then(data => {
          list.innerHTML = '';
          (data || []).forEach(product => {
            const a = document.createElement('a');
            a.className = 'list-group-item list-group-item-action d-flex align-items-center';
            a.innerHTML = `
              <i class="bi bi-box-seam me-2 gm-accent"></i>
              <span>${escapeHtml(product.productTitle)}${product.productVariantTitle ? ' ('+escapeHtml(product.productVariantTitle)+')' : ''}</span>`;
            a.onclick = () => displayProductInfo(product);
            list.appendChild(a);
          });
        })
        .catch(() => { list.innerHTML = '<div class="list-group-item text-danger">Error loading results</div>'; })
        .finally(() => enableSpinner(false));
    });

    document.getElementById('generateBarcodeButton')?.addEventListener('click', function(){
      const countStr = prompt('Enter number of labels to generate (per page shows 4 labels):', '4');
      const labelCount = Number(countStr);
      if (!labelCount || isNaN(labelCount) || labelCount < 1) return;
      generateQRCode(labelCount);
    });

    document.getElementById('btnPrintQr').addEventListener('click', printQRCode);

    function displayProductInfo(product){
      document.getElementById('productList').style.display = 'none';
      document.getElementById('productDetails').style.display = 'flex';
      document.getElementById('generateBarcodeButton').style.display = 'inline-flex';

      if (product?.stockHistory?.images?.length) {
        fetchImages(product.stockHistory.images,'productImagePreview');
      }
      const img = document.getElementById('productImagePreview');
      if (product.imageUrl) { img.src = product.imageUrl; img.classList.remove('d-none'); } else { img.classList.add('d-none'); }

      document.getElementById('quantity').textContent = product.quantity ?? '—';
      document.getElementById('shopifyQuantity').textContent = product.shopifyQuantity ?? '—';
      document.getElementById('location').textContent = product.storage ?? '—';
      document.getElementById('name').textContent = product.productTitle ?? '—';
      document.getElementById('productVariantId').textContent = product.productVariantId || product.productId || '—';
    }

    function enableSpinner(enable){ document.getElementById('spinner').style.display = enable ? 'block' : 'none'; }

    function generateQRCode(labelCount){
      const productId = document.getElementById('productVariantId').textContent.trim();
      let productName = document.getElementById('name').textContent.trim();
      if (!productId) { alert('Product ID is required to generate QR code.'); return; }

      const cont = document.getElementById('qrcode');
      cont.innerHTML = '';

      new QRCode(cont, { text: productId, width: 128, height: 128 });

      const text = document.createElement('div');
      if (productName.length > 60) productName = productName.substring(0, 60) + '…';
      text.textContent = productName;
      text.className = 'mt-2';
      cont.appendChild(text);

      cont.dataset.labelCount = String(labelCount);
      cont.dataset.mode = 'product';

      qrcodeModal.show();
    }

    async function printQRCode(){
      const cont = document.getElementById('qrcode');
      const mode = cont.dataset.mode || 'product';
      if (mode === 'product') return printProductQRCodes();
      if (mode === 'storage') return printStorageQRCodes();
    }

    async function printProductQRCodes(){
      const cont = document.getElementById('qrcode');
      const img = cont.querySelector('img');
      const text = cont.querySelector('div');
      const count = Number(cont.dataset.labelCount || '4');
      if (!img || !text) { alert('No QR code or text found to print.'); return; }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:'landscape', unit:'in', format:[4,1] });

      const qr = img.src;
      const productText = text.textContent || '';
      const perRow = 4; // 4 labels per strip
      const rows = Math.ceil(count / perRow);

      for (let r=0; r<rows; r++){
        const slots = [0.2, 1.3, 2.3, 3.2];
        for (let c=0; c<perRow; c++){
          const idx = r*perRow + c;
          if (idx >= count) break;
          const x = slots[c];
          const y = 0.1;
          const size = 0.5;
          pdf.addImage(qr, 'PNG', x, y, size, size);
          pdf.setFontSize(5);
          const maxWidth = 0.7;
          const wrapped = pdf.splitTextToSize(productText, maxWidth);
          pdf.text(wrapped, x, y + size + 0.1);
        }
        if (r < rows-1) pdf.addPage([4,1], 'landscape');
      }

      const blob = pdf.output('blob');
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }

    // ---------------- Storage Labels logic ----------------
    document.getElementById('btnPreviewStorage').addEventListener('click', () => {
      const firstText = buildStorageText(0);
      if (!firstText) return;
      previewQr(firstText, /*mode*/'storage', /*count*/Number(document.getElementById('stCount').value || 1));
    });

    document.getElementById('btnPrintStorage').addEventListener('click', () => {
      const firstText = buildStorageText(0);
      if (!firstText) return;
      previewQr(firstText, 'storage', Number(document.getElementById('stCount').value || 1));
    });

    function buildStorageText(offset){
      const prefix = (document.getElementById('stPrefix').value || '').trim();
      const rack = (document.getElementById('stRack').value || '').trim();
      const start = Number(document.getElementById('stStart').value || 0);
      const digits = Math.max(1, Number(document.getElementById('stDigits').value || 1));
      const count = Number(document.getElementById('stCount').value || 1);

      if (!prefix || !rack || count < 1){
        alert('Please enter Prefix, Rack/Area and a valid label count.');
        return '';
      }
      const current = start + offset;
      const seq = String(current).padStart(digits, '0');
      return `${prefix} ${rack}-${seq}`;
    }

    function previewQr(text, mode, count){
      const cont = document.getElementById('qrcode');
      cont.innerHTML = '';
      new QRCode(cont, { text, width: 128, height: 128 });
      const label = document.createElement('div');
      label.textContent = text;
      label.className = 'mt-2';
      cont.appendChild(label);
      cont.dataset.mode = mode;
      cont.dataset.labelCount = String(count);
      qrcodeModal.show();
    }

    async function printStorageQRCodes(){
      const { jsPDF } = window.jspdf;
      const count = Number(document.getElementById('qrcode').dataset.labelCount || 1);
      const perRow = 4;
      const rows = Math.ceil(count / perRow);
      const pdf = new jsPDF({ orientation:'landscape', unit:'in', format:[4,1] });

      for (let r=0; r<rows; r++){
        const slots = [0.2, 1.3, 2.3, 3.2];
        for (let c=0; c<perRow; c++){
          const idx = r*perRow + c;
          if (idx >= count) break;
          const text = buildStorageText(idx);
          const dataUrl = await generateQrDataUrl(text);
          const x = slots[c];
          const y = 0.1;
          const size = 0.5;
          pdf.addImage(dataUrl, 'PNG', x, y, size, size);
          pdf.setFontSize(5);
          const maxWidth = 0.9;
          const { width } = pdf.internal.pageSize;
          const wrapped = pdf.splitTextToSize(text, maxWidth);
          pdf.text(wrapped, x, y + size + 0.1);
        }
        if (r < rows-1) pdf.addPage([4,1], 'landscape');
      }

      const blob = pdf.output('blob');
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
    }

    function generateQrDataUrl(text){
      return new Promise((resolve) => {
        const temp = document.createElement('div');
        temp.style.position = 'fixed';
        temp.style.left = '-9999px';
        document.body.appendChild(temp);
        const qr = new QRCode(temp, { text, width:128, height:128 });
        // Wait a tick for lib to render <img>
        setTimeout(() => {
          const img = temp.querySelector('img');
          const src = img ? img.src : '';
          document.body.removeChild(temp);
          resolve(src);
        }, 50);
      });
    }

    // Utilities
    function escapeHtml(str){
      return String(str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
    }

    // Shortcuts: Alt+← back, Alt+H home
    window.addEventListener('keydown', (e)=>{
      if (e.altKey && e.key === 'ArrowLeft'){ e.preventDefault(); window.history.back(); }
      if (e.altKey && (e.key.toLowerCase() === 'h')){ e.preventDefault(); window.location.href = '/home'; }
    });
</script>
</body>
</html>
