<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Geekmonkey — Picklist</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        :root{
          --bg:#F9FAFB; --card:#FFFFFF; --stroke:#E5E7EB; --text:#111827; --muted:#6B7280;
          --accent:#FF7A00; --accent-ink:#9A4D00; --radius:16px;
        }
        html,body{height:100%}
        body{background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}

        /* Header */
        .gm-header{position:sticky; top:0; z-index:1000; background:#fff; border-bottom:1px solid var(--stroke)}
        .gm-brand{display:flex; align-items:center; gap:.6rem; font-weight:800; color:var(--text); text-decoration:none}
        .gm-dot{width:28px; height:28px; border-radius:10px; background:var(--accent); box-shadow:0 8px 18px rgba(255,122,0,.25)}
        .btn-ghost{background:#fff; border:1px solid var(--stroke); color:var(--text); border-radius:12px}
        .btn-ghost:hover{background:#fdfdfd; border-color:#d6d9de}
        .btn-accent{background:var(--accent); color:#fff; border:0; border-radius:12px}
        .btn-accent:hover{background:#ff8f29}

        /* Cards */
        .gm-card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:0 4px 16px rgba(17,24,39,.04)}
        .muted{color:var(--muted)}
        .pill{display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .6rem; border-radius:999px; border:1px solid transparent; font-weight:600; font-size:.75rem}
        .pill-urg{background:#fee2e2; color:#7f1d1d; border-color:#fecaca}
        .pill-pri{background:#fef3c7; color:#78350f; border-color:#fde68a}
        .pill-nrm{background:#dcfce7; color:#064e3b; border-color:#bbf7d0}

        .thumb{width:100%; height:100%; object-fit:cover; border-radius:12px}

        /* Sticky footer */
        .gm-footer{position:sticky; bottom:0; z-index:1020; background:#fff; border-top:1px solid var(--stroke)}
        .progress-wrap{height:.75rem; background:#e5e7eb; border-radius:999px; overflow:hidden}
        .progress-bar-gm{background:var(--accent)}

        /* Mobile container size */
        .maxw-sm{max-width:560px}

        /* No-results */
        .no-results{display:none}
    </style>
</head>
<body>

<!-- Header -->
<nav class="gm-header">
    <div class="container maxw-sm d-flex align-items-center justify-content-between py-2">
        <a class="gm-brand" href="/v1/home" aria-label="Geekmonkey Home">
            <span class="gm-dot" aria-hidden="true"></span><span>Geekmonkey</span>
        </a>
        <div class="d-flex gap-2">
            <button id="gmBackBtn" type="button" class="btn btn-ghost btn-sm me-2">← Back</button>
            <a href="/v1/home" class="btn btn-accent btn-sm">⌂ Home</a>
        </div>
    </div>

    <!-- Title + search + scan -->
    <div class="container maxw-sm py-2 pt-0">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="h5 fw-bold mb-0">Picklist</h1>
                <div class="small text-muted">Mobile</div>
            </div>
            <button type="button" class="btn btn-accent btn-sm" onclick="scanProduct()">Scan</button>
        </div>

        <!-- Client-side filter (type or scanned) -->
        <div class="mt-2 position-relative">
            <input class="form-control" placeholder="Search by Product Name or Product/Variation ID…" id="searchquery" autocomplete="off"/>
            <button id="clearSearch" type="button" class="btn btn-link small position-absolute end-0 top-50 translate-middle-y me-2 text-decoration-none">Clear</button>
        </div>
        <div class="small text-muted mt-1">Tip: Typing or scanning filters the list below in real time.</div>
    </div>
</nav>

<!-- Content -->
<main class="container maxw-sm pb-5 pt-3" id="itemsContainer">

    <!-- No-results -->
    <div class="text-center muted py-4 no-results" id="noResults">No items match your search.</div>

    <!-- Hidden Mark All form -->
    <form th:action="@{/picklist/markAll}" method="post" th:if="${!#lists.isEmpty(items)}" class="d-none" id="markAllForm">
        <input type="hidden" name="q" th:value="${q}"/>
        <div th:each="it : ${items}">
            <input type="checkbox" name="ids" th:value="${it.id}" th:checked="${it.picked}"/>
        </div>
    </form>

    <!-- Items (add data attributes used for filtering) -->
    <div th:each="it : ${items}"
         class="gm-card p-3 mb-3 pick-item"
         th:attr="data-name=${it.name},data-id=${it.id},data-vid=${it.variationId}">
        <div class="d-flex gap-3">
            <div style="width:84px; height:84px;" class="flex-shrink-0">
                <img th:src="${it.imageUrl}" th:alt="${it.name}" class="thumb border"/>
            </div>

            <div class="flex-grow-1">
                <div class="d-flex align-items-start justify-content-between">
                    <div class="pe-2">
                        <div class="fw-semibold" th:text="${it.name}">Product Name</div>
                        <div class="small text-muted">
                            Product ID: <span th:text="${it.id}">PID-1</span> •
                            Variation ID: <span th:text="${it.variationId}">VAR-1</span>
                        </div>
                    </div>

                    <!-- Priority pill -->
                    <span th:classappend="${it.priority.name()=='HIGH'} ? ' pill-urg' : (${it.priority.name()=='MEDIUM'} ? ' pill-pri' : ' pill-nrm')"
                          class="pill">
            <span th:if="${it.priority.name()=='HIGH'}">Urgent</span>
            <span th:if="${it.priority.name()=='MEDIUM'}">Priority</span>
            <span th:if="${it.priority.name()=='LOW'}">Normal</span>
          </span>
                </div>

                <div class="d-flex align-items-center justify-content-between mt-2 mb-1">
                    <div class="small">
                        <span class="text-muted">Qty:</span>
                        <span class="fs-5 fw-bold ms-1" th:text="${it.qty}">1</span>
                    </div>

                    <form th:action="@{/v1/order/picklist/toggle}" method="post" class="ms-2">
                        <input type="hidden" name="id" th:value="${it.id}"/>
                        <input type="hidden" name="q" th:value="${q}"/>
                        <button th:classappend="${it.picked} ? ' btn-accent' : ' btn-ghost'" class="btn btn-sm fw-semibold">
                            <span th:text="${it.picked} ? 'Picked' : 'Mark Picked'">Mark Picked</span>
                        </button>
                    </form>
                </div>

                <div class="small text-muted">Storage: <span th:text="${it.storage}">Aisle B</span></div>
            </div>
        </div>
    </div>

</main>

<!-- Sticky Footer -->
<footer class="gm-footer">
    <div class="container maxw-sm py-3">
        <div class="d-flex align-items-center justify-content-between small">
            <div class="fw-semibold">
                Picked <span th:text="${picked}">0</span> of <span th:text="${total}">0</span>
            </div>
            <div class="text-muted">
                Remaining <span th:text="${total - picked}">0</span>
            </div>
        </div>

        <div class="progress-wrap mt-2">
            <div class="progress-bar-gm" style="height:100%;"
                 th:style="'width:' + (${total} > 0 ? ((${picked} * 100) / ${total}) : 0) + '%;'">
            </div>
        </div>

        <div class="d-flex gap-2 pt-2">
            <button form="markAllForm" class="btn btn-accent flex-grow-1">Mark All Picked</button>
            <a th:href="@{/v1/order/picklist}" class="btn btn-ghost">Reset</a>
        </div>
    </div>
</footer>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Back/Home
    (function(){
      const backBtn = document.getElementById('gmBackBtn');
      if(backBtn){
        backBtn.addEventListener('click', function(){
          if (history.length > 1) { try { history.back(); return; } catch(e){} }
          location.href = '/v1/home';
        });
      }
    })();

    // Trigger Android (optional)
    function scanProduct() {
      if (typeof Android !== "undefined" && Android.performAction) {
        Android.performAction();
      }
    }

    // WebView hook: call this from Android after scanning
    function onBarcodeScanned(productId, deviceName){
      // Optional: alert("Scanned: " + productId);
      if(productId){
        const box = document.getElementById('searchquery');
        box.value = productId;
        applyFilter();
        box.focus();
      }
    }

    // Filtering (by product name OR product/variation id) from rendered items
    const searchBox = document.getElementById('searchquery');
    const clearBtn  = document.getElementById('clearSearch');
    const items     = Array.from(document.querySelectorAll('.pick-item'));
    const noResults = document.getElementById('noResults');

    function norm(s){ return (s||'').toString().toLowerCase().trim(); }

    function matches(item, query){
      if (!query) return true;
      const q = norm(query);
      // dataset: data-name, data-id, data-vid
      const name = norm(item.dataset.name);
      const pid  = norm(item.dataset.id);
      const vid  = norm(item.dataset.vid);
      // match if query is anywhere in name OR equals/contained in ids
      return name.includes(q) || pid.includes(q) || vid.includes(q);
    }

    function applyFilter(){
      const q = searchBox.value;
      let visible = 0;
      items.forEach(it => {
        const ok = matches(it, q);
        it.style.display = ok ? '' : 'none';
        if (ok) visible++;
      });
      noResults.style.display = visible === 0 ? 'block' : 'none';
    }

    // Input: live filter
    searchBox.addEventListener('input', applyFilter);

    // Clear
    clearBtn.addEventListener('click', function(){
      searchBox.value = '';
      applyFilter();
      searchBox.focus();
    });

    // Prevent form submissions (we’re client-side only now)
    document.addEventListener('submit', function(e){
      const el = e.target;
      if (el && el.matches('form[method="get"]')) {
        e.preventDefault();
      }
    });

    // Initial state
    applyFilter();
</script>
</body>
</html>
