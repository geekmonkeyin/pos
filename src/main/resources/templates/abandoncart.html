<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geekmonkey ‚Ä¢ CartSave</title>
  <style>
    :root{
      /* Geekmonkey theme */
      --gm-orange:#FF7A00;
      --gm-orange-2:#ff8f2b;
      --ink:#0b1220;
      --ink-2:#111827;
      --card:#ffffff;
      --bg:#f6f7fb;
      --line:#e7e9f2;
      --muted:#6b7280;

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --info:#2563eb;

      --shadow: 0 10px 28px rgba(17,24,39,.08);
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #ffffff 0%, var(--bg) 60%);
      color: var(--ink-2);
    }

    /* Header */
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbarInner{
      max-width:1180px;
      margin:0 auto;
      padding:10px 16px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brandMark{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, var(--gm-orange), #ffb15c);
      color:#111;
      font-weight:1000;
      box-shadow: 0 10px 20px rgba(255,122,0,.25);
    }
    .brandText{
      display:flex; flex-direction:column; line-height:1.1;
      margin-right:8px;
    }
    .brandText b{
      font-size:14px; letter-spacing:.6px;
    }
    .brandText span{
      font-size:11px; color:var(--muted);
    }

    .navBtns{
      display:flex; gap:8px; align-items:center;
    }
    .navBtn{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      color:var(--ink-2);
      transition:.15s ease;
    }
    .navBtn:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(17,24,39,.08); }
    .navBtn.primary{
      border-color: rgba(255,122,0,.35);
      background: linear-gradient(180deg, #fff 0%, #fff7ee 100%);
    }
    .chip{
      margin-left:auto;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .chip .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }
    .chip .pill b{ color:var(--ink-2); }

    /* Layout */
    .wrap{
      max-width:1180px;
      margin:18px auto;
      padding:0 16px 42px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    /* Filters */
    .controls{
      padding:16px;
    }
    .controlsHead{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .controlsHead h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .controlsHead .hint{
      font-size:12px; color:var(--muted);
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
    }
    .field{
      display:flex;
      align-items:center;
      gap:8px;
      padding:9px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }
    .field label{
      font-size:12px; color:var(--muted); font-weight:800;
    }
    input[type="date"], input[type="text"]{
      border:0; outline:0; background:transparent;
      font-size:13px; color:var(--ink-2);
      min-width:140px;
    }
    .btn{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      font-weight:1000;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary{
      background: linear-gradient(180deg, var(--gm-orange), var(--gm-orange-2));
      color:#111;
      box-shadow: 0 12px 22px rgba(255,122,0,.25);
    }
    .btn.secondary{
      background:#fff;
      border:1px solid var(--line);
      color:var(--ink-2);
      font-weight:900;
    }
    .btn.ghost{
      background:#fff;
      border:1px solid rgba(255,122,0,.35);
      color:var(--ink-2);
      font-weight:1000;
    }

    /* Panels */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.2fr 1.2fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .panel{
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .panelHeader{
      padding:12px 14px;
      font-weight:1000;
      letter-spacing:.35px;
      text-transform:uppercase;
      font-size:13px;
      text-align:center;
      color:#fff;
    }
    .panelHeader.dark{ background: linear-gradient(180deg, #2f343a, #1f2328); }
    .panelHeader.green{ background: linear-gradient(180deg, #22a06b, #137b52); }
    .panelHeader.gm{ background: linear-gradient(180deg, var(--gm-orange), var(--gm-orange-2)); color:#111; }

    .metrics{
      display:grid;
      grid-template-columns:1fr 1fr;
    }
    .metric{
      padding:18px 10px;
      text-align:center;
      border-top:1px solid var(--line);
    }
    .metric:nth-child(1), .metric:nth-child(2){ border-top:0; }
    .metric:nth-child(odd){ border-right:1px solid var(--line); }
    .metric .big{
      font-size:30px;
      font-weight:1100;
      line-height:1;
      margin-bottom:6px;
      color:var(--ink-2);
    }
    .metric .label{
      font-size:12px;
      color:var(--muted);
      line-height:1.2;
      font-weight:800;
    }

    /* Pie */
    .pieWrap{
      display:flex;
      gap:14px;
      align-items:center;
      padding:14px;
    }
    .legend{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .lg{ display:flex; align-items:center; gap:10px; font-weight:800; }
    .sw{ width:14px; height:10px; border-radius:3px; }
    .pieBox{
      width:220px;height:220px;
      display:grid;place-items:center;
    }

    /* Table */
    .bottom{
      margin-top:14px;
      overflow:hidden;
    }
    .tabs{
      display:flex;
      gap:8px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      align-items:center;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
    }
    .tab.active{
      background: linear-gradient(180deg, var(--gm-orange), var(--gm-orange-2));
      border-color: rgba(255,122,0,.35);
      color:#111;
    }
    .tabs .title{
      margin-left:auto;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }

    table{ width:100%; border-collapse:collapse; }
    th, td{
      padding:12px 14px;
      border-top:1px solid var(--line);
      font-size:13px;
      vertical-align:top;
    }
    th{
      color:var(--muted);
      font-weight:1000;
      font-size:12px;
      background:#fffaf4;
    }
    .muted{ color:var(--muted); font-size:12px; font-weight:800; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }

    .status{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      font-weight:1000;
      background:#fff;
    }
    .status.ok{ border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.10); color:#0f5132; }
    .status.warn{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12); color:#7a4b00; }
    .status.bad{ border-color:rgba(220,38,38,.35); background:rgba(220,38,38,.10); color:#7f1d1d; }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .linkBtn{
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
    }
    .linkBtn.primary{
      background: linear-gradient(180deg, var(--gm-orange), var(--gm-orange-2));
      border-color: rgba(255,122,0,.35);
      color:#111;
    }

    /* Logs modal */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(11,18,32,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(980px, 100%);
      max-height:85vh;
      overflow:hidden;
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 25px 80px rgba(0,0,0,.25);
      border:1px solid var(--line);
      display:flex;
      flex-direction:column;
    }
    .modalHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .modalHeader b{ font-size:14px; }
    .modalHeader .pill{
      margin-left:auto;
      padding:7px 10px;
      border-radius:999px;
      background:#fff7ee;
      border:1px solid rgba(255,122,0,.35);
      font-size:12px;
      font-weight:1000;
      color:#111827;
    }
    .close{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      font-weight:1000;
      cursor:pointer;
    }
    .modalBody{
      padding:12px 14px;
      overflow:auto;
      background:#fffaf4;
    }
    .logRow{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      margin-bottom:10px;
      display:grid;
      grid-template-columns: 170px 120px 1fr;
      gap:10px;
      align-items:start;
    }
    @media (max-width: 720px){
      .logRow{grid-template-columns:1fr}
    }
    .sev{
      display:inline-flex; align-items:center; gap:6px;
      font-weight:1100; font-size:12px;
    }
    .sev.ok{ color:var(--ok); }
    .sev.warn{ color:var(--warn); }
    .sev.bad{ color:var(--bad); }
    .sev.info{ color:var(--info); }
  </style>
</head>

<body>
<!-- Header with Back + Home -->
<header class="topbar">
  <div class="topbarInner">
    <div class="navBtns">
      <button class="navBtn" onclick="history.back()">‚Üê Back</button>
      <button class="navBtn primary" onclick="goHome()">üè† Home</button>
    </div>

    <div class="brandMark">GM</div>
    <div class="brandText">
      <b>GEEKMONKEY ‚Ä¢ CartSave</b>
      <span>Abandoned Cart + WhatsApp Recovery</span>
    </div>

    <div class="chip">
      <div class="pill">Sync: <b>Every 15 mins</b></div>
      <div class="pill">Follow-ups: <b>+30m, +60m</b></div>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- Controls -->
  <div class="card controls">
    <div class="controlsHead">
      <h3>Date range</h3>
      <div class="hint">Filter and check logs for any checkout.</div>
    </div>

    <div class="row">
      <div class="field"><label>From</label><input id="fromDate" type="date" value="2021-07-05"></div>
      <div class="field"><label>To</label><input id="toDate" type="date" value="2021-07-12"></div>

      <button class="btn secondary" id="searchBtn">Search</button>
      <button class="btn secondary" id="resetBtn">Reset</button>
      <button class="btn ghost" id="settingsBtn">Settings</button>

      <div style="flex:1"></div>

      <div class="field" style="min-width:280px;">
        <label>Search</label>
        <input id="q" type="text" placeholder="phone / email / product / checkout id">
      </div>

      <button class="btn primary" id="viewAllLogsBtn">üßæ View Logs</button>
    </div>
  </div>

  <!-- Panels -->
  <div class="grid">
    <!-- Abandoned -->
    <div class="panel">
      <div class="panelHeader dark">Abandoned Cart Metrics</div>
      <div class="metrics">
        <div class="metric"><div class="big" id="mCartsStarted">897</div><div class="label">Carts<br/>Started</div></div>
        <div class="metric"><div class="big" id="mCartsAbandoned">824</div><div class="label">Total Carts<br/>Abandoned</div></div>
        <div class="metric"><div class="big" id="mAbandonRate">92%</div><div class="label">Abandonment<br/>Rate</div></div>
        <div class="metric"><div class="big" id="mReachable">123</div><div class="label">Reachable<br/>Carts</div></div>
        <div class="metric"><div class="big" id="mAvgReachable">‚Çπ4,087</div><div class="label">Avg Value<br/>of Reachable</div></div>
        <div class="metric"><div class="big" id="mReachablePct">15%</div><div class="label">Reachable as %<br/>of Abandoned</div></div>
      </div>
    </div>

    <!-- Recovered -->
    <div class="panel">
      <div class="panelHeader green">Recovered Cart Metrics</div>
      <div class="metrics">
        <div class="metric"><div class="big" id="mRecovered">23</div><div class="label">Carts<br/>Recovered</div></div>
        <div class="metric"><div class="big" id="mAbRecovered">2.79%</div><div class="label">% Abandoned<br/>Recovered</div></div>
        <div class="metric"><div class="big" id="mReachRecovered">18.7%</div><div class="label">% Reachable<br/>Recovered</div></div>
        <div class="metric"><div class="big" id="mAvgOrder">‚Çπ4,760</div><div class="label">Avg Order Value<br/>Recovered</div></div>
        <div class="metric"><div class="big" id="mRecoveredSales">‚Çπ1,31,600</div><div class="label">Total Sales from<br/>Recovered</div></div>
        <div class="metric"><div class="big" id="mRecoveredPct">3%</div><div class="label">Recovered as %<br/>of Total Sales</div></div>
      </div>
    </div>

    <!-- Source -->
    <div class="panel">
      <div class="panelHeader gm">Source of Email Capture</div>
      <div class="pieWrap">
        <div class="legend">
          <div class="lg"><span class="sw" style="background:#FF7A00"></span> CartSave Prompt: <b style="color:#111827">37%</b></div>
          <div class="lg"><span class="sw" style="background:#38bdf8"></span> Checkout: <b style="color:#111827">33%</b></div>
          <div class="lg"><span class="sw" style="background:#34d399"></span> Other popups/forms: <b style="color:#111827">20%</b></div>
          <div class="lg"><span class="sw" style="background:#94a3b8"></span> Logged in: <b style="color:#111827">6.5%</b></div>
          <div class="lg"><span class="sw" style="background:#f59e0b"></span> Email marketing: <b style="color:#111827">4.1%</b></div>
          <div class="muted">Geekmonkey Theme ‚Ä¢ Orange accent for CartSave.</div>
        </div>

        <div class="pieBox">
          <canvas id="pie" width="220" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Table + tabs -->
  <div class="card bottom">
    <div class="tabs">
      <button class="tab active" data-view="day">Day</button>
      <button class="tab" data-view="week">Week</button>
      <button class="tab" data-view="month">Month</button>
      <div class="title">All Abandoned / Recovered Checkouts</div>
    </div>

    <table>
      <thead>
      <tr>
        <th style="width:240px;">Customer</th>
        <th>Abandoned Cart Details</th>
        <th style="width:150px;">Checkout URL</th>
        <th style="width:200px;">WhatsApp</th>
        <th style="width:240px;">Actions</th>
      </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Logs Modal -->
<div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <b id="modalTitle">Logs</b>
      <span class="pill" id="modalPill">Last 24 hours</span>
      <button class="close" id="closeModal">Close ‚úï</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
  // Home button handler (change to your real home route)
  function goHome(){ window.location.href = "/"; }

  // Mock dataset (replace with API)
  const rows = [
    {
      name:"Anil T",
      phone:"+91 98xxxxxx12",
      email:"anil@demo.com",
      checkoutId:"gid://shopify/AbandonedCheckout/123",
      items:["Funko Pop! Pikachu √ó1","3D Moon Lamp √ó1"],
      total:"‚Çπ3,499",
      url:"{recovery_url}",
      wa:{status:"NOT_SENT", attempts:0, next:"Eligible now"},
      logs:[
        {ts:"2026-01-23 23:15:00", sev:"info", msg:"Synced abandoned checkout from Shopify (15-min job)."},
        {ts:"2026-01-23 23:15:02", sev:"warn", msg:"Customer email missing on checkout; phone available."}
      ]
    },
    {
      name:"Muskaan",
      phone:"+91 97xxxxxx44",
      email:null,
      checkoutId:"gid://shopify/AbandonedCheckout/456",
      items:["One Piece Luffy Cable Guys √ó1"],
      total:"‚Çπ2,299",
      url:"{recovery_url}",
      wa:{status:"SENT", attempts:1, next:"23:42 (+30m)"},
      logs:[
        {ts:"2026-01-23 23:10:00", sev:"info", msg:"Synced abandoned checkout from Shopify (15-min job)."},
        {ts:"2026-01-23 23:12:08", sev:"ok", msg:"WhatsApp attempt #1 sent via provider. msg_id=WA_9f2a..."},
        {ts:"2026-01-23 23:12:25", sev:"ok", msg:"Delivery status: delivered."}
      ]
    },
    {
      name:"Deepak",
      phone:"+91 99xxxxxx01",
      email:"deepak@demo.com",
      checkoutId:"gid://shopify/AbandonedCheckout/789",
      items:["Naruto Kunai Keychain √ó2","Anime LED Lamp √ó1"],
      total:"‚Çπ1,799",
      url:"{recovery_url}",
      wa:{status:"FAILED", attempts:2, next:"Paused"},
      logs:[
        {ts:"2026-01-23 22:05:00", sev:"info", msg:"Synced abandoned checkout from Shopify (15-min job)."},
        {ts:"2026-01-23 22:05:12", sev:"ok", msg:"WhatsApp attempt #1 sent. msg_id=WA_12ab..."},
        {ts:"2026-01-23 22:35:42", sev:"bad", msg:"WhatsApp attempt #2 failed: invalid number / provider error."}
      ]
    }
  ];

  const tbody = document.getElementById("tbody");

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function statusBadge(s){
    if(s==="SENT" || s==="DELIVERED" || s==="READ")
      return `<span class="status ok">‚úÖ ${s}</span>`;
    if(s==="FAILED")
      return `<span class="status bad">‚ùå FAILED</span>`;
    return `<span class="status warn">‚è≥ NOT SENT</span>`;
  }

  function render(filter=""){
    const q = (filter||"").trim().toLowerCase();
    tbody.innerHTML = "";

    rows
      .filter(r=>{
        if(!q) return true;
        return (
          (r.name||"").toLowerCase().includes(q) ||
          (r.phone||"").toLowerCase().includes(q) ||
          (r.email||"").toLowerCase().includes(q) ||
          (r.checkoutId||"").toLowerCase().includes(q) ||
          (r.items||[]).join(" ").toLowerCase().includes(q)
        );
      })
      .forEach((r, idx)=>{
        const items = r.items.map(i=>`<div>${escapeHtml(i)}</div>`).join("");
        const emailLine = r.email ? `<div class="muted">${escapeHtml(r.email)}</div>` : `<div class="muted">(email missing)</div>`;

        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>
              <div><b>${escapeHtml(r.name)}</b></div>
              <div class="muted">${escapeHtml(r.phone)}</div>
              ${emailLine}
              <div class="mono muted" style="margin-top:6px;">${escapeHtml(r.checkoutId)}</div>
            </td>

            <td>
              ${items}
              <div class="muted" style="margin-top:8px;">Total: <b>${escapeHtml(r.total)}</b></div>
            </td>

            <td>
              <a class="mono" href="${escapeHtml(r.url)}" target="_blank" rel="noopener">Open</a>
              <div class="muted" style="margin-top:6px;">(recovery_url)</div>
            </td>

            <td>
              ${statusBadge(r.wa.status)}
              <div class="muted">Attempts: <b>${r.wa.attempts}</b> / 3</div>
              <div class="muted">Next: ${escapeHtml(r.wa.next || "-")}</div>
            </td>

            <td>
              <div class="actions">
                <button class="linkBtn" onclick="openLogs(${idx})">üßæ Logs</button>
                <button class="linkBtn primary" onclick="sendWA(${idx})">Send WhatsApp</button>
                <button class="linkBtn" onclick="copyUrl(${idx})">Copy URL</button>
              </div>
            </td>
          </tr>
        `);
      });
  }

  // Logs modal
  const modalOverlay = document.getElementById("modalOverlay");
  const modalBody = document.getElementById("modalBody");
  const modalTitle = document.getElementById("modalTitle");
  const modalPill  = document.getElementById("modalPill");

  function sevClass(sev){
    if(sev==="ok") return "ok";
    if(sev==="warn") return "warn";
    if(sev==="bad") return "bad";
    return "info";
  }
  function sevLabel(sev){
    if(sev==="ok") return "OK";
    if(sev==="warn") return "WARN";
    if(sev==="bad") return "ERROR";
    return "INFO";
  }

  window.openLogs = function(idx){
    const r = rows[idx];
    modalTitle.textContent = `Logs ‚Ä¢ ${r.name}`;
    modalPill.textContent = `Checkout: ${r.checkoutId} ‚Ä¢ Attempts: ${r.wa.attempts}/3`;
    modalBody.innerHTML = r.logs.map(l=>`
      <div class="logRow">
        <div class="mono">${escapeHtml(l.ts)}</div>
        <div class="sev ${sevClass(l.sev)}">‚óè ${sevLabel(l.sev)}</div>
        <div>${escapeHtml(l.msg)}</div>
      </div>
    `).join("");
    modalOverlay.style.display = "flex";
  };

  document.getElementById("closeModal").onclick = ()=> modalOverlay.style.display = "none";
  modalOverlay.addEventListener("click", (e)=>{ if(e.target===modalOverlay) modalOverlay.style.display="none"; });

  document.getElementById("viewAllLogsBtn").onclick = ()=>{
    modalTitle.textContent = "Logs ‚Ä¢ All checkouts";
    modalPill.textContent = "Combined (mock)";
    const flat = rows.flatMap(r => r.logs.map(l => ({...l, who:r.name, id:r.checkoutId})));
    flat.sort((a,b)=> (a.ts < b.ts ? 1 : -1));
    modalBody.innerHTML = flat.map(l=>`
      <div class="logRow">
        <div class="mono">${escapeHtml(l.ts)}</div>
        <div class="sev ${sevClass(l.sev)}">‚óè ${sevLabel(l.sev)}</div>
        <div>
          <div style="font-weight:1100">${escapeHtml(l.who)} <span class="muted mono">${escapeHtml(l.id)}</span></div>
          <div style="margin-top:4px">${escapeHtml(l.msg)}</div>
        </div>
      </div>
    `).join("");
    modalOverlay.style.display = "flex";
  };

  // Actions (mock)
  window.copyUrl = async function(idx){
    try{
      await navigator.clipboard.writeText(rows[idx].url);
      alert("Copied recovery URL");
    }catch(e){
      prompt("Copy URL:", rows[idx].url);
    }
  };

  window.sendWA = function(idx){
    // Real: POST /api/whatsapp/send?checkoutId=...
    const r = rows[idx];
    if(r.wa.attempts >= 3){ alert("Max attempts reached (3)."); return; }
    r.wa.attempts += 1;
    r.wa.status = "SENT";
    r.wa.next = (r.wa.attempts >= 3) ? "Done" : "In 30 mins (auto)";
    r.logs.unshift({ts: new Date().toISOString().slice(0,19).replace("T"," "), sev:"ok", msg:`WhatsApp attempt #${r.wa.attempts} sent (mock).`});
    render(document.getElementById("q").value);
  };

  // Pie chart (canvas donut)
  const pieData = [
    {value:37, color:"#FF7A00"},
    {value:33, color:"#38bdf8"},
    {value:20, color:"#34d399"},
    {value:6.5, color:"#94a3b8"},
    {value:4.1, color:"#f59e0b"}
  ];
  function drawPie(){
    const c = document.getElementById("pie");
    const ctx = c.getContext("2d");
    const total = pieData.reduce((s,x)=>s+x.value,0);
    let start = -Math.PI/2;
    const cx = c.width/2, cy = c.height/2, r = 92;

    ctx.clearRect(0,0,c.width,c.height);

    pieData.forEach(seg=>{
      const angle = (seg.value/total)*Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,start+angle);
      ctx.closePath();
      ctx.fillStyle = seg.color;
      ctx.fill();
      start += angle;
    });

    // donut cut + label
    ctx.beginPath();
    ctx.arc(cx,cy,44,0,Math.PI*2);
    ctx.fillStyle = "#fff";
    ctx.fill();

    ctx.fillStyle = "#111827";
    ctx.font = "1000 14px Inter, Arial";
    ctx.textAlign = "center";
    ctx.fillText("Geekmonkey", cx, cy-2);
    ctx.fillStyle = "#6b7280";
    ctx.font = "900 12px Inter, Arial";
    ctx.fillText("CartSave", cx, cy+16);
  }

  // Wiring
  document.getElementById("q").addEventListener("input", e=> render(e.target.value));
  document.getElementById("resetBtn").onclick = ()=>{ document.getElementById("q").value=""; render(""); };
  document.getElementById("searchBtn").onclick = ()=> render(document.getElementById("q").value);

  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
    });
  });

  render("");
  drawPie();
</script>
</body>
</html>
