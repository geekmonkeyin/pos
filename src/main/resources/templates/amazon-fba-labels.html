<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Amazon FBA Label Generator — Geekmonkey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --accent: #ff7a00;
      --bg: #f9fafb;
      --text: #111827;
      --card: #ffffff;
      --stroke: #e5e7eb;
      --radius: 12px;
      --font: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
    }

    .page-shell {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 8px;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      font-size: 1.35rem;
    }

    header small {
      color: #6b7280;
      font-size: 0.8rem;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px 16px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--stroke);
      font-size: 0.9rem;
    }

    .hint {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      padding: 9px 16px;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .layout-columns {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 16px;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }

    /* --- A4 SHEET PREVIEW (HTML) ---
       A4: 210 x 297 mm
       4 columns x 10 rows = 40 labels
       Each label: 52.5 x 29.7 mm (40-up) */
    .sheet-preview-wrapper {
      background: #e5e7eb55;
      border-radius: 12px;
      padding: 12px;
      border: 1px dashed #d1d5db;
      overflow-x: auto;
    }

    .sheet {
      background: #ffffff;
      margin: 0 auto;
      width: 210mm;
      height: 297mm;
      display: grid;
      grid-template-columns: repeat(4, 52.5mm);
      grid-template-rows: repeat(10, 29.7mm);
      gap: 0;
      transform-origin: top left;
    }

    /* scale preview down a bit for typical screens */
    @media (min-width: 900px) {
      .sheet {
        transform: scale(0.8);
      }
    }

    .label {
      border: none; /* No dotted line */
      padding: 1mm 1mm;
      display: flex;
      align-items: stretch;
      justify-content: center;
      text-align: left;
      overflow: hidden;
      page-break-inside: avoid;
    }

    .label-inner {
      display: flex;
      width: 100%;
      height: 100%;
      align-items: stretch;
    }

    .label-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between; /* pushes marketing text to bottom */
      text-align: center;
    }

    .label-top {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 0 0.6mm;
    }

    .label-title {
      font-size: 7pt;
      font-weight: 600;
      line-height: 1.05;
      margin-bottom: 0.2mm;
    }

    .barcode-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0.25mm 0;
    }

    .barcode-svg {
      width: 100%;
      max-height: 10.5mm;
    }

    .fnsku-text {
      font-size: 6.8pt;
      margin-top: 0.15mm;
      letter-spacing: 0.03em;
    }

    .mrp-text {
      font-size: 6.1pt;
      margin-top: 0.15mm;
    }

    /* Marketing details at bottom, horizontal, smaller and tight */
    .marketing-text {
      font-size: 4.5pt;
      line-height: 1.05;
      padding: 0 0.6mm;
      margin-top: 0.1mm;
      margin-bottom: 0;  /* no extra bottom gap to avoid overflow into next row */
      white-space: nowrap;
    }

    /* This hidden sheet is used only for clean PDF capture (1:1 size) */
    #printSheet {
      position: absolute;
      left: -9999px;
      top: 0;
      width: 210mm;
      height: 297mm;
      background: #ffffff;
      display: grid;
      grid-template-columns: repeat(4, 52.5mm);
      grid-template-rows: repeat(10, 29.7mm);
      gap: 0;
    }

    /* PDF Preview pane */
    .pdf-preview-wrapper {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      padding: 8px;
      height: 420px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .pdf-preview-wrapper iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #f3f4f6;
      border-radius: 8px;
    }

    .pdf-hint {
      font-size: 0.75rem;
      color: #6b7280;
    }
  </style>

  <!-- JsBarcode for barcodes -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <!-- html2canvas & jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<div class="page-shell">
  <header>
    <div>
      <h1>Amazon FBA Label Generator</h1>
      <small>40-up · 52.5 mm × 29.7 mm · A4 · No dotted lines</small>
    </div>
    <small>Geekmonkey · GIAN RETAILS PVT LTD</small>
  </header>

  <!-- INPUTS -->
  <section class="card">
    <form id="labelForm">
      <div class="form-grid">
        <div>
          <label for="productName">Product Name</label>
          <input type="text" id="productName" placeholder="Eg. Luffy Gear 5 PVC Figure" required />
        </div>
        <div>
          <label for="fnsku">FNSKU (Barcode Value)</label>
          <input type="text" id="fnsku" placeholder="Eg. X001ABCDEF" required />
          <p class="hint">Will be printed as Code128 barcode + text under it.</p>
        </div>
        <div>
          <label for="mrp">MRP (₹)</label>
          <input type="text" id="mrp" placeholder="Eg. 999" />
          <p class="hint">Optional: will show as “MRP: ₹999” on the label.</p>
        </div>
        <div>
          <label>Marketed By (fixed)</label>
          <input type="text" value="GIAN RETAILS PVT LTD" disabled />
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-secondary" id="clearBtn">
          Clear
        </button>
        <button type="submit" class="btn-primary" id="generateBtn">
          Print Barcode · Generate PDF & Preview
        </button>
      </div>
    </form>
  </section>

  <div class="layout-columns">
    <!-- LEFT: HTML Sheet Preview -->
    <section>
      <h2 class="section-title">Live A4 Sheet Preview (HTML)</h2>
      <div class="sheet-preview-wrapper">
        <div class="sheet" id="htmlSheet"></div>
      </div>
    </section>

    <!-- RIGHT: PDF Preview -->
    <section>
      <h2 class="section-title">Generated PDF Preview</h2>
      <div class="pdf-preview-wrapper">
        <iframe id="pdfPreview" title="PDF Preview"></iframe>
        <p class="pdf-hint">
          After generating, you can use the browser's built-in viewer to
          <strong>download</strong> or <strong>print to actual label sheets</strong>.
        </p>
      </div>
    </section>
  </div>

  <!-- Hidden sheet for clean PDF capture -->
  <div id="printSheet"></div>
</div>

<script>
  const htmlSheet = document.getElementById('htmlSheet');
  const printSheet = document.getElementById('printSheet');
  const pdfPreview = document.getElementById('pdfPreview');
  const form = document.getElementById('labelForm');
  const clearBtn = document.getElementById('clearBtn');

  // Create 40 label elements in both preview sheet and print sheet
  function createLabelGrid(container) {
    container.innerHTML = "";
    for (let i = 0; i < 40; i++) {
      const label = document.createElement('div');
      label.className = 'label';
      label.innerHTML = `
        <div class="label-inner">
          <div class="label-main">
            <div class="label-top">
              <div class="label-title"></div>
              <div class="barcode-wrapper">
                <svg class="barcode-svg"></svg>
              </div>
              <div class="fnsku-text"></div>
              <div class="mrp-text"></div>
            </div>
            <div class="marketing-text">
              MARKETED BY GIAN RETAILS PVT LTD
            </div>
          </div>
        </div>
      `;
      container.appendChild(label);
    }
  }

  createLabelGrid(htmlSheet);
  createLabelGrid(printSheet);

  function fillLabels(productName, fnsku, mrp, container) {
    const labels = container.querySelectorAll('.label');
    labels.forEach(label => {
      const titleEl = label.querySelector('.label-title');
      const barcodeSvg = label.querySelector('.barcode-svg');
      const fnskuText = label.querySelector('.fnsku-text');
      const mrpText = label.querySelector('.mrp-text');

      titleEl.textContent = productName;
      fnskuText.textContent = fnsku;

      if (mrp) {
        mrpText.textContent = "MRP: \u20B9" + mrp;
      } else {
        mrpText.textContent = "";
      }

      // Clear previous barcode
      while (barcodeSvg.firstChild) {
        barcodeSvg.removeChild(barcodeSvg.firstChild);
      }

      if (fnsku) {
        JsBarcode(barcodeSvg, fnsku, {
          format: "CODE128",
          displayValue: false,
          margin: 0,
          fontSize: 8
        });
      }
    });
  }

  function clearAll() {
    document.getElementById('productName').value = "";
    document.getElementById('fnsku').value = "";
    document.getElementById('mrp').value = "";
    createLabelGrid(htmlSheet);
    createLabelGrid(printSheet);
    pdfPreview.src = "";
  }

  clearBtn.addEventListener('click', clearAll);

  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const productName = document.getElementById('productName').value.trim();
    const fnsku = document.getElementById('fnsku').value.trim();
    const mrp = document.getElementById('mrp').value.trim();

    if (!productName || !fnsku) {
      alert("Please fill Product Name and FNSKU.");
      return;
    }

    // Fill both preview and print sheets
    fillLabels(productName, fnsku, mrp, htmlSheet);
    fillLabels(productName, fnsku, mrp, printSheet);

    // Generate PDF from printSheet and show preview
    await generatePdfFromSheet(printSheet);
  });

  async function generatePdfFromSheet(sheetElement) {
    const { jsPDF } = window.jspdf;

    // Use html2canvas to capture the A4 sheet as an image
    const canvas = await html2canvas(sheetElement, {
      scale: 2,
      useCORS: true
    });

    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4'); // A4 portrait

    const pageWidth = 210;
    const imgWidth = pageWidth;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

    const blob = pdf.output('blob');
    const url = URL.createObjectURL(blob);

    // Show PDF in preview iframe
    pdfPreview.src = url;

    // If you also want auto-download, uncomment:
    // pdf.save('Amazon_FBA_Labels.pdf');
  }
</script>
<div th:replace="~{fragments/chatbot :: chatbot}"></div>
</body>
</html>
