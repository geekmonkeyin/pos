<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Geekmonkey — Purchase Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap 4.5 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>

    <style>
        :root{
          --bg:#F9FAFB; --card:#ffffff; --stroke:#E5E7EB; --text:#111827; --muted:#6B7280;
          --accent:#FF7A00; --accent-ink:#9A4D00; --radius:16px;
        }
        html,body{height:100%}
        body{background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}

        /* Header */
        .gm-header{position:sticky; top:0; z-index:1000; background:#fff; border-bottom:1px solid var(--stroke)}
        .gm-brand{display:flex; align-items:center; gap:.6rem; font-weight:700; letter-spacing:.2px; color:var(--text); text-decoration:none}
        .gm-dot{width:28px; height:28px; border-radius:10px; background:var(--accent); display:inline-block; box-shadow:0 8px 18px rgba(255,122,0,.25)}
        .btn-ghost{background:#fff; border:1px solid var(--stroke); color:var(--text); border-radius:12px}
        .btn-ghost:hover{border-color:#d6d9de; background:#fdfdfd}
        .btn-accent{background:var(--accent); color:#fff; border:0; border-radius:12px}
        .btn-accent:hover{background:#ff8d26}

        /* Page & cards */
        .gm-wrap{padding:20px}
        @media (min-width:992px){ .gm-wrap{padding:28px} }
        .gm-card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:0 4px 16px rgba(17,24,39,.04)}
        .req::after{content:" *"; color:#dc3545; font-weight:700}
        .muted{color:var(--muted)}

        /* Controls */
        .spinner-sm{width:1rem; height:1rem; border:.18rem solid #e5e7eb; border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; display:inline-block}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* Vendor dropdown (same pattern as before) */
        .vendor-results{position:relative}
        .vendor-panel{
          position:absolute; left:0; right:0; top:100%; z-index:1050; margin-top:.35rem;
          background:#fff; border:1px solid var(--stroke); border-radius:12px; box-shadow:0 12px 24px rgba(17,24,39,.08);
          max-height:260px; overflow:auto; display:none
        }
        .vendor-item{padding:.6rem .8rem; cursor:pointer}
        .vendor-item:hover{background:#FFF8F1}

        /* Table */
        .table thead th{background:#F3F4F6; border-bottom:1px solid var(--stroke)}
        .empty-state{padding:1rem; text-align:center; color:var(--muted)}

        /* Modal style tweak */
        .modal-content{border-radius:14px}

        /* Toast */
        .toast.gm-toast{background:#111827; color:#fff; border-radius:12px}
    </style>
</head>
<body>

<!-- Header -->
<nav class="gm-header">
    <div class="container d-flex align-items-center justify-content-between py-2">
        <a class="gm-brand" href="/v1/home" aria-label="Geekmonkey Home">
            <span class="gm-dot" aria-hidden="true"></span>
            <span>Geekmonkey</span>
        </a>
        <div class="d-flex">
            <button id="gmBackBtn" type="button" class="btn btn-ghost btn-sm mr-2" aria-label="Go Back">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="ml-1">Back</span>
            </button>
            <a href="/v1/home" class="btn btn-accent btn-sm" aria-label="Go Home">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M3 10.5l9-7 9 7V20a2 2 0 0 1-2 2h-4a2 2 0 0 1-2-2v-4H9v4a2 2 0 0 1-2 2H3v-9.5z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="ml-1">Home</span>
            </a>
        </div>
    </div>
</nav>

<!-- Main -->
<main class="gm-wrap">
    <div class="container">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="m-0 font-weight-bold">Purchase Report</h1>
        </div>

        <div class="gm-card p-3 p-md-4 mb-3">
            <!-- Filters -->
            <form id="filterForm" class="mb-2">
                <div class="form-row">
                    <div class="form-group col-md-4 vendor-results">
                        <label for="vendorName" class="mb-1">Vendor Name</label>
                        <div class="d-flex align-items-center">
                            <input type="text" id="vendorName" class="form-control" placeholder="Type vendor name (min 3 chars)" autocomplete="off">
                            <span id="vendorSpin" class="spinner-sm ml-2" style="display:none"></span>
                        </div>
                        <input type="hidden" id="vendorId" name="vendorId" />
                        <div id="vendorPanel" class="vendor-panel"></div>
                        <small class="muted">Pick from list to lock the vendor.</small>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="startDate" class="mb-1">Start Date</label>
                        <input type="date" id="startDate" name="startDate" class="form-control">
                    </div>
                    <div class="form-group col-md-3">
                        <label for="endDate" class="mb-1">End Date</label>
                        <input type="date" id="endDate" name="endDate" class="form-control">
                    </div>
                    <div class="form-group col-md-2 d-flex align-items-end">
                        <button id="btnSearch" type="button" class="btn btn-accent w-100">
                            <span id="searchLabel">Search</span>
                            <span id="searchSpin" class="spinner-sm ml-2" style="display:none"></span>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Table -->
            <div class="table-responsive">
                <table class="table table-sm mb-2" id="reportTable">
                    <thead>
                    <tr>
                        <th>Vendor</th>
                        <th>Order ID</th>
                        <th class="text-right">Amount</th>
                        <th>Order Date</th>
                        <th style="width:120px">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="reportBody">
                    <tr><td colspan="5" class="empty-state">Run a search to see results.</td></tr>
                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="2" class="text-right font-weight-bold">Total Amount:</td>
                        <td id="totalAmountCell" class="text-right font-weight-bold">₹0.00</td>
                        <td colspan="2"></td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Update Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Purchase</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="updateForm">
                <div class="modal-body">
                    <input type="hidden" id="orderId" name="orderId">
                    <div class="form-group">
                        <label for="vendorNameUpdate">Vendor Name</label>
                        <input type="text" id="vendorNameUpdate" class="form-control" placeholder="Vendor Name">
                    </div>
                    <div class="form-group">
                        <label for="amountUpdate">Amount</label>
                        <input type="number" id="amountUpdate" class="form-control" min="0" step="0.01" placeholder="Amount">
                    </div>
                    <div class="form-group">
                        <label for="orderDateUpdate">Order Date</label>
                        <input type="date" id="orderDateUpdate" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-ghost" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-accent" id="btnUpdateSubmit">
                        <span id="updateLabel">Submit</span>
                        <span id="updateSpin" class="spinner-sm ml-2" style="display:none"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed" style="bottom:16px; right:16px; z-index:1080;">
    <div id="toast" class="toast gm-toast" role="alert" data-delay="2600">
        <div class="toast-body" id="toastMsg">—</div>
    </div>
</div>

<script>
    // ===== Helpers =====
    const $ = (s)=>document.querySelector(s);
    const curryEl = (sel, root=document)=>root.querySelector(sel);
    const toast = (msg)=>{ $('#toastMsg').textContent = msg; $('#toast').classList.add('show'); setTimeout(()=>$('#toast').classList.remove('show'), 2800); };
    const formatCurrency = (n)=> new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:2 }).format(Number(n||0));

    // Header back
    (function(){
      const backBtn = $('#gmBackBtn');
      if (backBtn){
        backBtn.addEventListener('click', ()=>{
          if (history.length > 1) { try{ history.back(); return; } catch(e){} }
          location.href = '/v1/home';
        });
      }
    })();

    // ===== Vendor search (debounced) =====
    let selectedVendor = null; // {vendorId, vendorName}
    function debounce(fn, wait=350){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); } }
    async function fetchVendors(q){
      if (!q || q.trim().length < 3){ $('#vendorPanel').style.display='none'; return; }
      $('#vendorSpin').style.display='';
      try{
        const res = await fetch(`/v1/vendor/search/${encodeURIComponent(q.trim())}`);
        const data = await res.json();
        const panel = $('#vendorPanel'); panel.innerHTML='';
        (data||[]).forEach(v=>{
          const item = document.createElement('div');
          item.className='vendor-item';
          item.innerHTML = `<div class="font-weight-bold">${v.vendorName}</div><div class="text-muted small">ID: ${v.vendorName}</div>`;
          item.addEventListener('click', ()=> selectVendor(v));
          panel.appendChild(item);
        });
        panel.style.display = (data && data.length) ? 'block' : 'none';
      }catch(e){
        console.error(e);
        $('#vendorPanel').style.display='none';
      }finally{
        $('#vendorSpin').style.display='none';
      }
    }
    const debouncedFetch = debounce(fetchVendors, 350);

    function selectVendor(v){
      selectedVendor = { vendorId: v.vendorName, vendorName: v.vendorName };
      $('#vendorName').value = v.vendorName;
      $('#vendorId').value = v.vendorName;
      $('#vendorPanel').style.display='none';
    }
    $('#vendorName').addEventListener('input', (e)=>{ selectedVendor = null; $('#vendorId').value=''; debouncedFetch(e.target.value); });
    document.addEventListener('click', (e)=>{ if (!e.target.closest('.vendor-results')) $('#vendorPanel').style.display='none'; });

    // ===== Search/Filter =====
    async function fetchReport(){
      const btn = $('#btnSearch'), lab=$('#searchLabel'), spin=$('#searchSpin');
      const vendorId = $('#vendorId').value || '';
      const startDate = $('#startDate').value || '';
      const endDate   = $('#endDate').value || '';

      btn.disabled = true; spin.style.display=''; lab.textContent='Searching...';

      const params = new URLSearchParams();
      if (vendorId) params.set('vendorName', vendorId);
      if (startDate) params.set('startDate', startDate);
      if (endDate) params.set('endDate', endDate);

      try{
        const res = await fetch(`/v1/vendor/purchase/filterReport?${params.toString()}`);
        const data = await res.json();

        const tbody = $('#reportBody'); tbody.innerHTML = '';
        let total = 0;

        if (!data || !data.length){
          tbody.innerHTML = `<tr><td colspan="5" class="empty-state">No results found.</td></tr>`;
        } else {
          data.forEach(order=>{
            // Normalize fields
            const orderId = order.orderId;
            const vendorName = order.vendorName || '';
            const amount = Number(order.totalAmount ?? order.amount ?? 0);
            const orderDate = order.orderDate || '';

            total += amount;

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${escapeHtml(vendorName)}</td>
              <td>${escapeHtml(String(orderId))}</td>
              <td class="text-right">${formatCurrency(amount)}</td>
              <td>${escapeHtml(orderDate)}</td>
              <td>
                <button class="btn btn-sm btn-ghost" data-action="edit">Edit</button>
              </td>
            `;
            tr.querySelector('[data-action="edit"]').addEventListener('click', ()=>{
              showUpdateModal({ orderId, vendorName, amount, orderDate });
            });
            tbody.appendChild(tr);
          });
        }

        $('#totalAmountCell').textContent = formatCurrency(total);
      }catch(err){
        console.error(err);
        toast('Failed to fetch report');
      }finally{
        btn.disabled = false; spin.style.display='none'; lab.textContent='Search';
      }
    }
    $('#btnSearch').addEventListener('click', fetchReport);

    // ===== Update modal =====
    function showUpdateModal({ orderId, vendorName, amount, orderDate }){
      $('#orderId').value = orderId;
      $('#vendorNameUpdate').value = vendorName || '';
      $('#amountUpdate').value = amount ?? '';
      $('#orderDateUpdate').value = orderDate || '';
      $('#updateModal').modal('show');
    }

    function setUpdating(b){
      $('#btnUpdateSubmit').disabled = !!b;
      $('#updateSpin').style.display = b ? '' : 'none';
      $('#updateLabel').textContent = b ? 'Submitting...' : 'Submit';
    }

    async function submitUpdate(){
      const orderId = $('#orderId').value;
      const vendorName = $('#vendorNameUpdate').value.trim();
      const orderDate = $('#orderDateUpdate').value;
      const totalAmount = Number($('#amountUpdate').value);

      if (!orderId){ toast('Missing order id'); return; }

      const payload = { orderId, vendorName, orderDate, totalAmount };

      try{
        setUpdating(true);
        const res = await fetch('/v1/vendor/purchase/update', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok){
          const text = await res.text().catch(()=> 'Failed');
          throw new Error(text || `HTTP ${res.status}`);
        }
        toast('Purchase order updated ✔');
        $('#updateModal').modal('hide');
        fetchReport();
      }catch(err){
        console.error(err);
        toast('Update failed: ' + (err.message || 'Unexpected error'));
      }finally{
        setUpdating(false);
      }
    }
    $('#btnUpdateSubmit').addEventListener('click', submitUpdate);

    // ===== Utils =====
    function escapeHtml(str){
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
</script>

<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>
