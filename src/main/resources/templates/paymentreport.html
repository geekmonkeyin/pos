<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Geekmonkey — Upload Payment</title>

    <!-- Brand Spinner (Thymeleaf path preserved) -->
    <link rel="stylesheet" th:href="@{../../assets/css/spinner.css}" />

    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

    <style>
        :root{
          --bg:#F9FAFB; --card:#FFFFFF; --stroke:#E5E7EB; --text:#111827; --muted:#6B7280;
          --accent:#FF7A00; --accent-ink:#9A4D00; --accent-weak:#FFE5D0; --radius:14px;
        }
        html, body { height:100%; background:var(--bg); color:var(--text); }
        body { line-height:1.6; }

        /* ===== Top bar ===== */
        .gm-topbar{
          position: sticky; top: 0; z-index: 1030;
          background: linear-gradient(90deg, var(--accent), #FF9A3D);
          color: #fff; box-shadow: 0 8px 18px rgba(0,0,0,0.08);
        }
        .gm-topbar .brand{ font-weight:700; letter-spacing:.3px; }
        .gm-icon-btn{
          border-radius:12px; border:1px solid rgba(255,255,255,.65);
          background:transparent; color:#fff; padding:.45rem .7rem;
        }
        .gm-icon-btn:hover{ background:rgba(255,255,255,.14); color:#fff; }

        /* ===== Card / form ===== */
        .gm-card{
          background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
          box-shadow:0 8px 24px rgba(17,24,39,0.06);
        }
        .form-control, .form-select{ border-color:var(--stroke); border-radius:12px; }
        .form-control:focus, .form-select:focus{
          border-color:var(--accent); box-shadow:0 0 0 .25rem rgba(255,122,0,.15);
        }
        .btn-accent{
          background:var(--accent); color:#fff; border:none; border-radius:12px; font-weight:600;
        }
        .btn-accent:hover{ background:#ff8f29; color:#fff; }
        .form-hint{ color:var(--muted); font-size:.86rem; }

        /* Vendor dropdown */
        .vendor-wrap{ position:relative; }
        #vendorDropdown{
          position:absolute; left:0; right:0; top:100%; z-index:1020;
          display:none; max-height:260px; overflow:auto; margin-top:6px;
          border-radius:12px; border:1px solid var(--stroke); box-shadow:0 10px 24px rgba(17,24,39,.08);
        }
        #vendorDropdown .list-group-item{ cursor:pointer; }
        #vendorDropdown .list-group-item:hover{ background:#FFF7EF; }

        /* Page spacing */
        main{ padding:24px 16px; }
        .page-title{ font-weight:800; font-size:1.25rem; }
    </style>
</head>
<body>

<!-- ===== Top bar ===== -->
<nav class="gm-topbar">
    <div class="container d-flex align-items-center justify-content-between py-2">
        <div class="d-flex align-items-center gap-2">
            <button id="backBtn" class="gm-icon-btn" type="button" title="Back">
                <i class="bi bi-arrow-left"></i>
            </button>
            <button id="homeBtn" class="gm-icon-btn" type="button" title="Home">
                <i class="bi bi-house-door"></i>
            </button>
        </div>
        <div class="brand">Geekmonkey • Upload Payment</div>
        <div></div>
    </div>
</nav>

<!-- ===== Content ===== -->
<main>
    <div class="container" style="max-width: 760px;">
        <div class="gm-card p-3 p-md-4">
            <h1 class="page-title mb-3">Upload Payment</h1>
            <form action="/v1/uploadPayment" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                <!-- Screenshot -->
                <div class="mb-3">
                    <label for="screenshot" class="form-label">Upload Screenshot</label>
                    <input id="screenshot" name="screenshot" type="file" accept="image/*" class="form-control" required />
                    <div class="form-hint">Attach a clear screenshot of the payment confirmation.</div>
                    <div class="invalid-feedback">Screenshot is required.</div>
                </div>

                <!-- Payment To -->
                <div class="mb-3">
                    <label for="paymentTo" class="form-label">Payment To</label>
                    <input id="paymentTo" name="paymentTo" type="text" class="form-control" placeholder="Enter payment recipient" required />
                    <div class="invalid-feedback">Please enter who the payment was made to.</div>
                </div>

                <!-- Vendor (searchable) -->
                <div class="mb-3 vendor-wrap">
                    <label for="vendorName" class="form-label">Vendor Name</label>
                    <input id="vendorName" name="vendorName" type="text" class="form-control" placeholder="Type at least 3 characters" required />
                    <ul id="vendorDropdown" class="list-group"></ul>

                    <div id="vendorSpinner" class="text-center mt-2" style="display:none;">
                        <div class="spinner-border text-warning spinner-border-sm" role="status" aria-hidden="true"></div>
                        <span class="ms-2 form-hint">Searching vendors…</span>
                    </div>
                    <div class="invalid-feedback">Please enter a vendor name.</div>
                </div>

                <!-- Amount -->
                <div class="mb-3">
                    <label for="amount" class="form-label">Amount</label>
                    <input id="amount" name="amount" type="number" step="0.01" class="form-control" placeholder="Enter amount" required />
                    <div class="invalid-feedback">Amount is required.</div>
                </div>

                <!-- Date -->
                <div class="mb-3">
                    <label for="date" class="form-label">Date</label>
                    <input id="date" name="date" type="date" class="form-control" required />
                    <div class="invalid-feedback">Please select the payment date.</div>
                </div>

                <!-- WhatsApp -->
                <div class="mb-3">
                    <label for="whatsappNumber" class="form-label">WhatsApp Number</label>
                    <input id="whatsappNumber" name="whatsappNumber" type="tel" class="form-control" placeholder="Enter WhatsApp number" required />
                    <div class="invalid-feedback">WhatsApp number is required.</div>
                </div>

                <!-- Remarks -->
                <div class="mb-3">
                    <label for="remarks" class="form-label">Remarks</label>
                    <input id="remarks" name="remarks" type="text" class="form-control" placeholder="Enter remarks" required />
                    <div class="invalid-feedback">Please add a short remark.</div>
                </div>

                <div class="d-grid">
                    <button class="btn btn-accent btn-lg" type="submit">
                        <i class="bi bi-cloud-upload me-2"></i>Submit
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<!-- ===== Scripts ===== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Header buttons
    document.getElementById('homeBtn').addEventListener('click', () => {
      window.location.href = '/v1/home';
    });
    document.getElementById('backBtn').addEventListener('click', () => {
      if (history.length > 1) {
        history.back();
      } else {
        window.location.href = '/v1/home';
      }
    });

    // Default date = today if empty
    (function setToday(){
      const d = document.getElementById('date');
      if (!d.value) {
        const t = new Date();
        const mm = String(t.getMonth()+1).padStart(2,'0');
        const dd = String(t.getDate()).padStart(2,'0');
        d.value = `${t.getFullYear()}-${mm}-${dd}`;
      }
    })();

    // Bootstrap validation
    (function () {
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) { event.preventDefault(); event.stopPropagation(); }
          form.classList.add('was-validated');
        }, false);
      });
    })();

    // ===== Vendor search (debounced) =====
    let debounceTimer;
    const vendorInput = document.getElementById('vendorName');
    const vendorDropdown = document.getElementById('vendorDropdown');
    const vendorSpinner = document.getElementById('vendorSpinner');

    vendorInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(fetchVendorDetails, 2000); // 2s debounce (as requested)
    });

    function fetchVendorDetails(){
      const q = vendorInput.value.trim();
      if (q.length < 3){ vendorDropdown.style.display = 'none'; return; }

      vendorSpinner.style.display = 'block';
      fetch('/v1/vendor/search/' + encodeURIComponent(q))
        .then(r => r.json())
        .then(list => {
          vendorDropdown.innerHTML = '';
          if (Array.isArray(list) && list.length){
            list.forEach(vendor => {
              const item = document.createElement('a');
              item.className = 'list-group-item list-group-item-action';
              item.textContent = vendor.vendorName;
              item.onclick = () => selectVendor(vendor);
              vendorDropdown.appendChild(item);
            });
            vendorDropdown.style.display = 'block';
          } else {
            vendorDropdown.style.display = 'none';
          }
        })
        .catch(() => { vendorDropdown.style.display = 'none'; })
        .finally(() => { vendorSpinner.style.display = 'none'; });
    }

    function selectVendor(vendor){
      vendorInput.value = vendor.vendorName || '';
      const wa = document.getElementById('whatsappNumber');
      if (vendor.vendorContact) wa.value = vendor.vendorContact;
      vendorDropdown.style.display = 'none';
    }

    // Hide dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!document.querySelector('.vendor-wrap').contains(e.target)) {
        vendorDropdown.style.display = 'none';
      }
    });

    // Keyboard navigation for dropdown (basic)
    vendorInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') vendorDropdown.style.display = 'none';
    });
</script>
</body>
</html>
