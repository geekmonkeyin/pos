<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Update Inventory</title>
    <link rel="stylesheet" th:href="@{../../assets/css/spinner.css}">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .form-group {
            margin-bottom: 20px;
        }
        .barcode-icon, .edit-icon {
            cursor: pointer;
        }
        .container {
            max-width: 800px;
            margin-top: 50px;
        }
        .btn-primary {
            width: 100%;
            padding: 10px;
            font-size: 18px;
        }
        .input-group-text {
            background-color: #007bff;
            color: white;
        }
        .input-group-text:hover {
            background-color: #0056b3;
        }
        .edit-icon {
            margin-left: 10px;
        }
         .image-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px; /* Space between thumbnails */
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f9f9f9;
}

.image-container img {
    width: 100px; /* Thumbnail width */
    height: 100px; /* Thumbnail height */
    object-fit: cover; /* Ensures the image fits within the thumbnail */
    border: 1px solid #ccc;
    border-radius: 5px;
    transition: transform 0.2s ease-in-out;
}

.image-container img:hover {
    transform: scale(1.1); /* Slight zoom effect on hover */
    border-color: #007bff;
}
    </style>
</head>
<body>

<div>
    <button id="backButton" onclick="goBack()" style="position: fixed; top: 10px; left: 10px;">Back</button>
    <button id="homeButton" onclick="goHome()" style="position: fixed; top: 10px; left: 60px;background-color:#28a745;color:#ffff">Home</button>
</div>
<div class="container">
    <h1 class="text-center my-4">Update Inventory</h1>
    <form onsubmit="updateInventory(event)">
        <div class="form-group">
            <label for="barcode">Scan Barcode</label>
            <div class="input-group">
                <input class="form-control" id="barcode" placeholder="Scan or enter barcode" type="text">
                <div class="input-group-append">
                    <span class="input-group-text barcode-icon">&#128424;</span>
                </div>
            </div>
            <label for="devicename">Device Name</label>
            <div class="input-group">
                <input class="form-control" id="devicename" placeholder="Device Name" type="text">
                <div class="input-group-append">
                    <span class="input-group-text barcode-icon">&#128424;</span>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="searchProduct">Search for Products</label>
            <div class="input-group">
                <input class="form-control" id="searchProduct" placeholder="Search for products" type="text">

            </div>
            <ul class="list-group" id="productList" style="display: none;"></ul>
        </div>
        <div class="form-group">
            <label for="location">Location</label>
            <div class="input-group">
                <input class="form-control" disabled id="location" type="text">
                <div class="input-group-append">
                    <span class="input-group-text edit-icon">&#9998;</span>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="productId">Product Id</label>
            <input class="form-control" disabled id="productId" type="text">
            <div class="input-group-append">
                <span class="input-group-text reset-icon" style="cursor: pointer;">&#x21bb;</span>
            </div>
        </div>

        <div class="form-group">
            <label for="productVariantId">Variant Id</label>
            <input class="form-control" disabled id="productVariantId" type="text">
        </div>
        <div id='containerId' class="image-container">
            <img id="productImagePreviewVariant" src="#" alt="Product Image" style="display: none; max-width: 100%;">
        </div>
        <div class="form-group">
            <label for="currentShopifyStock">Current Shopify Stock</label>
            <input class="form-control" disabled id="currentShopifyStock" type="number">
        </div>
        <div class="form-group">
            <label for="quantity">Quantity</label>
            <div class="input-group">
                <input class="form-control" disabled id="quantity" type="number">
                <div class="input-group-append">
                    <span class="input-group-text edit-icon">&#9998;</span>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="remarks">Remarks</label>
            <div class="input-group">
                <input class="form-control" disabled id="remarks" type="text">
                <div class="input-group-append">
                    <span class="input-group-text edit-icon">&#9998;</span>
                </div>
            </div>
        </div>
        <div class="form-group">
            <label for="productImage">Product Image</label>
            <div class="input-group">
                <input class="form-control" disabled id="productImage" type="file">
                <div class="input-group-append">
                    <span class="input-group-text edit-icon">&#9998;</span>
                </div>
            </div>
            <img alt="Product Image" id="productImagePreview" src="#"
                 style="display: none; margin-top: 10px; max-width: 100%;">
        </div>
        <button class="btn btn-primary" type="submit">Update</button>
    </form>
</div>
<div class="spinner" id="spinner">
    <div class="rect1" style="background-color:Orange;"></div>
    <div class="rect2" style="background-color:green;"></div>
    <div class="rect3" style="background-color:red;"></div>
    <div class="rect4" style="background-color:pink;"></div>
    <div class="rect5" style="background-color:blueviolet;"></div>
</div>

<div>
    <h2 class="text-center my-4">Stock History</h2>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Product ID</th>
            <th>Location</th>
            <th>Quantity</th>
            <th>Updated Date</th>
            <th>Remarks</th>
            <th>Images</th>
        </tr>
        </thead>
        <tbody id="stockHistoryTable">
        <!-- Stock history will be populated here -->
        </tbody>
    </table>
</div>


<script>
    let barcodeInputTimeout;

        document.getElementById('barcode').addEventListener('input', function() {
           clearTimeout(barcodeInputTimeout); // Clear any existing timeout
        barcodeInputTimeout = setTimeout(() => {
            const barcode = this.value;
            if (barcode) {
                enableDisableProgressBar('block')
                var searchProduct = document.getElementById('searchProduct');

                searchProductFromAPI(barcode,true);
            }
            }, 2000); // 2-second delay
        });

        function enableDisableProgressBar(enable){
            document.getElementById("spinner").style.display = enable;
        }

     document.querySelector('.barcode-icon').addEventListener('click', function() {
      alert('Barcode scanner functionality to be implemented');
            Android.performAction();
         });


    document.querySelectorAll('.edit-icon').forEach(function(icon) {
     icon.addEventListener('click', function() {
         const input = this.parentElement.previousElementSibling;
         input.disabled = !input.disabled;
         if (!input.disabled) {
             input.focus();
         }
     });
    });

    document.getElementById('searchProduct').addEventListener('input', function() {
     const query = this.value.toLowerCase();
     const productList = document.getElementById('productList');
     productList.style.display = query ? 'block' : 'none';
     // Implement product search functionality here
     if(query.length < 5) {
         return;
     }
     searchProducts();
    });


    document.getElementById('productImage').addEventListener('change', function() {
     const file = this.files[0];
     if (file) {
         const reader = new FileReader();
         reader.onload = function(e) {
             const img = document.getElementById('productImagePreview');
             img.src = e.target.result;
             img.style.display = 'block';
         };
         reader.readAsDataURL(file);
     }
    });


        function searchProductFromAPI(query,barcodeSearched){

                fetch(`/v1/inventory/search?query=`+query)
                .then(response => response.json())
                .then(data => {
                    const productList = document.getElementById('productList');
                    productList.innerHTML = '';
                    data.forEach(product => {
                        const item = document.createElement('a');
                        item.classList.add('list-group-item', 'list-group-item-action');
                        item.textContent = product.productTitle+ '(' +product.productVariantTitle+ ')';
                        item.onclick = () => displayProductInfo(product);
                        productList.appendChild(item);
                    });
                     enableDisableProgressBar('none')
                     if(barcodeSearched){
                        document.getElementById('searchProduct').value = query;

                     }
                });
        }


        function searchProducts(){

            const query = document.getElementById('searchProduct').value;
            if (query.length < 5) {
                return;
            }
            enableDisableProgressBar('block')
            searchProductFromAPI(query,false)

        }
        function displayProductInfo(product) {
        // Hide the product list
        document.getElementById('productList').style.display = 'none';

        // Update the storage/location, quantity, and product name fields
        document.getElementById('location').value = product.storage;
        document.getElementById('quantity').value = product.quantity;
        document.getElementById('searchProduct').value = product.productTitle;
        document.getElementById('currentShopifyStock').value = product.shopifyQuantity;
        if(product.imageUrl){
            document.getElementById('productImagePreviewVariant').src = product.imageUrl;
            document.getElementById('productImagePreviewVariant').style.display = 'block';
        }else{
            document.getElementById('productImagePreviewVariant').style.display = 'none';
        }
         document.getElementById('productVariantId').value = product.productVariantId;

         document.getElementById('productId').value = product.productId;


         populateStockHistory(product);
    }

        function updateInventory(){
            var location = document.getElementById('location').value;
            var quantity = document.getElementById('quantity').value;
            var deviceName = document.getElementById('devicename').value;

            $.ajax({
                url: '/v1/inventory/updateInventory',
                type: 'POST',
                data: JSON.stringify({
                    location: location,
                    quantity: quantity,
                    deviceName: deviceName,
                    images: document.getElementById('productImage').files,
                }),
                contentType: 'application/json',
                success: function(response) {
                    alert('Inventory updated successfully');
                },
                error: function(xhr, status, error) {
                    alert('Error updating inventory');
                }
            });
        }

        function updateInventory(event) {
            event.preventDefault(); // Prevent the default form submission

            var formData = new FormData();
            formData.append("productId",document.getElementById('productVariantId').value);
            formData.append("location", document.getElementById('location').value);
            formData.append("quantity", document.getElementById('quantity').value);
            formData.append("remarks",document.getElementById('remarks').value);
            formData.append("deviceName",document.getElementById('devicename').value);
            var files = document.getElementById('productImage').files;
            for (var i = 0; i < files.length; i++) {
                formData.append("images", files[i]);
            }

            $.ajax({
                url: '/v1/inventory/updateInventory',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    alert('Inventory updated successfully');
                },
                error: function(xhr, status, error) {
                    alert('Error updating inventory');
                }
            });
        }


        function populateStockHistory(product) {
            var table = document.getElementById('stockHistoryTable');
            var productId =  product.productId;
         if(product.productVariantId){
            productId = product.productVariantId;
         }
            var stockHistory = product.stockHistory;
            if(stockHistory){
                stockHistory.forEach(function(stock) {
                    var row = table.insertRow();
                    row.insertCell(0).innerText = productId;
                    row.insertCell(1).innerText = stock.storage;
                    row.insertCell(2).innerText = stock.quantity;
                    row.insertCell(3).innerText = stock.updatedDate;
                    row.insertCell(4).innerText = stock.remarks;

                    var imagesCell = row.insertCell(5);
                    stock.images.forEach(function(image) {
                        var viewButton = document.createElement('button');
                        viewButton.innerText = 'View Image';
                        viewButton.classList.add('btn', 'btn-primary', 'btn-sm');
                        viewButton.onclick = function() {
                            window.open('/v1/inventory/images/' + image, '_blank');
                        };
                        imagesCell.appendChild(viewButton);
                    });
                });
            }

        }

        function onBarcodeScanned(barcode){
                alert("Barcode received" + barcode);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const barcodeParam = urlParams.get('barcode');
            const deviceName = urlParams.get('devicename');

            if(deviceName){
                const deviceNameInput = document.getElementById('devicename');
                deviceNameInput.value = deviceName;

            }
            if (barcodeParam) {
                const barcodeInput = document.getElementById('searchProduct');
                barcodeInput.value = barcodeParam;

                // Trigger any additional logic if needed
                barcodeInput.dispatchEvent(new Event('input'));
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const backButton = document.getElementById('backButton');
            if (window.location.pathname === '/home' || window.location.pathname === '/') {
                backButton.style.display = 'none'; // Hide back button on the home page
            }
        });

        function goBack() {
            window.history.back(); // Navigate to the previous page
        }
         function goHome() {
            window.history.back(); // Navigate to the previous page
        }

    document.querySelector('.reset-icon').addEventListener('click', function () {
    const productId = document.getElementById('productId').value;
    if (!productId) {
        alert('No product ID found to reset.');
        return;
    }

    if (confirm('Are you sure you want to reset this product?')) {
        fetch(`/v1/inventory/resetProduct?productId=`+productId, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }

        })
            .then(response => {
                if (response.ok) {
                    alert('Product reset successfully.');
                } else {
                    alert('Failed to reset the product.');
                }
            })
            .catch(error => {
                console.error('Error resetting product:', error);
                alert('An error occurred while resetting the product.');
            });
    }
});



</script>
</body>
</html>