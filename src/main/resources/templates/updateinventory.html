<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Geekmonkey — Inventory & Labels</title>

    <!-- Brand Spinner -->
    <link rel="stylesheet" th:href="@{../../assets/css/spinner.css}" />

    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <!-- Utilities -->
    <script th:src="@{../../../assets/scripts/inventory-utils.js}"></script>

    <style>
        :root{
          --bg:#F9FAFB; --card:#FFFFFF; --stroke:#E5E7EB; --text:#111827; --muted:#6B7280;
          --accent:#FF7A00; --accent-ink:#9A4D00; --radius:14px;
        }

        html, body { height: 100%; background: var(--bg); color: var(--text); }

        /* ===== Header (Orange / White) ===== */
        .gm-navbar { background: var(--accent); border-bottom:1px solid var(--accent-ink); }
        .gm-brand { font-weight:700; letter-spacing:.2px; color:#fff; }
        .gm-icon-btn { border-radius:12px; border:1px solid #fff; background: transparent; color:#fff; }
        .gm-icon-btn:hover{ background:#fff; color: var(--accent); border-color:#fff; }

        /* ===== Layout ===== */
        .gm-container { max-width: 1100px; margin: 0 auto; padding: 24px; }
        .gm-card { background: var(--card); border:1px solid var(--stroke); border-radius: var(--radius); }
        .gm-card-header { border-bottom:1px solid var(--stroke); }

        /* Inputs */
        .form-control:focus { box-shadow: none; border-color: #FFC08F; }

        /* Buttons */
        .btn-accent { background: var(--accent); color:#fff; border:none; border-radius:12px; }
        .btn-accent:hover{ background:#FF8F29; color:#fff; }

        /* Helpers */
        .gm-muted { color: var(--muted); }
        .gm-img { max-width: 220px; border-radius:12px; border:1px solid var(--stroke); }
        .list-group-item { cursor:pointer; }
        .list-group-item:hover { background:#FFF7EF; }

        /* Thumbnails in product selectors */
        .list-thumb { width:44px; height:44px; object-fit:cover; border-radius:10px; border:1px solid var(--stroke); background:#F3F4F6; flex:0 0 44px; }
        .list-thumb.placeholder { display:inline-flex; align-items:center; justify-content:center; font-size:20px; color:var(--muted); }

        /* Modal */
        .modal-content { border-radius: 16px; }

        /* Spacer for fixed header */
        main { padding-top: 84px; }

        /* Tab styles */
        .nav-pills .nav-link { border-radius: 10px; }
        .nav-pills .nav-link.active{ background: var(--accent); }

        /* QR label preview text */
        #qrcode div { font-size: 10px; line-height: 1.2; }

        /* Image grid */
        .thumb-grid { display:flex; flex-wrap:wrap; gap:10px; }
        .thumb-grid img { width:96px; height:96px; object-fit:cover; border-radius:10px; border:1px solid var(--stroke); transition: transform .15s ease; }
        .thumb-grid img:hover { transform: scale(1.05); }

        /* Inline action chips */
        .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--stroke); border-radius:999px; font-size:12px; color:var(--muted); }
        .chip i { color: var(--accent); }

        /* Camera box */
        #camBox .ratio>video, #camBox .ratio>canvas, #camBox .ratio>img { object-fit: cover; }
    </style>
</head>
<body>
<!-- ===== Header ===== -->
<nav class="navbar navbar-expand-lg gm-navbar fixed-top">
    <div class="container-fluid px-3">
        <div class="d-flex align-items-center gap-2">
            <button id="btnBack" class="btn gm-icon-btn me-2" type="button" title="Back">
                <i class="bi bi-arrow-left"></i>
            </button>
            <a id="btnHome" class="btn gm-icon-btn me-2" role="button" title="Home">
                <i class="bi bi-house"></i>
            </a>
            <span class="gm-brand">Geekmonkey</span>
        </div>
        <div class="d-flex align-items-center">
            <span class="text-white small">Inventory · Management</span>
        </div>
    </div>
</nav>

<!-- ===== Content ===== -->
<main>
    <div class="gm-container">
        <div class="gm-card shadow-sm">
            <div class="gm-card-header p-3">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <h5 class="mb-0"><i class="bi bi-boxes gm-accent me-2"></i>Inventory & Labels</h5>
                    <ul class="nav nav-pills" id="labelTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="inventory-tab" data-bs-toggle="pill" data-bs-target="#inventoryPane" type="button" role="tab">Update Inventory</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="product-tab" data-bs-toggle="pill" data-bs-target="#productPane" type="button" role="tab">Product Labels</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="storage-tab" data-bs-toggle="pill" data-bs-target="#storagePane" type="button" role="tab">Storage Labels</button>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="p-3 p-md-4">
                <div class="tab-content" id="tabContent">

                    <!-- ================= Update Inventory Pane ================= -->
                    <div class="tab-pane fade show active" id="inventoryPane" role="tabpanel" aria-labelledby="inventory-tab">
                        <form id="invForm" class="needs-validation" novalidate>
                            <div class="row g-3">
                                <!-- Scan & Device -->
                                <div class="col-12 col-lg-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title mb-3"><i class="bi bi-upc-scan gm-accent me-2"></i>Scan / Identify</h6>

                                            <div class="mb-3">
                                                <label class="form-label" for="barcode">Scan Barcode</label>
                                                <div class="input-group">
                                                    <input id="barcode" type="text" class="form-control" placeholder="Scan or enter barcode" autocomplete="off" />
                                                    <span class="input-group-text" id="btnScan" title="Trigger scanner">
                            <i class="bi bi-qr-code-scan"></i>
                          </span>
                                                </div>
                                                <div class="form-text">Tip: Paste/scan barcode; search will auto-trigger.</div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label" for="devicename">Device Name</label>
                                                <div class="input-group">
                                                    <input id="devicename" type="text" class="form-control" placeholder="Device Name" />
                                                    <span class="input-group-text chip"><i class="bi bi-cpu"></i> device</span>
                                                </div>
                                            </div>

                                            <!-- NEW: Employee ID (mandatory) -->
                                            <div class="mb-0">
                                                <label class="form-label" for="empid">Employee ID <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <input id="empid" name="empId" type="text" class="form-control" placeholder="Enter Employee ID" required />
                                                    <span class="input-group-text chip"><i class="bi bi-person-badge"></i> emp</span>
                                                </div>
                                                <div class="invalid-feedback">Employee ID is required.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Search & Select Product -->
                                <div class="col-12 col-lg-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title mb-3"><i class="bi bi-search gm-accent me-2"></i>Find Product</h6>
                                            <label class="form-label" for="searchProduct">Search for Products</label>
                                            <input id="searchProduct" type="text" class="form-control" placeholder="Type 3+ characters" autocomplete="off" />
                                            <div id="spinner" class="mt-2" style="display:none;">
                                                <div class="spinner-border text-warning spinner-border-sm" role="status"></div>
                                                <span class="ms-2 small gm-muted">Searching…</span>
                                            </div>
                                            <ul id="productList" class="list-group mt-2" style="display:none;"></ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Details & Edits -->
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title mb-3"><i class="bi bi-info-circle gm-accent me-2"></i>Product Details</h6>
                                            <div class="row g-3 align-items-end">
                                                <div class="col-sm-6 col-md-3">
                                                    <label class="form-label" for="location">Location</label>
                                                    <div class="input-group">
                                                        <input id="location" type="text" class="form-control" disabled />
                                                        <button type="button" class="btn btn-outline-secondary js-toggle-edit" data-target="#location" title="Edit"><i class="bi bi-pencil"></i></button>
                                                    </div>
                                                </div>
                                                <div class="col-sm-6 col-md-3">
                                                    <label class="form-label" for="currentShopifyStock">Current Shopify Stock</label>
                                                    <input id="currentShopifyStock" type="number" class="form-control" disabled />
                                                </div>
                                                <div class="col-sm-6 col-md-3">
                                                    <label class="form-label" for="quantity">Quantity</label>
                                                    <div class="input-group">
                                                        <input id="quantity" type="number" class="form-control" disabled />
                                                        <button type="button" class="btn btn-outline-secondary js-toggle-edit" data-target="#quantity" title="Edit"><i class="bi bi-pencil"></i></button>
                                                    </div>
                                                </div>
                                                <div class="col-sm-6 col-md-3">
                                                    <label class="form-label" for="remarks">Remarks</label>
                                                    <div class="input-group">
                                                        <input id="remarks" type="text" class="form-control" disabled />
                                                        <button type="button" class="btn btn-outline-secondary js-toggle-edit" data-target="#remarks" title="Edit"><i class="bi bi-pencil"></i></button>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row g-3 mt-1">
                                                <div class="col-md-4">
                                                    <label class="form-label" for="productId">Product ID</label>
                                                    <div class="input-group">
                                                        <input id="productId" type="text" class="form-control" disabled />
                                                        <button type="button" class="btn btn-outline-danger" id="btnResetProduct" title="Reset product"><i class="bi bi-arrow-counterclockwise"></i></button>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label" for="productVariantId">Variant ID</label>
                                                    <input id="productVariantId" type="text" class="form-control" disabled />
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Capture Product Photo</label>
                                                    <div class="border rounded p-2" id="camBox">
                                                        <div class="ratio ratio-4x3 bg-light rounded position-relative overflow-hidden">
                                                            <video id="camPreview" class="w-100 h-100" autoplay playsinline muted style="display:none;"></video>
                                                            <canvas id="camCanvas" class="w-100 h-100 d-none"></canvas>
                                                            <img id="camSnapshot" class="w-100 h-100 d-none" alt="Snapshot preview"/>
                                                            <div id="camOverlay" class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center text-muted" style="font-size:12px;">
                                                                <span><i class="bi bi-camera-video me-1"></i> Click “Start” to use your camera</span>
                                                            </div>
                                                        </div>
                                                        <div class="d-flex gap-2 mt-2">
                                                            <button type="button" id="btnCamStart" class="btn btn-outline-secondary btn-sm"><i class="bi bi-camera-video"></i> Start</button>
                                                            <button type="button" id="btnCamCapture" class="btn btn-accent btn-sm" disabled><i class="bi bi-camera"></i> Capture</button>
                                                            <button type="button" id="btnCamRetake" class="btn btn-outline-secondary btn-sm d-none"><i class="bi bi-arrow-counterclockwise"></i> Retake</button>
                                                            <button type="button" id="btnCamStop" class="btn btn-outline-danger btn-sm d-none"><i class="bi bi-stop-circle"></i> Stop</button>
                                                        </div>
                                                        <input type="file" accept="image/*" id="camFallback" class="form-control d-none mt-2" />
                                                        <div class="form-text">Rear camera, high-res when available. Requires HTTPS.</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mt-3">
                                                <div class="thumb-grid" id="variantThumbs"></div>
                                                <img id="productImagePreviewVariant" class="mt-2 d-none gm-img" alt="Product" />
                                            </div>

                                            <div class="mt-4 d-grid d-md-flex gap-2">
                                                <button class="btn btn-accent px-4" type="submit"><i class="bi bi-check2-circle me-2"></i>Update</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Stock History -->
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center justify-content-between mb-2">
                                                <h6 class="card-title mb-0"><i class="bi bi-clock-history gm-accent me-2"></i>Stock History</h6>
                                                <span class="chip"><i class="bi bi-filter"></i> latest first</span>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-sm align-middle">
                                                    <thead class="table-light">
                                                    <tr>
                                                        <th>Product ID</th>
                                                        <th>Location</th>
                                                        <th>Quantity</th>
                                                        <th>Updated Date</th>
                                                        <th>Remarks</th>
                                                        <th>Images</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody id="stockHistoryTable"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </form>
                    </div>

                    <!-- ================= Product Labels Pane ================= -->
                    <div class="tab-pane fade" id="productPane" role="tabpanel" aria-labelledby="product-tab">
                        <div class="mb-3">
                            <label for="searchProductLabel" class="form-label">Search Product Name or ID</label>
                            <input type="text" id="searchProductLabel" class="form-control" placeholder="Start typing at least 3 characters..." />
                            <div id="spinnerLabel" class="mt-2" style="display:none;">
                                <div class="spinner-border text-warning spinner-border-sm" role="status"></div>
                                <span class="ms-2 small gm-muted">Searching...</span>
                            </div>
                        </div>
                        <div id="productListLabel" class="list-group mb-3" style="display:none;"></div>

                        <div id="productDetailsLabel" class="row g-4 align-items-start" style="display:none;">
                            <div class="col-12 col-md-4">
                                <img id="productImagePreview" src="" alt="Product Image" class="gm-img d-none"/>
                            </div>
                            <div class="col-12 col-md-8">
                                <div class="row g-2">
                                    <div class="col-6"><span class="gm-muted small">Quantity</span><div class="fw-semibold" id="quantityLabel">—</div></div>
                                    <div class="col-6"><span class="gm-muted small">Shopify Quantity</span><div class="fw-semibold" id="shopifyQuantityLabel">—</div></div>
                                    <div class="col-6"><span class="gm-muted small">Location</span><div class="fw-semibold" id="locationLabel">—</div></div>
                                    <div class="col-6"><span class="gm-muted small">Name</span><div class="fw-semibold" id="nameLabel">—</div></div>
                                    <div class="col-12"><span class="gm-muted small">Product / Variation ID</span><div class="fw-semibold" id="productVariantIdLabel">—</div></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 d-grid d-md-flex gap-2">
                            <button id="generateBarcodeButton" class="btn btn-accent px-4" style="display:none;">
                                <i class="bi bi-printer me-2"></i>Generate Barcode Label
                            </button>
                        </div>
                    </div>

                    <!-- ================= Storage Labels Pane ================= -->
                    <div class="tab-pane fade" id="storagePane" role="tabpanel" aria-labelledby="storage-tab">
                        <div class="row g-3">
                            <div class="col-12 col-md-3">
                                <label class="form-label">Prefix (e.g., Rack / Bin)</label>
                                <input type="text" id="stPrefix" class="form-control" value="Rack" />
                            </div>
                            <div class="col-12 col-md-3">
                                <label class="form-label">Rack / Area</label>
                                <input type="text" id="stRack" class="form-control" placeholder="e.g., 122" />
                            </div>
                            <div class="col-6 col-md-2">
                                <label class="form-label">Start #</label>
                                <input type="number" id="stStart" class="form-control" value="1" min="0" />
                            </div>
                            <div class="col-6 col-md-2">
                                <label class="form-label">Digits</label>
                                <input type="number" id="stDigits" class="form-control" value="3" min="1" />
                            </div>
                            <div class="col-12 col-md-2">
                                <label class="form-label">Labels</label>
                                <input type="number" id="stCount" class="form-control" value="20" min="1" />
                            </div>
                            <div class="col-12">
                                <div class="form-text">Example → <code>Rack 122-001</code>, <code>Rack 122-002</code>, … (QR text matches label text)</div>
                            </div>
                        </div>
                        <div class="mt-3 d-grid d-md-flex gap-2">
                            <button id="btnPreviewStorage" class="btn btn-outline-secondary"><i class="bi bi-eye me-2"></i>Preview first label</button>
                            <button id="btnPrintStorage" class="btn btn-accent"><i class="bi bi-printer me-2"></i>Print Storage Labels</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</main>

<!-- ===== QR Code Modal ===== -->
<div class="modal fade" id="qrcodeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">QR Code Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrcode" class="d-inline-block"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-accent" id="btnPrintQr">Print</button>
            </div>
        </div>
    </div>
</div>

<!-- ===== Scripts ===== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const qrcodeModal = new bootstrap.Modal(document.getElementById('qrcodeModal'));

    // Header actions
    document.getElementById('btnBack').addEventListener('click', () => {
      if (history.length > 1) window.history.back();
      else window.location.href = '/v1/home';
    });
    document.getElementById('btnHome').addEventListener('click', () => window.location.href = '/v1/home');

    (function(){
      const backBtn = document.getElementById('btnBack');
      if (['/','/home'].includes(window.location.pathname)) backBtn.classList.add('d-none');
    })();

    // =========================================
    // Helpers to pick Shopify image (fallbacks included)
    // =========================================
    function isAbsUrl(u){ return /^https?:\/\//i.test(u); }
    function toImageUrl(val){
      if (!val) return '';
      const s = String(val);
      if (isAbsUrl(s) || s.startsWith('/')) return s;
      return `/v1/inventory/images/${s}`;
    }
    function pickProductImage(p){
      const candidates = [];
      if (p){
        if (p.shopifyImageUrl) candidates.push(p.shopifyImageUrl);
        if (p.shopify_image_url) candidates.push(p.shopify_image_url);
        if (p.shopifyImage && typeof p.shopifyImage === 'string') candidates.push(p.shopifyImage);
        if (p.shopifyImage && typeof p.shopifyImage === 'object' && (p.shopifyImage.url||p.shopifyImage.src)) candidates.push(p.shopifyImage.url||p.shopifyImage.src);
        if (Array.isArray(p.shopifyImages) && p.shopifyImages.length){
          const s = p.shopifyImages[0];
          candidates.push((typeof s === 'string') ? s : (s.url || s.src));
        }
        if (p.imageUrl) candidates.push(p.imageUrl);
        if (Array.isArray(p.images) && p.images.length) candidates.push(p.images[0]);
        if (p.stockHistory && Array.isArray(p.stockHistory.images) && p.stockHistory.images.length) candidates.push(p.stockHistory.images[0]);
      }
      const chosen = candidates.find(Boolean);
      return toImageUrl(chosen);
    }

    // =========================================
    // Update Inventory Tab Logic
    // =========================================
    (function initInventory(){
      const barcode = document.getElementById('barcode');
      const devicename = document.getElementById('devicename');
      const empid = document.getElementById('empid');
      const searchInput = document.getElementById('searchProduct');
      const productList = document.getElementById('productList');

      // URL params prefill
      const url = new URL(window.location.href);
      const pBarcode = url.searchParams.get('barcode');
      const pDevice = url.searchParams.get('devicename');
      const pEmp = url.searchParams.get('empId') || url.searchParams.get('empid');
      if (pDevice) { devicename.value = pDevice; }
      if (pEmp) { empid.value = pEmp; }
      if (pBarcode) { searchInput.value = pBarcode; triggerSearch(); }

      // Debounced barcode input
      let barcodeTimer = null;
      barcode.addEventListener('input', () => {
        clearTimeout(barcodeTimer);
        barcodeTimer = setTimeout(() => {
          const code = barcode.value.trim();
          if (code) { enableSpinner(true); searchProductFromAPI(code, true); }
        }, 600);
      });

      // Scan icon (Android bridge safe-guard)
      document.getElementById('btnScan').addEventListener('click', () => {
        try {
          if (window.Android && Android.performAction) Android.performAction();
          else alert('Scanner not available');
        } catch(e) { alert('Scanner not available'); }
      });

      // Inline edit toggles
      document.querySelectorAll('.js-toggle-edit').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.querySelector(btn.dataset.target);
          if (!target) return;
          const disabled = target.hasAttribute('disabled');
          if (disabled) target.removeAttribute('disabled'); else target.setAttribute('disabled','');
          if (!disabled) target.blur(); else target.focus();
        });
      });

      // Search input
      searchInput.addEventListener('input', triggerSearch);
      function triggerSearch(){
        const q = searchInput.value.trim().toLowerCase();
        productList.style.display = q ? 'block' : 'none';
        if (q.length < 3) return;
        enableSpinner(true);
        fetch(`/v1/inventory/search?query=${encodeURIComponent(q)}`)
          .then(r => r.json())
          .then(data => {
            productList.innerHTML = '';
            (data || []).forEach(product => {
              const a = document.createElement('a');
              a.className = 'list-group-item list-group-item-action d-flex align-items-center';
              const imgUrl = pickProductImage(product);
              const thumb = imgUrl
                ? `<img class="list-thumb me-2" src="${escapeAttr(imgUrl)}" alt="Shopify" />`
                : `<span class="list-thumb placeholder me-2"><i class="bi bi-box-seam"></i></span>`;
              const title = `${escapeHtml(product.productTitle)}${product.productVariantTitle ? ' ('+escapeHtml(product.productVariantTitle)+')' : ''}`;
              a.innerHTML = `${thumb}<span>${title}</span>`;
              a.onclick = () => displayProductInfo(product);
              productList.appendChild(a);
            });
          })
          .catch(() => { productList.innerHTML = '<div class="list-group-item text-danger">Error loading results</div>'; })
          .finally(() => enableSpinner(false));
      }

      // ======== Camera Capture (High Quality) ========
      const cam = {
        stream: null,
        blob: null,
        box: document.getElementById('camBox'),
        video: document.getElementById('camPreview'),
        canvas: document.getElementById('camCanvas'),
        snap: document.getElementById('camSnapshot'),
        overlay: document.getElementById('camOverlay'),
        btnStart: document.getElementById('btnCamStart'),
        btnCapture: document.getElementById('btnCamCapture'),
        btnRetake: document.getElementById('btnCamRetake'),
        btnStop: document.getElementById('btnCamStop'),
        fallback: document.getElementById('camFallback')
      };

      async function startCamera(){
        cam.blob = null; window.__gmCapturedBlob = null;
        if (!navigator.mediaDevices?.getUserMedia){
          cam.fallback.classList.remove('d-none');
          alert('Camera not supported by this browser. You can choose a photo instead.');
          Android.openCamera();
          return;
        }
        const constraints = { video: { facingMode:{ ideal:'environment' }, width:{ ideal:1920 }, height:{ ideal:1080 } }, audio:false };
        try{
          cam.stream = await navigator.mediaDevices.getUserMedia(constraints);
          cam.video.srcObject = cam.stream;
          cam.video.style.display = 'block';
          cam.overlay.classList.add('d-none');
          cam.btnCapture.disabled = false;
          cam.btnStop.classList.remove('d-none');
          cam.btnRetake.classList.add('d-none');
          cam.snap.classList.add('d-none');
        }catch(err){
          console.error('getUserMedia error', err);
          cam.fallback.classList.remove('d-none');
          alert('Could not access camera. You can choose a photo instead.');
        }
      }

      function stopCamera(){
        if (cam.stream){ cam.stream.getTracks().forEach(t=>t.stop()); cam.stream = null; }
        cam.video.srcObject = null;
        cam.video.style.display = 'none';
        cam.btnCapture.disabled = true;
        cam.btnStop.classList.add('d-none');
        cam.overlay.classList.remove('d-none');
      }

      async function capturePhoto(){
        if (!cam.stream && cam.video.srcObject==null){ return; }
        const [track] = cam.stream ? cam.stream.getVideoTracks() : [];
        if (window.ImageCapture && track){
          try{
            const ic = new ImageCapture(track);
            const photo = await ic.takePhoto({ imageWidth: 4032, imageHeight: 3024 });
            cam.blob = photo;
          }catch(e){
            console.warn('ImageCapture failed, falling back to canvas', e);
          }
        }
        if (!cam.blob){
          const w = cam.video.videoWidth || 1280;
          const h = cam.video.videoHeight || 720;
          cam.canvas.width = w; cam.canvas.height = h;
          const ctx = cam.canvas.getContext('2d');
          ctx.drawImage(cam.video, 0, 0, w, h);
          cam.blob = await new Promise(res=> cam.canvas.toBlob(res, 'image/jpeg', 0.92));
        }
        if (cam.blob){
          window.__gmCapturedBlob = cam.blob;
          const url = URL.createObjectURL(cam.blob);
          cam.snap.src = url; cam.snap.classList.remove('d-none');
          document.getElementById('productImagePreviewVariant').src = url;
          document.getElementById('productImagePreviewVariant').classList.remove('d-none');
          cam.btnRetake.classList.remove('d-none');
          cam.btnStop.classList.add('d-none');
          cam.btnCapture.disabled = true;
          cam.video.style.display = 'none';
          if (cam.stream){ cam.stream.getTracks().forEach(t=>t.stop()); cam.stream = null; }
          const grid = document.getElementById('variantThumbs');
          const img = document.createElement('img'); img.src = url; img.alt = 'Captured'; grid.prepend(img);
        }
      }

      function retakePhoto(){
        window.__gmCapturedBlob = null; cam.blob = null; cam.snap.classList.add('d-none'); startCamera();
      }

      cam.btnStart.addEventListener('click', startCamera);
      cam.btnStop.addEventListener('click', stopCamera);
      cam.btnCapture.addEventListener('click', capturePhoto);
      cam.btnRetake.addEventListener('click', retakePhoto);

      cam.fallback.addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if (!file) return;
        window.__gmCapturedBlob = file; cam.blob = file;
        const url = URL.createObjectURL(file);
        cam.snap.src = url; cam.snap.classList.remove('d-none');
        document.getElementById('productImagePreviewVariant').src = url;
        document.getElementById('productImagePreviewVariant').classList.remove('d-none');
      });

      // Reset product
      document.getElementById('btnResetProduct').addEventListener('click', () => {
        const pid = document.getElementById('productId').value.trim();
        if (!pid) return alert('No product ID found to reset.');
        if (!confirm('Are you sure you want to reset this product?')) return;
        fetch(`/v1/inventory/resetProduct?productId=${encodeURIComponent(pid)}`, { method:'GET', headers:{'Content-Type':'application/json'} })
          .then(res => res.ok ? alert('Product reset successfully.') : alert('Failed to reset the product.'))
          .catch(() => alert('An error occurred while resetting the product.'));
      });

      // Submit with validation (empId required)
      document.getElementById('invForm').addEventListener('submit', e => {
        e.preventDefault();
        const form = document.getElementById('invForm');
        if (!form.checkValidity()){
          form.classList.add('was-validated');
          alert('Please fill the required fields.');
          return;
        }

        const fd = new FormData();
        fd.append('productId', document.getElementById('productVariantId').value);
        fd.append('location', document.getElementById('location').value);
        fd.append('quantity', document.getElementById('quantity').value);
        fd.append('remarks', document.getElementById('remarks').value);
        fd.append('deviceName', document.getElementById('devicename').value);
        fd.append('empId', document.getElementById('empid').value.trim());
        if (window.__gmCapturedBlob){ fd.append('images', window.__gmCapturedBlob, `gm_${Date.now()}.jpg`); }

        $.ajax({
          url:'/v1/inventory/updateInventory', type:'POST', data:fd, processData:false, contentType:false,
          success: () => alert('Inventory updated successfully'),
          error: () => alert('Error updating inventory')
        });
      });
    })();

    function displayProductInfo(product){
      const list = document.getElementById('productList'); if (list) list.style.display = 'none';
      document.getElementById('location').value = product.storage ?? '';
      document.getElementById('quantity').value = product.quantity ?? '';
      document.getElementById('searchProduct').value = product.productTitle ?? '';
      document.getElementById('currentShopifyStock').value = product.shopifyQuantity ?? '';
      document.getElementById('productVariantId').value = product.productVariantId ?? '';
      document.getElementById('productId').value = product.productId ?? product.productVariantId ?? '';

      const vImg = document.getElementById('productImagePreviewVariant');
      const picked = pickProductImage(product);
      if (picked){ vImg.src = picked; vImg.classList.remove('d-none'); } else { vImg.classList.add('d-none'); }

      const grid = document.getElementById('variantThumbs');
      grid.innerHTML = '';
      if (product?.stockHistory?.images?.length){
        product.stockHistory.images.forEach(id => {
          const img = document.createElement('img');
          img.src = toImageUrl(id);
          img.alt = 'Stock image';
          img.addEventListener('click', () => window.open(toImageUrl(id), '_blank'));
          grid.appendChild(img);
        });
      }

      populateStockHistory(product);
    }

    function populateStockHistory(product){
      const body = document.getElementById('stockHistoryTable');
      body.innerHTML = '';
      const pid = product.productVariantId || product.productId || '';
      const history = product.stockHistory || [];
      history.sort((a,b)=> new Date(b.updatedDate) - new Date(a.updatedDate));
      history.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(pid)}</td>
          <td>${escapeHtml(s.storage||'')}</td>
          <td>${escapeHtml(String(s.quantity??''))}</td>
          <td>${escapeHtml(s.updatedDate||'')}</td>
          <td>${escapeHtml(s.remarks||'')}</td>
          <td>${(s.images||[]).map(id => `<img src="${toImageUrl(id)}" style="width:42px;height:42px;object-fit:cover;border-radius:6px;cursor:pointer;margin-right:6px" onclick="window.open('${toImageUrl(id)}','_blank')"/>`).join('')}</td>`;
        body.appendChild(tr);
      });
    }

    function enableSpinner(show){ const sp = document.getElementById('spinner') || null; if (sp) sp.style.display = show ? 'block' : 'none'; }

    // =========================================
    // Product Labels Logic (separate search inputs)
    // =========================================
    (function initProductLabels(){
      const inp = document.getElementById('searchProductLabel');
      const list = document.getElementById('productListLabel');
      inp.addEventListener('input', function(){
        const q = this.value.trim();
        list.style.display = q ? 'block' : 'none';
        if (q.length < 3) return;
        document.getElementById('spinnerLabel').style.display = 'block';
        fetch(`/v1/inventory/search?query=${encodeURIComponent(q.toLowerCase())}`)
          .then(r=>r.json())
          .then(data=>{
            list.innerHTML = '';
            (data||[]).forEach(p=>{
              const a = document.createElement('a');
              a.className = 'list-group-item list-group-item-action d-flex align-items-center';
              const imgUrl = pickProductImage(p);
              const thumb = imgUrl
                ? `<img class="list-thumb me-2" src="${escapeAttr(imgUrl)}" alt="Shopify" />`
                : `<span class="list-thumb placeholder me-2"><i class="bi bi-box-seam"></i></span>`;
              const title = `${escapeHtml(p.productTitle)}${p.productVariantTitle? ' ('+escapeHtml(p.productVariantTitle)+')':''}`;
              a.innerHTML = `${thumb}<span>${title}</span>`;
              a.onclick = ()=> displayProductInfoLabel(p);
              list.appendChild(a);
            });
          })
          .finally(()=> document.getElementById('spinnerLabel').style.display = 'none');
      });

      document.getElementById('generateBarcodeButton')?.addEventListener('click', function(){
        const countStr = prompt('Enter number of labels (4 per strip):', '4');
        const n = Number(countStr); if (!n || isNaN(n) || n<1) return; generateQRCode(n);
      });
      document.getElementById('btnPrintQr').addEventListener('click', printQRCode);
    })();

    function displayProductInfoLabel(product){
      document.getElementById('productListLabel').style.display = 'none';
      document.getElementById('productDetailsLabel').style.display = 'flex';
      document.getElementById('generateBarcodeButton').style.display = 'inline-flex';

      if (product?.stockHistory?.images?.length) {
        fetchImages(product.stockHistory.images,'productImagePreview');
      }
      const img = document.getElementById('productImagePreview');
      const picked = pickProductImage(product);
      if (picked) { img.src = picked; img.classList.remove('d-none'); } else { img.classList.add('d-none'); }

      document.getElementById('quantityLabel').textContent = product.quantity ?? '—';
      document.getElementById('shopifyQuantityLabel').textContent = product.shopifyQuantity ?? '—';
      document.getElementById('locationLabel').textContent = product.storage ?? '—';
      document.getElementById('nameLabel').textContent = product.productTitle ?? '—';
      document.getElementById('productVariantIdLabel').textContent = product.productVariantId || product.productId || '—';
    }

    // =========================================
    // QR + Printing (shared)
    // =========================================
    function generateQRCode(labelCount){
      const productId = document.getElementById('productVariantIdLabel').textContent.trim();
      let productName = document.getElementById('nameLabel').textContent.trim();
      if (!productId) { alert('Product ID is required to generate QR code.'); return; }
      const cont = document.getElementById('qrcode');
      cont.innerHTML = '';
      new QRCode(cont, { text: productId, width: 128, height: 128 });
      const text = document.createElement('div');
      if (productName.length > 60) productName = productName.substring(0, 60) + '…';
      text.textContent = productName; text.className = 'mt-2'; cont.appendChild(text);
      cont.dataset.labelCount = String(labelCount); cont.dataset.mode = 'product';
      qrcodeModal.show();
    }

    function printQRCode(){
      const cont = document.getElementById('qrcode');
      const mode = cont.dataset.mode || 'product';
      if (mode==='product') return printProductQRCodes();
      if (mode==='storage') return printStorageQRCodes();
    }

    async function printProductQRCodes(){
      const cont = document.getElementById('qrcode');
      const img = cont.querySelector('img');
      const text = cont.querySelector('div');
      const count = Number(cont.dataset.labelCount || '4');
      if (!img || !text) { alert('No QR code or text found to print.'); return; }
      const { jsPDF } = window.jspdf; const pdf = new jsPDF({ orientation:'landscape', unit:'in', format:[4,1] });
      const qr = img.src; const productText = text.textContent || ''; const perRow = 4; const rows = Math.ceil(count / perRow);
      for (let r=0; r<rows; r++){
        const slots = [0.2, 1.3, 2.3, 3.2];
        for (let c=0; c<perRow; c++){
          const idx = r*perRow + c; if (idx >= count) break;
          const x = slots[c]; const y = 0.1; const size = 0.5;
          pdf.addImage(qr, 'PNG', x, y, size, size);
          pdf.setFontSize(5); const maxWidth = 0.7; const wrapped = pdf.splitTextToSize(productText, maxWidth);
          pdf.text(wrapped, x, y + size + 0.1);
        }
        if (r < rows-1) pdf.addPage([4,1], 'landscape');
      }
      const blob = pdf.output('blob'); const url = URL.createObjectURL(blob); window.open(url, '_blank');
    }

    // =========================================
    // Storage Labels logic
    // =========================================
    document.getElementById('btnPreviewStorage').addEventListener('click', () => {
      const firstText = buildStorageText(0); if (!firstText) return;
      previewQr(firstText, 'storage', Number(document.getElementById('stCount').value || 1));
    });
    document.getElementById('btnPrintStorage').addEventListener('click', () => {
      const firstText = buildStorageText(0); if (!firstText) return;
      previewQr(firstText, 'storage', Number(document.getElementById('stCount').value || 1));
    });

    function buildStorageText(offset){
      const prefix = (document.getElementById('stPrefix').value || '').trim();
      const rack = (document.getElementById('stRack').value || '').trim();
      const start = Number(document.getElementById('stStart').value || 0);
      const digits = Math.max(1, Number(document.getElementById('stDigits').value || 1));
      const count = Number(document.getElementById('stCount').value || 1);
      if (!prefix || !rack || count < 1){ alert('Please enter Prefix, Rack/Area and a valid label count.'); return ''; }
      const current = start + offset; const seq = String(current).padStart(digits, '0');
      return `${prefix} ${rack}-${seq}`;
    }

    function previewQr(text, mode, count){
      const cont = document.getElementById('qrcode'); cont.innerHTML = '';
      new QRCode(cont, { text, width: 128, height: 128 });
      const label = document.createElement('div'); label.textContent = text; label.className = 'mt-2'; cont.appendChild(label);
      cont.dataset.mode = mode; cont.dataset.labelCount = String(count); qrcodeModal.show();
    }

    async function printStorageQRCodes(){
      const { jsPDF } = window.jspdf; const count = Number(document.getElementById('qrcode').dataset.labelCount || 1);
      const perRow = 4; const rows = Math.ceil(count / perRow); const pdf = new jsPDF({ orientation:'landscape', unit:'in', format:[4,1] });
      for (let r=0; r<rows; r++){
        const slots = [0.2, 1.3, 2.3, 3.2];
        for (let c=0; c<perRow; c++){
          const idx = r*perRow + c; if (idx >= count) break;
          const text = buildStorageText(idx); const dataUrl = await generateQrDataUrl(text);
          const x = slots[c]; const y = 0.1; const size = 0.5;
          pdf.addImage(dataUrl, 'PNG', x, y, size, size);
          pdf.setFontSize(5); const maxWidth = 0.9; const wrapped = pdf.splitTextToSize(text, maxWidth);
          pdf.text(wrapped, x, y + size + 0.1);
        }
        if (r < rows-1) pdf.addPage([4,1], 'landscape');
      }
      const blob = pdf.output('blob'); const url = URL.createObjectURL(blob); window.open(url, '_blank');
    }

    function generateQrDataUrl(text){
      return new Promise((resolve) => {
        const temp = document.createElement('div'); temp.style.position = 'fixed'; temp.style.left = '-9999px'; document.body.appendChild(temp);
        new QRCode(temp, { text, width:128, height:128 });
        setTimeout(() => { const img = temp.querySelector('img'); const src = img ? img.src : ''; document.body.removeChild(temp); resolve(src); }, 50);
      });
    }

    // Shared utilities
    function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }
    function escapeAttr(str){ return String(str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }

    // Shortcuts
    window.addEventListener('keydown', (e)=>{
      if (e.altKey && e.key === 'ArrowLeft'){ e.preventDefault(); if (history.length > 1) history.back(); else window.location.href = '/v1/home'; }
      if (e.altKey && (e.key.toLowerCase() === 'h')){ e.preventDefault(); window.location.href = '/v1/home'; }
    });
</script>
</body>
</html>
